<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Application Technical Profile</title>
      <!-- Google Fonts: Roboto and Material Symbols -->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
      <!-- Mermaid.js for diagram rendering -->
      <script src="https://cdn.jsdelivr.net/npm/mermaid@11.8.1/dist/mermaid.min.js"></script>
      <script>
         // Simple immediate check for Mermaid availability
         window.addEventListener('load', function() {
            if (typeof mermaid === 'undefined') {
               console.error('Mermaid library failed to load');
            } else {
               console.log('Mermaid library loaded successfully', mermaid.version || 'version unknown');
            }
         });
      </script>
      
      <!-- Critical stylesheet for Material Icons -->
      <style id="material-icons-critical">
         /* Ensure proper icon rendering and prevent emoji conversion */
         .material-symbols-outlined,
         .icon,
         [class*="icon"] {
            font-family: 'Material Symbols Outlined', sans-serif !important;
            font-weight: normal !important;
            font-style: normal !important;
            line-height: 1 !important;
            text-transform: none !important;
            letter-spacing: normal !important;
            word-wrap: normal !important;
            white-space: nowrap !important;
            direction: ltr !important;
            font-feature-settings: 'liga' !important;
            -webkit-font-feature-settings: 'liga' !important;
            -webkit-font-smoothing: antialiased !important;
            font-variant-emoji: text !important;
            text-rendering: optimizeLegibility !important;
            font-size: 20px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
         }
         
         /* Specifically target table content icons that might get corrupted during pagination */
         tbody .material-symbols-outlined,
         tbody .icon,
         tbody td .material-symbols-outlined,
         tbody td .icon {
            font-family: 'Material Symbols Outlined', sans-serif !important;
            font-variant-emoji: text !important;
            text-rendering: optimizeLegibility !important;
         }
         
         /* Specifically target pagination icons */
         .pagination-button .material-symbols-outlined,
         .pagination-button .icon {
            font-family: 'Material Symbols Outlined', sans-serif !important;
            font-variant-emoji: text !important;
            font-size: 20px !important;
         }
      </style>
      
      <!-- Table styling and pagination styles -->
      <style>
         /* Common styles */
         * {
            box-sizing: border-box;
         }
         
         body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.5;
            color: #333;
            margin: 0;
            padding: 0;
         }
         
         /* Table container */
         .table-container {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 2rem;
         }
         
         /* Table pagination styles */
         .table-pagination {
            margin-top: 12px;
         }
         
         .pagination-top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
         }
         
         .page-size-selector {
            display: flex;
            align-items: center;
         }
         
         .page-size-label {
            margin-right: 8px;
            font-size: 14px;
            color: #555;
            padding-left: 4px;
         }
         
         .page-size-select {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            min-width: 60px;
         }
         
         .pagination-info {
            font-size: 14px;
            color: #555;
            padding: 4px 0;
            padding-right: 4px;
            text-align: right;
         }
         
         .pagination-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 8px;
         }
         
         .pagination-nav-buttons,
         .pagination-next-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
         }
         
         .pagination-page-numbers {
            display: flex;
            align-items: center;
            margin: 0 10px;
         }
         
         /* Pagination buttons */
         .pagination-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
            padding: 4px 8px;
            margin: 0 3px;
            border: none;
            border-radius: 50%;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s ease;
            box-shadow: none;
            color: #5f6368;
            user-select: none;
            outline: none;
         }
         
         .pagination-button:hover:not(:disabled) {
            background-color: rgba(0, 0, 0, 0.04);
         }
         
         .pagination-button:disabled {
            opacity: 0.5;
            cursor: default;
            color: #bdc1c6;
            background: transparent;
         }
         
         .pagination-button.active {
            background-color: #0071ce;
            color: white;
            font-weight: 500;
         }
         
         .pagination-button.ellipsis {
            color: #5f6368;
            pointer-events: none;
         }
         
         /* Table grouping styles */
         .table-group-controls {
            margin-bottom: 16px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            transition: background-color 0.2s ease, border-color 0.2s ease;
         }
         
         .group-title {
            margin-right: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            color: #333;
            transition: color 0.2s ease;
         }
         
         .group-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
         }
         
         .group-option {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
         }
         
         .group-option:hover:not(.active) {
            background-color: #f0f0f0;
         }
         
         .group-option.active {
            background-color: #0071ce;
            color: #fff;
            border: 1px solid #0071ce;
            font-weight: 500;
         }
         
         .group-header {
            background-color: #f5f7f9;
            transition: background-color 0.2s ease;
         }
         
         .group-header td {
            padding: 0 !important;
         }
         
         .group-header-content {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #f5f7f9;
            border-radius: 4px;
            transition: background-color 0.2s ease;
         }
         
         .group-toggle {
            margin-right: 8px;
            color: #0071ce;
            transition: color 0.2s ease;
         }
         
         .group-header-title {
            font-weight: 500;
            color: #333;
            transition: color 0.2s ease;
         }
         
         .group-count {
            margin-left: 12px;
            font-size: 0.85em;
            color: #666;
            background-color: rgba(0, 113, 206, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
            transition: all 0.2s ease;
         }
         
         .collapsed-row {
            display: none !important;
         }
         
         tr.first-in-group td {
            border-top: 1px solid #e0e0e0;
            transition: border-color 0.2s ease;
         }
         
         .group-header:hover {
            background-color: #eef1f5;
         }
         
         .group-tooltip {
            font-size: 0.75em;
            color: #666;
            margin-left: 8px;
            padding: 2px 6px;
            background: rgba(0, 113, 206, 0.08);
            border-radius: 4px;
            transition: all 0.2s ease;
         }

         /* Dark mode styles for table grouping */
         @media (prefers-color-scheme: dark) {
            body {
               background-color: #1a202c !important;
               color: #e2e8f0 !important;
            }
            
            .table-group-controls {
               background-color: #2d3748 !important;
               border: 1px solid #4a5568 !important;
               box-shadow: none !important;
            }
            
            .group-title {
               color: #cbd5e0 !important;
            }
            
            .group-option {
               background-color: #4a5568 !important;
               border: 1px solid #718096 !important;
               color: #e2e8f0 !important;
               box-shadow: none !important;
            }
            
            .group-option:hover:not(.active) {
               background-color: #718096 !important;
               border-color: #a0aec0 !important;
            }
            
            .group-option.active {
               background-color: #3182ce !important;
               color: #ffffff !important;
               border: 1px solid #3182ce !important;
               box-shadow: none !important;
            }
            
            .group-header {
               background-color: #2d3748 !important;
            }
            
            .group-header-content {
               background-color: #2d3748 !important;
            }
            
            .group-toggle {
               color: #4299e1 !important;
            }
            
            .group-header-title {
               color: #e2e8f0 !important;
            }
            
            .group-count {
               color: #cbd5e0 !important;
               background-color: rgba(66, 153, 225, 0.2) !important;
               border: none !important;
            }
            
            tr.first-in-group td {
               border-top: 1px solid #4a5568 !important;
            }
            
            .group-header:hover {
               background-color: #4a5568 !important;
            }
            
            .group-header:hover .group-header-content {
               background-color: #4a5568 !important;
            }
            
            .group-tooltip {
               color: #cbd5e0 !important;
               background: rgba(66, 153, 225, 0.15) !important;
               border: none !important;
            }
         }

         /* Force dark mode styles - Alternative approach */
         .dark-mode body,
         [data-theme="dark"] body {
            background-color: var(--background-main) !important;
            color: var(--text-primary) !important;
         }

         .dark-mode .footer-wordmark{
            color: var(--text-primary) !important;
         }

         .dark-mode .tab-link
         {
            color: var(--text-primary) !important;
            text-decoration: none !important;
            font-weight: 500 !important;
            transition: color 0.2s ease;
         }
         
         .dark-mode .table-group-controls,
         [data-theme="dark"] .table-group-controls {
            background-color: var(--background-main) !important;
            border: 1px solid var(--border-color) !important;
            box-shadow: none !important;
         }
         
         .dark-mode .group-title,
         [data-theme="dark"] .group-title {
            color: var(--text-primary) !important;
         }
         
         .dark-mode .group-option,
         [data-theme="dark"] .group-option {
            background-color: var(--border-color) !important;
            border: none !important;
            color: var(--text-primary) !important;
            box-shadow: none !important;
         }
         
         .dark-mode .group-option:hover:not(.active),
         [data-theme="dark"] .group-option:hover:not(.active) {
            background-color: var(--background-button) !important;
            border-color: none !important;
         }
         
         .dark-mode .group-option.active,
         [data-theme="dark"] .group-option.active {
            background-color: var(--product-accent) !important;
            color: var(--text-primary) !important;
            border: none !important;
            box-shadow: none !important;
         }

         .dark-mode .group-header-content{
            background-color: var(--background-main) !important;
         }

         .dark-mode .group-header-title
         {
            color: var(--text-primary) !important;
         }

         .dark-mode .group-tooltip{
            color: var(--text-primary) !important;
            background-color: var(--border-color) !important;
            border: none !important;
         }

         .dark-mode .group-count{
            background-color: rgba(0, 113, 206, 0.1) !important;
            border: none !important;
            color: rgb(0, 113, 206) !important;
         }

         .dark-mode .floating-toc-link:hover{
            background-color: var(--product-accent) !important;
         }


         .dark-mode .pagination-nav{
            background-color: var(--background-main) !important;          
            border: 1px solid var(--border-color) !important;
            box-shadow: none !important;
         }

         .dark-mode .pagination-button.page-number {
            color: var(--text-primary) !important;
         }

         .dark-mode .pagination-button.page-number.active {
            background-color: var(--product-accent) !important;
            color: var(--text-primary) !important;
            border: none !important;
            box-shadow: none !important;
         }

         .dark-mode .pagination-button.page-number:hover:not(.active) {
            background-color: var(--product-accent) !important;
            border-color: none !important;
            color: var(--text-primary) !important;
         }

         .dark-mode .pagination-button.next, .dark-mode .pagination-button.prev, .dark-mode .pagination-button.first, .dark-mode .pagination-button.last {
            background-color: var(--background-main) !important;
            border-color: none !important;
            color: var(--text-primary) !important;
         }

         /* Enhanced light mode styles for better contrast */
         @media (prefers-color-scheme: light) {
            .table-group-controls {
               background-color: #ffffff;
               border: 1px solid #e2e8f0;
               box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            
            .group-option {
               background-color: #f8f9fa;
               border: 1px solid #d1d5db;
               color: #374151;
               box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            }
            
            .group-option:hover:not(.active) {
               background-color: #e5e7eb;
               border-color: #9ca3af;
            }
            
            .group-option.active {
               background-color: #0071ce;
               color: #ffffff;
               border: 1px solid #0071ce;
               box-shadow: 0 2px 4px rgba(0, 113, 206, 0.2);
            }
            
            .group-count {
               background-color: rgba(0, 113, 206, 0.1);
               border: 1px solid rgba(0, 113, 206, 0.2);
            }
            
            .group-tooltip {
               background: rgba(0, 113, 206, 0.08);
               border: 1px solid rgba(0, 113, 206, 0.15);
            }
         }

         /* MERMAID DIAGRAM THEMING */
         .mermaid-container {
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
            text-align: center;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            
            /* Use CSS variables for consistent theming */
            background-color: var(--background-main);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
         }

         .mermaid-container svg {
            max-width: 100%;
            height: auto;
            background-color: transparent !important;
         }

         /* Global font styling for all Mermaid diagrams */
         .mermaid-container svg text,
         .mermaid-container svg tspan,
         .mermaid-container svg .nodeLabel,
         .mermaid-container svg .edgeLabel,
         .mermaid-container svg .label,
         .mermaid-container svg .titleText {
            font-family: 'Roboto', 'Segoe UI', Arial, sans-serif !important;
            font-size: 14px !important;
         }

         /* Ensure text visibility in dark mode Mermaid diagrams */
         .dark-mode .mermaid-container svg text,
         [data-theme="dark"] .mermaid-container svg text {
            fill: var(--text-primary) !important;
         }

         .dark-mode .mermaid-container svg .node rect,
         [data-theme="dark"] .mermaid-container svg .node rect {
            stroke: var(--border-color) !important;
         }

         .dark-mode .mermaid-container svg .edgePath path,
         [data-theme="dark"] .mermaid-container svg .edgePath path {
            stroke: var(--border-color) !important;
         }

         /* Light mode Mermaid container */
         @media (prefers-color-scheme: light) {
            .mermaid-container {
               box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
         }

         /* Dark mode Mermaid container */
         @media (prefers-color-scheme: dark) {
            .mermaid-container {
               box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            }
         }

         /* Force dark mode Mermaid styling */
         .dark-mode .mermaid-container,
         [data-theme="dark"] .mermaid-container {
            background-color: var(--background-main) !important;
            border: 1px solid var(--border-color) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5) !important;
         }

         /* Force light mode Mermaid styling */
         .light-mode .mermaid-container,
         [data-theme="light"] .mermaid-container {
            background-color: var(--background-main) !important;
            border: 1px solid var(--border-color) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
         }

         /* GOOGLE-LIKE LOADING INDICATOR */
         .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(2px);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
         }

         .loading-overlay.show {
            opacity: 1;
            visibility: visible;
         }

         .loading-dots {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
         }

         .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--background-button);
            margin: 0 3px;
            animation: pulse 1.5s ease-in-out infinite;
         }

         .loading-dot:nth-child(1) { animation-delay: 0s; }
         .loading-dot:nth-child(2) { animation-delay: 0.2s; }
         .loading-dot:nth-child(3) { animation-delay: 0.4s; }
         .loading-dot:nth-child(4) { animation-delay: 0.6s; }

         .loading-text {
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 8px;
            text-align: center;
         }

         .loading-progress {
            width: 200px;
            height: 4px;
            background-color: #e8eaed;
            border-radius: 2px;
            overflow: hidden;
            position: relative;
         }

         .loading-progress-bar {
            height: 100%;
            background-color:var(--background-button);
            border-radius: 2px;
            position: absolute;
            left: -100%;
            animation: progress 2s ease-in-out infinite;
         }

         /* Dark mode loading overlay */
         .dark-mode .loading-overlay,
         [data-theme="dark"] .loading-overlay {
            background-color: var(--background-main);
         }

         .dark-mode .loading-dot,
         [data-theme="dark"] .loading-dot {
            background-color: var(--background-button);
         }

         .dark-mode .loading-text,
         [data-theme="dark"] .loading-text {
            color: var(--text-primary);
         }

         .dark-mode .loading-progress,
         [data-theme="dark"] .loading-progress {
            background-color: var(--background-main);
         }

         .dark-mode .loading-progress-bar,
         [data-theme="dark"] .loading-progress-bar {
            background-color: var(--background-button);
         }

         /* Animations */
         @keyframes pulse {
            0%, 20% { 
               transform: scale(1); 
               opacity: 1; 
            }
            50% { 
               transform: scale(1.3); 
               opacity: 0.7; 
            }
            80%, 100% { 
               transform: scale(1); 
               opacity: 1; 
            }
         }

         @keyframes progress {
            0% {
               left: -100%;
               width: 0%;
            }
            50% {
               left: 0%;
               width: 100%;
            }
            100% {
               left: 100%;
               width: 0%;
            }
         }

         /* Loading indicator for specific sections */
         .section-loading {
            position: relative;
         }

         .section-loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(1px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
         }

         .dark-mode .section-loading::after,
         [data-theme="dark"] .section-loading::after {
            background-color: rgba(26, 32, 44, 0.8);
         }
      </style>
     
      <!-- Table sorting and grouping functionality -->
      <script>
         // --- MERMAID DIAGRAM RENDERING ---
         
         // Loading indicator management
         let loadingTasks = new Set();
         
         function showLoading(message = 'Loading...', taskId = 'default') {
             const overlay = document.getElementById('loadingOverlay');
             const loadingText = document.getElementById('loadingText');
             
             if (overlay && loadingText) {
                 loadingTasks.add(taskId);
                 loadingText.textContent = message;
                 overlay.classList.add('show');
                 console.log(`Loading started: ${message} (task: ${taskId})`);
             }
         }
         
         function hideLoading(taskId = 'default') {
             loadingTasks.delete(taskId);
             console.log(`Loading task completed: ${taskId}, ${loadingTasks.size} tasks remaining`);
             
             // Only hide if no other tasks are running
             if (loadingTasks.size === 0) {
                 const overlay = document.getElementById('loadingOverlay');
                 if (overlay) {
                     // Add a small delay to prevent flicker for quick operations
                     setTimeout(() => {
                         // Double-check that no new tasks were added during the delay
                         if (loadingTasks.size === 0) {
                             overlay.classList.remove('show');
                             console.log(`All loading tasks completed - hiding overlay`);
                         }
                     }, 100); // Reduced delay from 300ms to 100ms
                 }
             }
         }
         
         function updateLoadingMessage(message, taskId = 'default') {
             if (loadingTasks.has(taskId)) {
                 const loadingText = document.getElementById('loadingText');
                 if (loadingText) {
                     loadingText.textContent = message;
                 }
             }
         }

         function initializeMermaidRendering() {
             showLoading('Initializing diagram renderer...', 'mermaid-init');
             
             try {
                 // Detect current theme
                 const isDarkMode = document.documentElement.classList.contains('dark-mode') || 
                                   document.documentElement.getAttribute('data-theme') === 'dark' ||
                                   window.matchMedia('(prefers-color-scheme: dark)').matches;
                 
                 // Get theme-specific configuration
                 const themeConfig = getMermaidThemeConfig(isDarkMode);
                 
                 updateLoadingMessage('Configuring diagram themes...', 'mermaid-init');
                 
                 // Configure Mermaid with comprehensive theme settings
                 mermaid.initialize({
                     startOnLoad: false, // Important! We manually control the rendering
                     securityLevel: 'loose', // Allow all diagram features
                     htmlLabels: true, // Enable HTML labels for better text rendering
                     theme: themeConfig.theme,
                     themeVariables: themeConfig.themeVariables,
                     flowchart: {
                         useMaxWidth: true,
                         htmlLabels: true,
                         curve: 'basis'
                     },
                     sequence: {
                         useMaxWidth: true,
                         wrap: true
                     },
                     class: {
                         useMaxWidth: true
                     },
                     state: {
                         useMaxWidth: true
                     },
                     er: {
                         useMaxWidth: true
                     },
                     journey: {
                         useMaxWidth: true
                     },
                     gantt: {
                         useMaxWidth: true
                     },
                     pie: {
                         useMaxWidth: true
                     },
                     // Simplified configuration - remove complex settings that might cause issues
                     logLevel: 'error',
                     suppressErrorRendering: false
                 });
                 console.log(`Mermaid initialized successfully with ${isDarkMode ? 'dark' : 'light'} theme`);
                 hideLoading('mermaid-init');
             } catch (error) {
                 console.error('Error initializing Mermaid:', error);
                 hideLoading('mermaid-init');
             }
         }

         // Get comprehensive theme configuration for Mermaid
         function getMermaidThemeConfig(isDarkMode) {
             // Get CSS variables from the document
             const rootStyles = getComputedStyle(document.documentElement);
             const backgroundMain = rootStyles.getPropertyValue('--background-main').trim();
             const textPrimary = rootStyles.getPropertyValue('--text-primary').trim();
             const textSecondary = rootStyles.getPropertyValue('--text-secondary').trim();
             const borderColor = rootStyles.getPropertyValue('--border-color').trim();
             const backgroundCard = rootStyles.getPropertyValue('--background-card').trim();
             const backgroundHover = rootStyles.getPropertyValue('--background-hover').trim();
             const productAccent = rootStyles.getPropertyValue('--product-accent').trim();
             
             if (isDarkMode) {
                 return {
                     theme: 'dark',
                     themeVariables: {
                         // Core theme colors using CSS variables
                         darkMode: true,
                         background: backgroundMain,
                         primaryColor: productAccent, // Use the accent color for primary elements
                         primaryTextColor: textPrimary,
                         primaryBorderColor: borderColor,
                         lineColor: borderColor,
                         
                         // Font configuration
                         fontFamily: "'Roboto', 'Segoe UI', Arial, sans-serif",
                         fontSize: '14px',
                         
                         // Secondary colors
                         secondaryColor: backgroundCard,
                         tertiaryColor: backgroundHover,
                         
                         // Text colors - all using CSS variables
                         textColor: textPrimary,
                         darkTextColor: textPrimary,
                         mainBkg: backgroundCard,
                         secondBkg: backgroundHover,
                         tertiaryBkg: backgroundMain,
                         
                         // Node and connector styling
                         nodeBkg: backgroundCard,
                         nodeBorder: borderColor,
                         clusterBkg: backgroundMain,
                         clusterBorder: borderColor,
                         defaultLinkColor: productAccent,
                         titleColor: textPrimary,
                         edgeLabelBackground: backgroundMain,
                         
                         // Specific diagram type colors
                         actorBorder: borderColor,
                         actorBkg: backgroundCard,
                         actorTextColor: textPrimary,
                         actorLineColor: borderColor,
                         signalColor: textPrimary,
                         signalTextColor: textPrimary,
                         
                         // Flowchart colors - readable and distinguishable
                         fillType0: '#4285f4', // Blue - good contrast in dark mode
                         fillType1: '#81c995', // Light green
                         fillType2: '#fdd663', // Yellow
                         fillType3: '#f28b82', // Light red
                         fillType4: '#ce93d8', // Light purple
                         fillType5: '#ffab91', // Light orange
                         fillType6: '#80deea', // Light cyan
                         fillType7: '#a5d6a7', // Another green shade
                         
                         // Class diagram colors
                         classText: textPrimary,
                         
                         // State diagram colors
                         labelColor: textPrimary,
                         altBackground: backgroundCard,
                         
                         // ER diagram colors
                         entityBkg: backgroundCard,
                         entityTextColor: textPrimary,
                         relationLabelColor: textPrimary,
                         
                         // Journey diagram colors
                         taskBkgColor: backgroundCard,
                         taskTextColor: textPrimary,
                         activeTaskBkgColor: productAccent,
                         activeTaskBorderColor: borderColor,
                         gridColor: borderColor,
                         section0: '#4285f4',
                         section1: '#81c995',
                         section2: '#fdd663',
                         section3: '#f28b82'
                     }
                 };
             } else {
                 return {
                     theme: 'default',
                     themeVariables: {
                         // Core theme colors using CSS variables
                         background: backgroundMain,
                         primaryColor: productAccent,
                         primaryTextColor: textPrimary,
                         primaryBorderColor: borderColor,
                         lineColor: borderColor,
                         
                         // Font configuration
                         fontFamily: "'Roboto', 'Segoe UI', Arial, sans-serif",
                         fontSize: '14px',
                         
                         // Secondary colors
                         secondaryColor: backgroundCard,
                         tertiaryColor: backgroundHover,
                         
                         // Text colors - all using CSS variables
                         textColor: textPrimary,
                         darkTextColor: textPrimary,
                         mainBkg: backgroundCard,
                         secondBkg: backgroundHover,
                         tertiaryBkg: backgroundMain,
                         
                         // Node and connector styling
                         nodeBkg: backgroundCard,
                         nodeBorder: borderColor,
                         clusterBkg: backgroundMain,
                         clusterBorder: borderColor,
                         defaultLinkColor: productAccent,
                         titleColor: textPrimary,
                         edgeLabelBackground: backgroundMain,
                         
                         // Specific diagram type colors
                         actorBorder: borderColor,
                         actorBkg: backgroundCard,
                         actorTextColor: textPrimary,
                         actorLineColor: borderColor,
                         signalColor: textPrimary,
                         signalTextColor: textPrimary,
                         
                         // Flowchart colors - readable in light mode
                         fillType0: '#0071ce', // Primary blue
                         fillType1: '#1e8e3e', // Green
                         fillType2: '#f9ab00', // Amber/Yellow
                         fillType3: '#d93025', // Red
                         fillType4: '#9c27b0', // Purple
                         fillType5: '#ff5722', // Deep orange
                         fillType6: '#00acc1', // Cyan
                         fillType7: '#689f38', // Light green
                         
                         // Class diagram colors
                         classText: textPrimary,
                         
                         // State diagram colors
                         labelColor: textPrimary,
                         altBackground: backgroundCard,
                         
                         // ER diagram colors
                         entityBkg: backgroundCard,
                         entityTextColor: textPrimary,
                         relationLabelColor: textPrimary,
                         
                         // Journey diagram colors
                         taskBkgColor: backgroundCard,
                         taskTextColor: textPrimary,
                         activeTaskBkgColor: productAccent,
                         activeTaskBorderColor: borderColor,
                         gridColor: borderColor,
                         section0: '#0071ce',
                         section1: '#1e8e3e',
                         section2: '#f9ab00',
                         section3: '#d93025'
                     }
                 };
             }
         }

         function renderMermaidDiagrams() {
             // Find all mermaid code blocks - be more specific in the selector
             const mermaidBlocks = document.querySelectorAll('pre.mermaid');
             
             if (mermaidBlocks.length === 0) {
                 console.log('No Mermaid diagrams found to render');
                 return;
             }
             
             showLoading(`Preparing ${mermaidBlocks.length} diagram${mermaidBlocks.length > 1 ? 's' : ''}...`, 'mermaid-render');
             console.log(`Found ${mermaidBlocks.length} Mermaid diagrams to render`);
             
             let processedCount = 0;
             let successCount = 0;
             let errorCount = 0;
             
             const updateProgress = () => {
                 processedCount++;
                 updateLoadingMessage(
                     `Rendering diagrams... ${processedCount}/${mermaidBlocks.length} (${successCount} successful, ${errorCount} errors)`,
                     'mermaid-render'
                 );
                 
                 // Hide loading when all diagrams are processed
                 if (processedCount >= mermaidBlocks.length) {
                     clearTimeout(maxTimeout); // Clear the fallback timeout
                     setTimeout(() => {
                         hideLoading('mermaid-render');
                     }, 200); // Small delay to show completion message
                 }
             };
             
             // Set a maximum timeout to ensure loading doesn't hang indefinitely
             const maxTimeout = setTimeout(() => {
                 console.warn('Forcing loading to complete after maximum timeout');
                 hideLoading('mermaid-render');
             }, 30000); // 30 second maximum timeout
             
             mermaidBlocks.forEach((preBlock, index) => {
                 try {
                     // Skip if already processed
                     if (preBlock.classList.contains('mermaid-processed')) {
                         console.log(`Skipping diagram ${index + 1} - already processed`);
                         updateProgress(); // Still count this as processed
                         return;
                     }
                     
                     // Check if there's already a rendered container
                     const existingContainer = preBlock.nextElementSibling?.classList.contains('mermaid-container') ||
                                             preBlock.previousElementSibling?.classList.contains('mermaid-container');
                     if (existingContainer) {
                         console.log(`Skipping diagram ${index + 1} - container already exists`);
                         updateProgress(); // Still count this as processed
                         return;
                     }
                     
                     // Get the code element inside the pre block
                     const codeElement = preBlock.querySelector('code');
                     if (!codeElement) {
                         console.warn(`No code element found in mermaid block ${index + 1}`);
                         errorCount++;
                         updateProgress();
                         return;
                     }
                     
                     // Get the mermaid code content from the code element
                     let mermaidCode = codeElement.textContent || codeElement.innerText;
                     
                     // Skip if empty
                     if (!mermaidCode.trim()) {
                         console.warn(`Empty mermaid code in block ${index + 1}`);
                         errorCount++;
                         updateProgress();
                         return;
                     }
                     
                     // Clean up the code
                     mermaidCode = mermaidCode.trim();
                     
                     // Debug: Log the first few lines of the code to verify content
                     const firstLines = mermaidCode.split('\n').slice(0, 3).join('\n');
                     console.log(`Diagram ${index + 1} content preview:`, firstLines);
                     
                     // Validate this is actually Mermaid syntax, not CSS or other content
                     if (mermaidCode.includes('font-family:') || mermaidCode.includes('keyframes') || mermaidCode.includes('.mermaid-')) {
                         console.error(`Block ${index + 1} contains CSS instead of Mermaid syntax, skipping`);
                         errorCount++;
                         updateProgress();
                         return;
                     }
                     
                     // Validate and fix common syntax issues
                     mermaidCode = validateAndFixMermaidSyntax(mermaidCode);
                     
                     // Detect diagram type for specific handling
                     const diagramType = detectDiagramType(mermaidCode);
                     console.log(`Rendering ${diagramType} diagram ${index + 1}`);
                     
                     // Create a unique ID for this diagram
                     const diagramId = `mermaid-diagram-${index}-${Date.now()}`;
                     
                     // Create container for the rendered diagram with enhanced styling
                     const container = document.createElement('div');
                     container.id = diagramId;
                     container.className = 'mermaid-container';
                     
                     // Apply CSS variable-based styling that adapts to theme
                     const isDarkMode = document.documentElement.classList.contains('dark-mode') || 
                                       document.documentElement.getAttribute('data-theme') === 'dark' ||
                                       window.matchMedia('(prefers-color-scheme: dark)').matches;
                     
                     // Use CSS variables for consistent theming
                     container.style.cssText = `
                         text-align: center;
                         margin: 20px 0;
                         padding: 20px;
                         border: 1px solid var(--border-color);
                         border-radius: 8px;
                         background-color: var(--background-main);
                         box-shadow: ${isDarkMode ? '0 2px 8px rgba(0, 0, 0, 0.5)' : '0 2px 4px rgba(0, 0, 0, 0.1)'};
                         overflow-x: auto;
                         transition: background-color 0.3s ease, border-color 0.3s ease;
                     `;
                     
                     // Insert the container after the pre block
                     preBlock.parentNode.insertBefore(container, preBlock.nextSibling);
                     preBlock.style.display = 'none'; // Hide original but keep for reference
                     
                     // Add timeout to prevent hanging
                     const renderTimeout = setTimeout(() => {
                         console.error(`Rendering timeout for ${diagramType} diagram ${index + 1}`);
                         container.innerHTML = `
                             <div style="color: #ff6b35; padding: 20px; text-align: center;">
                                 <strong>Rendering timeout for ${diagramType} diagram</strong><br>
                                 <small>The diagram took too long to render</small>
                             </div>
                         `;
                         errorCount++;
                         updateProgress();
                     }, 10000); // 10 second timeout
                     
                     // Render the diagram
                     mermaid.render(diagramId + '-svg', mermaidCode)
                         .then(({ svg, bindFunctions }) => {
                             clearTimeout(renderTimeout);
                             container.innerHTML = svg;
                             
                             // Apply bind functions if they exist (for interactive elements)
                             if (bindFunctions) {
                                 try {
                                     bindFunctions(container);
                                 } catch (bindError) {
                                     console.warn('Error applying bind functions:', bindError);
                                 }
                             }
                             
                             // Mark as processed
                             preBlock.classList.add('mermaid-processed');
                             
                             // Add diagram type as data attribute
                             container.setAttribute('data-diagram-type', diagramType);
                             
                             console.log(`Successfully rendered ${diagramType} diagram ${index + 1}`);
                             successCount++;
                             updateProgress();
                         })
                         .catch(error => {
                             clearTimeout(renderTimeout);
                             console.error(`Error rendering ${diagramType} diagram ${index + 1}:`, error);
                             
                             // Show detailed error information
                             const errorDetails = error.message || 'Unknown error occurred';
                             const codePreview = mermaidCode.length > 200 ? 
                                 mermaidCode.substring(0, 200) + '...' : 
                                 mermaidCode;
                             
                             container.innerHTML = `
                                 <div style="color: #d32f2f; padding: 20px; text-align: center; border: 1px solid #d32f2f; border-radius: 4px; background-color: #ffebee;">
                                     <strong>Error rendering ${diagramType} diagram:</strong><br>
                                     <small>${errorDetails}</small><br>
                                     <details style="margin-top: 10px;">
                                         <summary>Show diagram code</summary>
                                         <pre style="text-align: left; background: #f5f5f5; padding: 10px; margin-top: 10px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word;">${codePreview}</pre>
                                     </details>
                                 </div>
                             `;
                             errorCount++;
                             updateProgress();
                         });
                         
                 } catch (error) {
                     console.error(`Error processing Mermaid block ${index + 1}:`, error);
                     errorCount++;
                     updateProgress();
                 }
             });
             
             // Fallback: if no diagrams were found or processed, hide loading immediately
             if (mermaidBlocks.length === 0) {
                 console.log('No Mermaid diagrams found');
                 clearTimeout(maxTimeout);
                 hideLoading('mermaid-render');
             }
         }

         function detectDiagramType(code) {
             const trimmedCode = code.trim().toLowerCase();
             
             if (trimmedCode.startsWith('graph') || trimmedCode.startsWith('flowchart')) return 'flowchart';
             if (trimmedCode.startsWith('sequencediagram')) return 'sequence';
             if (trimmedCode.startsWith('classdiagram')) return 'class';
             if (trimmedCode.startsWith('statediagram')) return 'state';
             if (trimmedCode.startsWith('erdiagram')) return 'er';
             if (trimmedCode.startsWith('journey')) return 'user-journey';
             if (trimmedCode.startsWith('gantt')) return 'gantt';
             if (trimmedCode.startsWith('pie')) return 'pie';
             if (trimmedCode.startsWith('gitgraph')) return 'gitgraph';
             if (trimmedCode.startsWith('mindmap')) return 'mindmap';
             if (trimmedCode.startsWith('timeline')) return 'timeline';
             if (trimmedCode.startsWith('quadrantchart')) return 'quadrant';
             if (trimmedCode.startsWith('xychart')) return 'xy';
             if (trimmedCode.startsWith('block')) return 'block';
             if (trimmedCode.startsWith('packet')) return 'packet';
             if (trimmedCode.startsWith('tree')) return 'tree';
             
             return 'unknown';
         }

         function validateAndFixMermaidSyntax(code) {
             let fixedCode = code.trim();
             
             // Remove any HTML entities that might cause issues
             fixedCode = fixedCode
                 .replace(/&amp;/g, '&')
                 .replace(/&lt;/g, '<')
                 .replace(/&gt;/g, '>')
                 .replace(/&#39;/g, "'")
                 .replace(/&quot;/g, '"');
             
             return fixedCode;
         }

         // Update Mermaid theme (used for theme switching)
         function updateMermaidTheme() {
             showLoading('Updating diagram themes...', 'theme-update');
             
             try {
                 // Re-initialize Mermaid with new theme
                 initializeMermaidRendering();
                 
                 // Re-render all diagrams
                 const processedDiagrams = document.querySelectorAll('.mermaid-processed');
                 if (processedDiagrams.length > 0) {
                     updateLoadingMessage('Re-rendering diagrams with new theme...', 'theme-update');
                     
                     // Reset processed state
                     processedDiagrams.forEach(diagram => {
                         diagram.classList.remove('mermaid-processed');
                     });
                     
                     // Remove existing rendered containers
                     const containers = document.querySelectorAll('.mermaid-container');
                     containers.forEach(container => container.remove());
                     
                     // Show original code blocks
                     const hiddenBlocks = document.querySelectorAll('pre.mermaid[style*="display: none"]');
                     hiddenBlocks.forEach(block => {
                         block.style.display = '';
                     });
                     
                     // Re-render
                     renderMermaidDiagrams();
                 }
                 
                 hideLoading('theme-update');
             } catch (error) {
                 console.error('Error updating Mermaid theme:', error);
                 hideLoading('theme-update');
             }
         }
      </script>
   </head>
   <body>
      <!-- Google-like Loading Overlay -->
      <div id="loadingOverlay" class="loading-overlay">
         <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
         </div>
         <div class="loading-text" id="loadingText">Loading...</div>
         <div class="loading-progress">
            <div class="loading-progress-bar"></div>
         </div>
      </div>

      <script>
         document.addEventListener('DOMContentLoaded', function() {
            showLoading('Initializing application...', 'app-init');
            
            // Apply dark mode detection and styling
            updateLoadingMessage('Applying theme settings...', 'app-init');
            applyThemeDetection();
            
            // Initialize Mermaid diagrams
            if (typeof mermaid !== 'undefined') {
               updateLoadingMessage('Setting up diagram renderer...', 'app-init');
               console.log('Initializing Mermaid diagrams...');
               initializeMermaidRendering();
               renderMermaidDiagrams();
            } else {
               console.warn('Mermaid library not loaded');
            }
            
            // Add sorting capability to all tables
            updateLoadingMessage('Preparing interactive tables...', 'app-init');
            makeTablesSortable();
            
            // Add grouping capability to tables with specific columns
            makeTablesGroupable();
            
            // Add pagination to all tables
            makeTablesPaginated();
            
            hideLoading('app-init');
         });
         
         function applyThemeDetection() {
            // Function to apply dark mode
            function applyDarkMode() {
               document.body.classList.add('dark-mode');
               document.documentElement.setAttribute('data-theme', 'dark');
               console.log('Dark mode applied');
               
               // Update Mermaid diagrams theme
               if (typeof updateMermaidTheme === 'function') {
                  setTimeout(updateMermaidTheme, 100);
               }
            }
            
            // Function to apply light mode
            function applyLightMode() {
               document.body.classList.remove('dark-mode');
               document.documentElement.setAttribute('data-theme', 'light');
               console.log('Light mode applied');
               
               // Update Mermaid diagrams theme
               if (typeof updateMermaidTheme === 'function') {
                  setTimeout(updateMermaidTheme, 100);
               }
            }
            
            // Check for dark mode preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
               applyDarkMode();
            } else {
               applyLightMode();
            }
            
            // Listen for changes in color scheme preference
            if (window.matchMedia) {
               const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
               mediaQuery.addEventListener('change', function(e) {
                  showLoading('Switching theme...', 'theme-switch');
                  
                  if (e.matches) {
                     updateLoadingMessage('Applying dark theme...', 'theme-switch');
                     applyDarkMode();
                  } else {
                     updateLoadingMessage('Applying light theme...', 'theme-switch');
                     applyLightMode();
                  }
                  
                  // Update Mermaid diagrams with new theme
                  if (typeof updateMermaidTheme === 'function') {
                     updateMermaidTheme();
                  }
                  
                  hideLoading('theme-switch');
               });
            }
         }
         
         function makeTablesPaginated() {
            const tables = document.querySelectorAll('.table-container table');
            const defaultPageSize = 20;
            
            tables.forEach((table) => {
                // Skip tables that shouldn't be paginated
                if (table.classList.contains('no-pagination')) {
                    return;
                }
                
                // Mark table as paginated
                table.setAttribute('data-paginated', 'true');
                table.setAttribute('data-page-size', String(defaultPageSize));
                table.setAttribute('data-current-page', '1');
                
                // Ensure the table has necessary DOM structure
                let tbody = table.querySelector('tbody');
                if (!tbody) {
                    tbody = document.createElement('tbody');
                    
                    // Move all rows that aren't in thead to tbody
                    const rows = Array.from(table.querySelectorAll('tr'));
                    const theadRows = Array.from(table.querySelectorAll('thead tr'));
                    
                    rows.forEach(row => {
                        if (!theadRows.includes(row)) {
                            tbody.appendChild(row);
                        }
                    });
                    
                    table.appendChild(tbody);
                }
                
                // Store the original table data for pagination
                storeTableData(table);
                
                // Add pagination controls
                addPaginationControls(table);
                
                // Initial pagination
                paginateTable(table);
            });
         }
         
         function storeTableData(table) {
            // Store original rows for pagination
            const tbody = table.querySelector('tbody');
            if (!tbody) {
                return;
            }
            
            // Get all rows, including potential group headers
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Function to preserve icon data before storing
            const preserveIconData = (element) => {
                if (!element) return;
                
                const icons = element.querySelectorAll('.icon, .material-symbols-outlined, [class*="icon"]');
                icons.forEach((icon, index) => {
                    // Store the original icon text as a data attribute
                    const iconText = icon.textContent.trim();
                    if (iconText) {
                        icon.setAttribute('data-original-icon-text', iconText);
                        icon.setAttribute('data-icon-index', String(index));
                    }
                    
                    // Ensure proper classes and styling
                    if (!icon.classList.contains('material-symbols-outlined')) {
                        icon.classList.add('material-symbols-outlined');
                    }
                });
            };
            
            // Check if we're dealing with grouped data
            const hasGroups = rows.some(row => row.classList.contains('group-header'));
            
            // Clear previous pagination data to prevent stale data issues
            if (table._paginationGroupData) delete table._paginationGroupData;
            if (table._paginationData) delete table._paginationData;
            
            if (hasGroups) {
                // For grouped tables, we store the data differently
                const groupData = [];
                let currentGroup = null;
                let currentRows = [];
                
                rows.forEach(row => {
                    if (row.classList.contains('group-header')) {
                        // If we have a previous group, store it
                        if (currentGroup) {
                            groupData.push({
                                header: currentGroup,
                                rows: currentRows
                            });
                        }
                        // Start a new group
                        currentGroup = row;
                        currentRows = [];
                    } else {
                        // Add row to current group
                        currentRows.push(row);
                    }
                });
                
                // Don't forget to add the last group
                if (currentGroup) {
                    groupData.push({
                        header: currentGroup,
                        rows: currentRows
                    });
                }
                
                // Preserve icon data for all grouped elements
                groupData.forEach(group => {
                    preserveIconData(group.header);
                    group.rows.forEach(row => {
                        preserveIconData(row);
                    });
                });
                
                // Store the grouped data
                table._paginationGroupData = groupData;
            } else {
                // For regular tables, filter out any potential group headers just to be safe
                const dataRows = rows.filter(row => !row.classList.contains('group-header'));
                
                // Preserve icon data for all rows
                dataRows.forEach(row => {
                    preserveIconData(row);
                });
                
                table._paginationData = dataRows;
            }
         }
         
         function addPaginationControls(table) {
            const tableContainer = table.closest('.table-container');
            if (!tableContainer) return;
            
            // Create pagination container
            const paginationContainer = document.createElement('div');
            paginationContainer.className = 'table-pagination';
            
            // Top controls with page size selector
            const topControls = document.createElement('div');
            topControls.className = 'pagination-top-controls';
            
            const pageSizeSelector = document.createElement('div');
            pageSizeSelector.className = 'page-size-selector';
            
            // Get current page size from table attribute
            const currentPageSize = parseInt(table.getAttribute('data-page-size') || '20', 10);
            
            // Create the page size selector with the current value selected
            pageSizeSelector.innerHTML = `
                <span class="page-size-label">Items per page</span>
                <select class="page-size-select">
                    <option value="5" ${currentPageSize === 5 ? 'selected' : ''}>5</option>
                    <option value="10" ${currentPageSize === 10 ? 'selected' : ''}>10</option>
                    <option value="20" ${currentPageSize === 20 ? 'selected' : ''}>20</option>
                    <option value="50" ${currentPageSize === 50 ? 'selected' : ''}>50</option>
                    <option value="100" ${currentPageSize === 100 ? 'selected' : ''}>100</option>
                </select>
            `;
            
            // Add event listener for page size change
            const pageSizeSelect = pageSizeSelector.querySelector('.page-size-select');
            pageSizeSelect.addEventListener('change', function() {
                const newPageSize = parseInt(this.value);
                
                console.log(`Page size change requested: ${newPageSize} (from ${table.getAttribute('data-page-size')})`);
                
                // DEBUG: Let's see what's currently visible before making changes
                const currentlyVisibleRows = table.querySelectorAll('tbody tr');
                console.log(`Currently visible rows: ${currentlyVisibleRows.length}`);
                currentlyVisibleRows.forEach((row, index) => {
                    const firstCell = row.querySelector('td');
                    if (firstCell) {
                        console.log(`Row ${index + 1}: ${firstCell.textContent.trim()}`);
                    }
                });
                
                // Calculate pagination values  
                const oldPageSize = parseInt(table.getAttribute('data-page-size')) || 20;
                const oldCurrentPage = parseInt(table.getAttribute('data-current-page')) || 1;
                
                // Get total rows first
                let totalRows = 0;
                if (table._paginationGroupData) {
                    table._paginationGroupData.forEach(group => totalRows += group.rows.length);
                } else if (table._paginationData) {
                    totalRows = table._paginationData.length;
                }
                
                console.log(`Total rows in data: ${totalRows}`);
                
                // Calculate which item we're currently starting with
                const currentFirstItem = (oldCurrentPage - 1) * oldPageSize + 1;
                const currentLastItem = Math.min(currentFirstItem + oldPageSize - 1, totalRows);
                console.log(`Current view: items ${currentFirstItem} to ${currentLastItem}`);
                
                // For page size changes, we want to show the same starting item
                // but limit to the new page size
                let newCurrentPage = Math.ceil(currentFirstItem / newPageSize);
                const newTotalPages = Math.max(1, Math.ceil(totalRows / newPageSize));
                newCurrentPage = Math.max(1, Math.min(newCurrentPage, newTotalPages));
                
                // Calculate how many items we should actually show
                const newFirstItem = (newCurrentPage - 1) * newPageSize + 1;
                const newLastItem = Math.min(newFirstItem + newPageSize - 1, totalRows);
                
                console.log(`Page size change: totalRows=${totalRows}, oldPage=${oldCurrentPage}/${Math.ceil(totalRows / oldPageSize)}, newPage=${newCurrentPage}/${newTotalPages}`);
                console.log(`New view should show: items ${newFirstItem} to ${newLastItem} (max ${newPageSize} items)`);
                
                // IMPORTANT: If we're changing to a smaller page size, we might need to show fewer items
                // to maintain the same starting point
                const visibleItemsCount = currentLastItem - currentFirstItem + 1;
                const expectedNewItemsCount = Math.min(newPageSize, visibleItemsCount);
                console.log(`Currently showing ${visibleItemsCount} items, new page size allows ${newPageSize}, should show ${expectedNewItemsCount}`);
                
                // If the current view has fewer items than the new page size,
                // we might need to adjust to show the same number of items
                if (visibleItemsCount < newPageSize) {
                    console.log(`Adjusting to show same number of items (${visibleItemsCount}) instead of full page size (${newPageSize})`);
                }
                
                // Set new values
                table.setAttribute('data-page-size', newPageSize);
                table.setAttribute('data-current-page', newCurrentPage);
                
                // Execute pagination immediately to see the result
                setTimeout(() => {
                    console.log('Executing pagination with new settings');
                    
                    paginateTable(table);
                    
                    // NOTE: Removed emoji replacement - let's preserve original content exactly
                    const newVisibleRows = table.querySelectorAll('tbody tr');
                    console.log(`After pagination - visible rows: ${newVisibleRows.length}`);
                    newVisibleRows.forEach((row, index) => {
                        const firstCell = row.querySelector('td');
                        if (firstCell) {
                            console.log(`New Row ${index + 1}: ${firstCell.textContent.trim()}`);
                        }
                    });
                }, 0);
            });
            
            // Pagination info (showing X-Y of Z)
            const paginationInfo = document.createElement('div');
            paginationInfo.className = 'pagination-info';
            
            topControls.appendChild(pageSizeSelector);
            topControls.appendChild(paginationInfo);
            
            // Pagination navigation
            const paginationNav = document.createElement('div');
            paginationNav.className = 'pagination-nav';
            
            // We'll populate the navigation in the updatePaginationControls function
            
            // Add all elements to the container
            paginationContainer.appendChild(topControls);
            paginationContainer.appendChild(paginationNav);
            
            // Add to the DOM after the table
            tableContainer.appendChild(paginationContainer);
            
            // Initial update of pagination controls
            updatePaginationControls(table);
         }
         
         function paginateTable(table) {
            // Make sure we have valid numeric values for page size and current page
            const pageSize = Math.max(1, parseInt(table.getAttribute('data-page-size') || '20', 10));
            let currentPage = Math.max(1, parseInt(table.getAttribute('data-current-page') || '1', 10));
            const tbody = table.querySelector('tbody');
            
            if (!tbody) {
                return;
            }
            
            // Calculate total rows and total pages to make sure current page is valid
            let totalRows = 0;
            
            // Check if we have pagination data at all
            if (!table._paginationGroupData && !table._paginationData) {
                try {
                    storeTableData(table);
                } catch (error) {
                    console.error('Error storing table data:', error);
                    return;
                }
            }
            
            // Ensure we're not dealing with stale grouped data when we should be in ungrouped mode
            // Check if the table has actual group headers in the DOM
            const hasRealGroupHeaders = tbody.querySelector('.group-header') !== null;
            
            // If we have grouped data in memory but no actual group headers in the DOM, 
            // we need to rebuild the pagination data for the ungrouped state
            if (table._paginationGroupData && !hasRealGroupHeaders) {
                delete table._paginationGroupData;
                storeTableData(table);
            }
            
            // Calculate total rows from whichever data structure we have
            if (table._paginationGroupData) {
                table._paginationGroupData.forEach(group => totalRows += group.rows.length);
            } else if (table._paginationData) {
                totalRows = table._paginationData.length;
            } else {
                // Emergency fallback - get what's in the DOM right now
                const visibleRows = tbody.querySelectorAll('tr:not(.group-header)').length;
                totalRows = visibleRows;
                if (totalRows === 0) return; // Nothing to do if no rows
            }
            
            // Ensure we have at least one page
            const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
            
            // Ensure current page is valid (between 1 and totalPages)
            currentPage = Math.max(1, Math.min(currentPage, totalPages));
            
            // Update the current page attribute if it was adjusted
            if (currentPage !== parseInt(table.getAttribute('data-current-page') || '1', 10)) {
                table.setAttribute('data-current-page', String(currentPage));
            }
            
            // Clear the table body first
            tbody.innerHTML = '';
            
            // SIMPLIFIED APPROACH: Use direct cloning and restore proper Material Icons
            const simpleCloneRow = (originalRow) => {
                if (!originalRow) return null;
                
                // Clone the row
                const cloned = originalRow.cloneNode(true);
                
                // Convert any emojis back to proper Material Icons
                const emojiToIconMap = {
                    '': { iconName: 'cancel', classes: 'icon icon-high', title: 'High/Critical' },
                    '': { iconName: 'warning', classes: 'icon icon-medium', title: 'Medium/Warning' },
                    '': { iconName: 'recommend', classes: 'icon icon-low', title: 'Low/Info' },
                    '': { iconName: 'check_circle', classes: 'icon icon-check', title: 'Yes/Used/Supported' },
                    '': { iconName: 'cancel', classes: 'icon icon-cross', title: 'No/Not Used/Unsupported' },
                    '': { iconName: 'help', classes: 'icon icon-question', title: 'Uncertain/Likely' },
                    '': { iconName: 'warning', classes: 'icon icon-medium', title: 'Medium/Warning' },
                    '': { iconName: 'warning', classes: 'icon icon-medium', title: 'Medium/Warning' },
                    '': { iconName: 'warning', classes: 'icon icon-medium', title: 'Medium/Warning' },
                    '': { iconName: 'check_circle', classes: 'icon icon-check', title: 'Yes/Used/Supported' },
                    '': { iconName: 'cancel', classes: 'icon icon-cross', title: 'No/Not Used/Unsupported' },
                    '': { iconName: 'help', classes: 'icon icon-question', title: 'Uncertain/Likely' },
                    '': { iconName: 'cancel', classes: 'icon icon-high', title: 'High/Critical' },
                    '': { iconName: 'cancel', classes: 'icon icon-cross', title: 'No/Not Used/Unsupported' },
                    '': { iconName: 'cancel', classes: 'icon icon-high', title: 'High/Critical' }
                };
                
                // Find all text nodes and spans that might contain emojis
                const walker = document.createTreeWalker(
                    cloned,
                    NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT,
                    null,
                    false
                );
                
                const nodesToReplace = [];
                let node;
                
                while (node = walker.nextNode()) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        const text = node.textContent;
                        for (const emoji in emojiToIconMap) {
                            if (text.includes(emoji)) {
                                nodesToReplace.push({
                                    node: node,
                                    emoji: emoji,
                                    iconData: emojiToIconMap[emoji],
                                    text: text
                                });
                                break;
                            }
                        }
                    } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'SPAN') {
                        const text = node.textContent.trim();
                        if (emojiToIconMap[text]) {
                            nodesToReplace.push({
                                node: node,
                                emoji: text,
                                iconData: emojiToIconMap[text],
                                isSpan: true
                            });
                        }
                    }
                }
                
                // Replace emojis with proper Material Icons
                nodesToReplace.forEach(replacement => {
                    if (replacement.isSpan) {
                        // Update span content to proper Material Icon name, use correct semantic classes
                        replacement.node.textContent = replacement.iconData.iconName;
                        replacement.node.className = replacement.iconData.classes + ' material-symbols-outlined';
                        replacement.node.title = replacement.iconData.title;
                        
                        // Apply proper Material Icons styling
                        replacement.node.style.fontFamily = "'Material Symbols Outlined', sans-serif";
                        replacement.node.style.fontVariantEmoji = "text";
                    } else {
                        // For text nodes, create new icon span with correct semantic classes
                        const iconSpan = document.createElement('span');
                        iconSpan.className = replacement.iconData.classes + ' material-symbols-outlined';
                        iconSpan.textContent = replacement.iconData.iconName;
                        iconSpan.title = replacement.iconData.title;
                        iconSpan.style.fontFamily = "'Material Symbols Outlined', sans-serif";
                        iconSpan.style.fontVariantEmoji = "text";
                        
                        // Replace the emoji in the text
                        const newText = replacement.text.replace(replacement.emoji, '');
                        if (newText.trim()) {
                            const textNode = document.createTextNode(newText);
                            replacement.node.parentNode.insertBefore(iconSpan, replacement.node);
                            replacement.node.parentNode.insertBefore(textNode, replacement.node);
                        } else {
                            replacement.node.parentNode.insertBefore(iconSpan, replacement.node);
                        }
                        replacement.node.parentNode.removeChild(replacement.node);
                    }
                });
                
                return cloned;
            };
            
            // Check if we're dealing with grouped data
            if (table._paginationGroupData) {
                // For grouped tables, pagination works differently
                const groupData = table._paginationGroupData;
                let totalRows = 0;
                groupData.forEach(group => totalRows += group.rows.length);
                
                // Calculate pagination
                const totalPages = Math.ceil(totalRows / pageSize);
                const startIdx = (currentPage - 1) * pageSize;
                const endIdx = Math.min(startIdx + pageSize, totalRows);
                
                let rowCount = 0;
                let addedRows = 0;
                
                // Add groups and their visible rows
                groupData.forEach(group => {
                    // Check if any rows from this group should be visible
                    const groupStartRow = rowCount;
                    const groupEndRow = rowCount + group.rows.length;
                    
                    // If any rows in this group are visible in the current page
                    if (groupEndRow > startIdx && groupStartRow < endIdx) {
                        // Add the group header
                        const clonedHeader = simpleCloneRow(group.header);
                        tbody.appendChild(clonedHeader);
                        
                        // Add visible rows from this group
                        for (let i = 0; i < group.rows.length; i++) {
                            if (rowCount >= startIdx && rowCount < endIdx) {
                                const clonedRow = simpleCloneRow(group.rows[i]);
                                tbody.appendChild(clonedRow);
                                addedRows++;
                            }
                            rowCount++;
                        }
                    } else {
                        rowCount += group.rows.length;
                    }
                });
                
                // Restore event listeners for group headers
                const groupHeaders = tbody.querySelectorAll('.group-header');
                groupHeaders.forEach(header => {
                    header.addEventListener('click', function() {
                        this.classList.toggle('collapsed');
                        const isCollapsed = this.classList.contains('collapsed');
                        const groupValue = this.getAttribute('data-group');
                        const groupRows = tbody.querySelectorAll(`tr[data-group="${groupValue}"]:not(.group-header)`);
                        
                        groupRows.forEach(row => {
                            if (isCollapsed) {
                                row.classList.add('collapsed-row');
                            } else {
                                row.classList.remove('collapsed-row');
                            }
                        });
                        
                        const icon = this.querySelector('.group-toggle');
                        if (icon) {
                            icon.textContent = isCollapsed ? 'chevron_right' : 'expand_more';
                            icon.className = 'material-symbols-outlined icon group-toggle';
                        }
                    });
                });
            } else {
                // Regular table pagination
                const rows = table._paginationData;
                if (!rows) return;
                
                // Calculate pagination
                const totalPages = Math.ceil(rows.length / pageSize);
                const startIdx = (currentPage - 1) * pageSize;
                const endIdx = Math.min(startIdx + pageSize, rows.length);
                
                // Add visible rows
                for (let i = startIdx; i < endIdx; i++) {
                    const clonedRow = simpleCloneRow(rows[i]);
                    tbody.appendChild(clonedRow);
                }
            }
            
            // Always update pagination controls at the end
            console.log('Calling updatePaginationControls...');
            // Force this to run after the current execution context
            // This ensures the table is fully updated before pagination controls are created
            setTimeout(() => {
                updatePaginationControls(table);
                
                // NOTE: Removed emoji replacement to preserve original content structure
            }, 0);
            console.log('=== Finished paginateTable ===');
         }
         
         function updatePaginationControls(table) {
            console.log('=== Starting updatePaginationControls ===');
            
            const pageSize = parseInt(table.getAttribute('data-page-size')) || 20;
            const currentPage = parseInt(table.getAttribute('data-current-page')) || 1;
            const tableContainer = table.closest('.table-container');
            const paginationContainer = tableContainer.querySelector('.table-pagination');
            
            console.log(`updatePaginationControls: pageSize=${pageSize}, currentPage=${currentPage}`);
            
            if (!paginationContainer) {
                console.error('No pagination container found');
                return;
            }
            
            // Find pagination elements
            const paginationInfo = paginationContainer.querySelector('.pagination-info');
            const paginationNav = paginationContainer.querySelector('.pagination-nav');
            
            // Calculate total rows
            let totalRows = 0;
            if (table._paginationGroupData) {
                table._paginationGroupData.forEach(group => totalRows += group.rows.length);
            } else if (table._paginationData) {
                totalRows = table._paginationData.length;
            }
            
            // Calculate pagination values
            const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
            const startItem = totalRows === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            const endItem = Math.min(startItem + pageSize - 1, totalRows);
            
            // Update info text
            if (paginationInfo) {
                paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${totalRows}`;
            }
            
            // Clear existing navigation
            if (paginationNav) {
                paginationNav.innerHTML = '';
            }
            
            console.log(`Final pagination state: totalRows=${totalRows}, pageSize=${pageSize}, totalPages=${totalPages}, currentPage=${currentPage}`);
            
            // Always show pagination nav div, but only add buttons if multiple pages
            if (paginationNav) {                
                console.log(`Pagination nav found, totalPages=${totalPages}`);
                
                // Create page buttons regardless of total pages
                // This ensures pagination controls are always visible after page size change
                console.log('Creating page buttons...');
                createPageButtons(paginationNav, currentPage, totalPages, table);
                
                // Make sure the page size selector shows the correct value
                const pageSizeSelect = paginationContainer.querySelector('.page-size-select');
                if (pageSizeSelect && pageSizeSelect.value != pageSize) {
                    console.log(`Updating page size selector from ${pageSizeSelect.value} to ${pageSize}`);
                    pageSizeSelect.value = pageSize;
                } else {
                    console.log(`Page size selector already shows correct value: ${pageSize}`);
                }
            } else {
                console.error('Pagination nav not found!');
            }
            
            console.log('=== Finished updatePaginationControls ===');
         }
         
         function createPageButtons(container, currentPage, totalPages, table) {
            // Validate inputs
            currentPage = Math.max(1, currentPage);
            totalPages = Math.max(1, totalPages);
            
            // Define button styles
            const buttonStyles = `
                border: none;
                background: transparent;
                color: #5f6368;
                padding: 8px 12px;
                margin: 0 2px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: all 0.2s ease;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 32px;
                min-height: 32px;
            `;
            
            const disabledButtonStyles = `
                opacity: 0.38;
                cursor: not-allowed;
                pointer-events: none;
            `;
            
            // Ensure we have at least one page
            totalPages = Math.max(1, totalPages);
            
            // Create a div to hold the navigation buttons
            const navButtonsContainer = document.createElement('div');
            navButtonsContainer.className = 'pagination-nav-buttons';
            
            // First page button
            const firstBtn = document.createElement('button');
            firstBtn.className = 'pagination-button first';
            firstBtn.innerHTML = '<span class="material-symbols-outlined icon">first_page</span>';
            firstBtn.title = 'First Page';
            firstBtn.disabled = currentPage === 1;
            firstBtn.style.cssText = buttonStyles + (currentPage === 1 ? disabledButtonStyles : '');
            
            // Immediately fix the icon in this button
            const firstIcon = firstBtn.querySelector('span');
            if (firstIcon) {
                firstIcon.setAttribute('data-original-icon-text', 'first_page');
                firstIcon.style.fontFamily = "'Material Symbols Outlined', sans-serif";
                firstIcon.style.fontVariantEmoji = "text";
            }
            
            // Add hover effect - Updated Google style
            firstBtn.addEventListener('mouseover', function() {
                if (currentPage !== 1) {
                    this.style.backgroundColor = 'rgba(60, 64, 67, 0.08)';
                    this.style.color = '#202124';
                }
            });
            
            firstBtn.addEventListener('mouseout', function() {
                if (currentPage !== 1) {
                    this.style.backgroundColor = 'transparent';
                    this.style.color = '#5f6368';
                }
            });
            firstBtn.addEventListener('click', () => {
                table.setAttribute('data-current-page', '1');
                paginateTable(table);
            });
            navButtonsContainer.appendChild(firstBtn);
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'pagination-button prev';
            prevBtn.innerHTML = '<span class="material-symbols-outlined icon">chevron_left</span>';
            prevBtn.title = 'Previous Page';
            prevBtn.disabled = currentPage === 1;
            prevBtn.style.cssText = buttonStyles + (currentPage === 1 ? disabledButtonStyles : '');
            
            // Immediately fix the icon in this button
            const prevIcon = prevBtn.querySelector('span');
            if (prevIcon) {
                prevIcon.setAttribute('data-original-icon-text', 'chevron_left');
                prevIcon.style.fontFamily = "'Material Symbols Outlined', sans-serif";
                prevIcon.style.fontVariantEmoji = "text";
            }
            
            // Add hover effect - Updated Google style
            prevBtn.addEventListener('mouseover', function() {
                if (currentPage !== 1) {
                    this.style.backgroundColor = 'rgba(60, 64, 67, 0.08)';
                    this.style.color = '#202124';
                }
            });
            
            prevBtn.addEventListener('mouseout', function() {
                if (currentPage !== 1) {
                    this.style.backgroundColor = 'transparent';
                    this.style.color = '#5f6368';
                }
            });
            prevBtn.addEventListener('click', () => {
                const newPage = Math.max(1, currentPage - 1);
                table.setAttribute('data-current-page', newPage);
                paginateTable(table);
            });
            navButtonsContainer.appendChild(prevBtn);
            
            // Add the nav buttons container to the main container
            container.appendChild(navButtonsContainer);
            
            // Create a div to hold the page number buttons
            const pageNumbersContainer = document.createElement('div');
            pageNumbersContainer.className = 'pagination-page-numbers';
            pageNumbersContainer.style.display = 'flex';
            pageNumbersContainer.style.alignItems = 'center';
            pageNumbersContainer.style.margin = '0 10px';
            
            // Google-style page numbers (always show current page and some context)
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            // Adjust if we're near the end
            if (endPage === totalPages) {
                startPage = Math.max(1, endPage - 4);
            }
            
            // For single page, ensure we show at least that one page
            if (totalPages === 1) {
                startPage = 1;
                endPage = 1;
            }
            
            // Add ellipsis at start if needed
            if (startPage > 1) {
                const ellipsisStart = document.createElement('span');
                ellipsisStart.className = 'pagination-button ellipsis';
                ellipsisStart.style.cssText = `
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    min-width: 36px;
                    height: 36px;
                    margin: 0 4px;
                    font-size: 14px;
                    color: #5f6368;
                `;
                ellipsisStart.textContent = '...';
                pageNumbersContainer.appendChild(ellipsisStart);
            }
            
            // Add page buttons
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = 'pagination-button page-number';
                pageBtn.style.cssText = buttonStyles;
                
                // Add hover effect - Updated Google style
                pageBtn.addEventListener('mouseover', function() {
                    if (i !== currentPage) {
                        this.style.backgroundColor = 'rgba(60, 64, 67, 0.08)'; // Transparent gray hover effect
                        this.style.color = '#202124';
                    }
                });
                
                pageBtn.addEventListener('mouseout', function() {
                    if (i !== currentPage) {
                        this.style.backgroundColor = 'transparent';
                        this.style.color = '#5f6368';
                    }
                });
                
                if (i === currentPage) {
                    pageBtn.classList.add('active');
                    pageBtn.style.backgroundColor = 'var(--product-accent)'; // Google Blue
                    pageBtn.style.color = 'white';
                    pageBtn.style.fontWeight = '500';
                    pageBtn.style.border = 'none';
                }
                
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    table.setAttribute('data-current-page', i);
                    paginateTable(table);
                });
                pageNumbersContainer.appendChild(pageBtn);
            }
            
            // Add ellipsis at end if needed
            if (endPage < totalPages) {
                const ellipsisEnd = document.createElement('span');
                ellipsisEnd.className = 'pagination-button ellipsis';
                ellipsisEnd.style.cssText = `
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    min-width: 36px;
                    height: 36px;
                    margin: 0 4px;
                    font-size: 14px;
                    color: #5f6368;
                `;
                ellipsisEnd.textContent = '...';
                pageNumbersContainer.appendChild(ellipsisEnd);
            }
            
            // Add the page numbers container to the main container
            container.appendChild(pageNumbersContainer);
            
            // Create a div for the next/last buttons
            const nextButtonsContainer = document.createElement('div');
            nextButtonsContainer.className = 'pagination-next-buttons';
            nextButtonsContainer.style.display = 'flex';
            nextButtonsContainer.style.alignItems = 'center';
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'pagination-button next';
            nextBtn.innerHTML = '<span class="material-symbols-outlined icon">chevron_right</span>';
            nextBtn.title = 'Next Page';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.style.cssText = buttonStyles + (currentPage === totalPages ? disabledButtonStyles : '');
            
            // Immediately fix the icon in this button
            const nextIcon = nextBtn.querySelector('span');
            if (nextIcon) {
                nextIcon.setAttribute('data-original-icon-text', 'chevron_right');
                nextIcon.style.fontFamily = "'Material Symbols Outlined', sans-serif";
                nextIcon.style.fontVariantEmoji = "text";
            }
            
            // Add hover effect - Updated Google style
            nextBtn.addEventListener('mouseover', function() {
                if (currentPage !== totalPages) {
                    this.style.backgroundColor = 'rgba(60, 64, 67, 0.08)';
                    this.style.color = '#202124';
                }
            });
            
            nextBtn.addEventListener('mouseout', function() {
                if (currentPage !== totalPages) {
                    this.style.backgroundColor = 'transparent';
                    this.style.color = '#5f6368';
                }
            });
            nextBtn.addEventListener('click', () => {
                const newPage = Math.min(totalPages, currentPage + 1);
                table.setAttribute('data-current-page', newPage);
                paginateTable(table);
            });
            nextButtonsContainer.appendChild(nextBtn);
            
            // Last page button
            const lastBtn = document.createElement('button');
            lastBtn.className = 'pagination-button last';
            lastBtn.innerHTML = '<span class="material-symbols-outlined icon">last_page</span>';
            lastBtn.title = 'Last Page';
            lastBtn.disabled = currentPage === totalPages;
            lastBtn.style.cssText = buttonStyles + (currentPage === totalPages ? disabledButtonStyles : '');
            
            // Immediately fix the icon in this button
            const lastIcon = lastBtn.querySelector('span');
            if (lastIcon) {
                lastIcon.setAttribute('data-original-icon-text', 'last_page');
                lastIcon.style.fontFamily = "'Material Symbols Outlined', sans-serif";
                lastIcon.style.fontVariantEmoji = "text";
            }
            
            // Add hover effect - Updated Google style
            lastBtn.addEventListener('mouseover', function() {
                if (currentPage !== totalPages) {
                    this.style.backgroundColor = 'rgba(60, 64, 67, 0.08)';
                    this.style.color = '#202124';
                }
            });
            
            lastBtn.addEventListener('mouseout', function() {
                if (currentPage !== totalPages) {
                    this.style.backgroundColor = 'transparent';
                    this.style.color = '#5f6368';
                }
            });
            lastBtn.addEventListener('click', () => {
                table.setAttribute('data-current-page', totalPages);
                paginateTable(table);
            });
            nextButtonsContainer.appendChild(lastBtn);
            
            // Add the next buttons container to the main container
            container.appendChild(nextButtonsContainer);
            
            // Fix all icons in the pagination controls
            setTimeout(() => {
                const paginationIcons = container.querySelectorAll('.icon, .material-symbols-outlined');
                paginationIcons.forEach(icon => {
                    if (!icon.classList.contains('material-symbols-outlined')) {
                        icon.classList.add('material-symbols-outlined');
                    }
                    
                    icon.style.fontFamily = "'Material Symbols Outlined', sans-serif";
                    icon.style.fontWeight = "normal";
                    icon.style.fontStyle = "normal";
                    icon.style.fontVariantEmoji = "text"; // Prevent emoji rendering
                    
                    const iconText = icon.textContent.trim();
                    if (iconText) {
                        icon.innerHTML = '';
                        icon.textContent = iconText;
                    }
                });
            }, 0);
         }
         
         function makeTablesSortable() {
            const tables = document.querySelectorAll('.table-container table');
            
            tables.forEach(table => {
               const headers = table.querySelectorAll('th');
               
               headers.forEach((header, index) => {
                  // Skip columns that shouldn't be sortable (you can add a 'no-sort' class to specific headers)
                  if (header.classList.contains('no-sort')) return;
                  
                  // Add sorting indicators and cursor pointer
                  header.style.cursor = 'pointer';
                  header.style.position = 'relative';
                  header.setAttribute('data-sort-direction', '');
                  
                  // Create sort indicator element
                  const sortIndicator = document.createElement('span');
                  sortIndicator.className = 'sort-indicator';
                  sortIndicator.innerHTML = '&nbsp;';
                  sortIndicator.style.fontSize = '0.8em';
                  sortIndicator.style.opacity = '0.6';
                  sortIndicator.style.marginLeft = '5px';
                  sortIndicator.style.display = 'inline-block';
                  header.appendChild(sortIndicator);
                  
                  // Add click event
                  header.addEventListener('click', function() {
                     sortTable(table, index, header);
                  });
               });
            });
         }
         
         function makeTablesGroupable() {
            const tables = document.querySelectorAll('.table-container table');
            
            // For debugging - add a small indicator to help identify if function is running
            console.log('Looking for groupable tables...', tables.length);
            
            tables.forEach((table, tableIndex) => {
               // Make sure the table has a thead
               const thead = table.querySelector('thead');
               if (!thead) return;
               
               const headers = Array.from(thead.querySelectorAll('th'));
               let groupableColumnIndices = [];
               
               // Make all columns groupable
               headers.forEach((header, index) => {
                  // Skip columns that shouldn't be groupable (you can add a 'no-group' class to specific headers)
                  if (header.classList.contains('no-group')) return;
                  
                  const headerText = header.textContent.trim();
                  
                  // Skip empty headers
                  if (headerText !== '') {
                     groupableColumnIndices.push({index: index, name: headerText});
                  }
               });
               
               // If there are any columns to group by, add group controls
               if (groupableColumnIndices.length > 0) {
                  addGroupingControlsToTable(table, groupableColumnIndices);
                  console.log(`Added grouping controls to table ${tableIndex+1} with ${groupableColumnIndices.length} columns`);
               }
            });
         }
         
         function addGroupingControlsToTable(table, groupableColumns) {
            const tableContainer = table.closest('.table-container');
            
            // Remove any existing grouping controls to prevent duplicates
            const existingControls = tableContainer.querySelector('.table-group-controls');
            if (existingControls) {
               existingControls.remove();
            }
            
            // Create grouping control panel with improved styling
            const groupingControls = document.createElement('div');
            groupingControls.className = 'table-group-controls';
            groupingControls.style.display = 'flex';
            groupingControls.style.flexWrap = 'wrap';
            groupingControls.style.alignItems = 'center';
            groupingControls.style.padding = '10px 12px';
            groupingControls.style.backgroundColor = '#f8f9fa';
            groupingControls.style.borderRadius = '4px';
            groupingControls.style.border = '1px solid #e0e0e0';
            
            // Add title with icon
            const groupTitle = document.createElement('div');
            groupTitle.className = 'group-title';
            groupTitle.style.marginRight = '16px';
            groupTitle.style.fontWeight = '500';
            groupTitle.style.display = 'flex';
            groupTitle.style.alignItems = 'center';
            
            const icon = document.createElement('span');
            icon.className = 'material-symbols-outlined';
            icon.textContent = 'filter_list';
            icon.style.marginRight = '6px';
            icon.style.fontSize = '20px';
            icon.style.color = '#0071ce';
            
            const titleText = document.createElement('span');
            titleText.textContent = 'Group by:';
            
            groupTitle.appendChild(icon);
            groupTitle.appendChild(titleText);
            groupingControls.appendChild(groupTitle);
            
            // Add controls for each groupable column
            const groupOptions = document.createElement('div');
            groupOptions.className = 'group-options';
            groupOptions.style.display = 'flex';
            groupOptions.style.flexWrap = 'wrap';
            groupOptions.style.gap = '8px';
            
            // Add "None" option with improved styling
            const noneOption = document.createElement('button');
            noneOption.className = 'group-option active';
            noneOption.textContent = 'None';
            noneOption.style.padding = '6px 12px';
            noneOption.style.border = '1px solid #ddd';
            noneOption.style.borderRadius = '4px';
            noneOption.style.backgroundColor = '#fff';
            noneOption.style.cursor = 'pointer';
            noneOption.style.transition = 'all 0.2s ease';
            
            // Active style
            if (noneOption.classList.contains('active')) {
               noneOption.style.backgroundColor = '#0071ce';
               noneOption.style.color = '#fff';
               noneOption.style.border = '1px solid #0071ce';
            }
            
            noneOption.onclick = function(event) {
               // Prevent event propagation
               event.stopPropagation();
               event.preventDefault();
               
               console.log('None option clicked - Starting grouping reset');
               
               try {
                  // Set this option as active first to provide visual feedback
                  setActiveGroupOption(groupOptions, this);
                  
                  // Add a small delay to ensure UI feedback happens before potentially intensive operation
                  setTimeout(() => {
                     // Ensure we clean up all grouping
                     resetGrouping(table);
                     console.log('None option: grouping reset complete');
                  }, 10);
               } catch (error) {
                  console.error('Error handling None option click:', error);
               }
            };
            
            // Add hover effect
            noneOption.onmouseover = function() {
               if (!this.classList.contains('active')) {
                  this.style.backgroundColor = '#f0f0f0';
               }
            };
            noneOption.onmouseout = function() {
               if (!this.classList.contains('active')) {
                  this.style.backgroundColor = '#fff';
               }
            };
            
            groupOptions.appendChild(noneOption);
            
            // Add column options with the same styling
            groupableColumns.forEach(column => {
               const option = document.createElement('button');
               option.className = 'group-option';
               option.textContent = column.name;
               option.style.padding = '6px 12px';
               option.style.border = '1px solid #ddd';
               option.style.borderRadius = '4px';
               option.style.backgroundColor = '#fff';
               option.style.cursor = 'pointer';
               option.style.transition = 'all 0.2s ease';
               
               // Add hover effect
               option.onmouseover = function() {
                  if (!this.classList.contains('active')) {
                     this.style.backgroundColor = '#f0f0f0';
                  }
               };
               option.onmouseout = function() {
                  if (!this.classList.contains('active')) {
                     this.style.backgroundColor = '#fff';
                  }
               };
               
               option.onclick = (event) => {
                  // Prevent event propagation
                  event.stopPropagation();
                  event.preventDefault();
                  
                  console.log(`Group option clicked: ${column.name}`);
                  groupTableByColumn(table, column.index, column.name);
                  setActiveGroupOption(groupOptions, option);
               };
               groupOptions.appendChild(option);
            });
            
            groupingControls.appendChild(groupOptions);
            
            // Insert controls before the table
            tableContainer.insertBefore(groupingControls, table);
         }
         
         function setActiveGroupOption(container, activeButton) {
            console.log('Setting active group option:', activeButton.textContent);
            
            // Remove active class and reset styles from all buttons
            const buttons = container.querySelectorAll('.group-option');
            buttons.forEach(button => {
               button.classList.remove('active');
               button.style.backgroundColor = '#fff';
               button.style.color = '#333';
               button.style.border = '1px solid #ddd';
            });
            
            // Add active class to the selected button
            activeButton.classList.add('active');
            
            // Apply active styles
            activeButton.style.backgroundColor = '#0071ce';
            activeButton.style.color = '#fff';
            activeButton.style.border = '1px solid #0071ce';
            activeButton.style.fontWeight = '500';
         }
         
         function groupTableByColumn(table, columnIndex, columnName) {
            // Implementation for grouping table by column
            
            // Get all rows except header
            const tbody = table.querySelector('tbody');
            if (!tbody) {
               console.error('No tbody found in table during grouping');
               return;
            }
            
            // First, ensure all existing group headers are removed
            const allRows = Array.from(tbody.querySelectorAll('tr'));
            const dataRows = allRows.filter(row => !row.classList.contains('group-header'));
            const existingGroups = tbody.querySelectorAll('.group-header');
            
            console.log(`Found ${allRows.length} total rows, ${dataRows.length} data rows, ${existingGroups.length} existing group headers`);
            
            // Make sure to remove existing group headers properly
            existingGroups.forEach(group => {
               if (group.parentNode) {
                  group.parentNode.removeChild(group);
               }
            });
            
            // Reset all rows to their default state
            dataRows.forEach(row => {
               row.style.display = '';
               row.removeAttribute('data-group');
               row.classList.remove('first-in-group', 'collapsed-row');
            });
            
            // Group the data - use a new empty object for clean grouping
            const groupedData = {};
            
            dataRows.forEach(row => {
               // Ensure we have the right index
               if (columnIndex >= row.cells.length) {
                  console.warn(`Column index ${columnIndex} out of bounds for row`, row);
                  return;
               }
               
               // Extract only the text content and ignore icons
               const cell = row.cells[columnIndex];
               if (!cell) {
                  console.warn(`No cell found at index ${columnIndex} for row`, row);
                  return;
               }
               
               let cellValue = '';
               
               // Function to extract text nodes only (no icon text)
               function extractTextOnly(element) {
                  // Special case for cells with icons + text pattern like "dangerous High"
                  // Try to find any direct text node that is not within an icon element
                  let directTextContent = '';
                  let hasFoundDirectText = false;
                  
                  // First, check if this is a cell with the specific structure we're targeting
                  // This usually means it has both an icon with text and visible text afterward
                  const iconElements = element.querySelectorAll('.icon, .icon-high, .icon-medium, .icon-low');
                  if (iconElements.length > 0) {
                     // Try to find text nodes that are direct children but not part of icons
                     for (let childNode of element.childNodes) {
                        // Text node that's a direct child
                        if (childNode.nodeType === 3 && childNode.textContent.trim()) {
                           directTextContent += childNode.textContent.trim() + ' ';
                           hasFoundDirectText = true;
                        }
                        // If it's a span that doesn't have icon classes, it might contain our text
                        else if (childNode.nodeType === 1 && 
                                !childNode.classList?.contains('icon') && 
                                !childNode.classList?.contains('icon-high') && 
                                !childNode.classList?.contains('icon-medium') && 
                                !childNode.classList?.contains('icon-low')) {
                           // Only extract text if it doesn't contain icon children
                           if (!childNode.querySelector('.icon')) {
                              directTextContent += childNode.textContent.trim() + ' ';
                              hasFoundDirectText = true;
                           }
                        }
                     }
                  }
                  
                  // If we found direct text, use that (this helps with the specific case of "dangerous High")
                  if (hasFoundDirectText) {
                     return directTextContent.trim();
                  }
                  
                  // Otherwise, use the more generic approach
                  let text = '';
                  for (let node of element.childNodes) {
                     if (node.nodeType === 3) { // Text node
                        text += node.textContent.trim() + ' ';
                     } else if (node.nodeType === 1) { // Element node
                        // Skip icon elements, elements with icon class
                        const classList = node.classList ? Array.from(node.classList) : [];
                        const hasIconClass = classList.some(cls => cls === 'icon' || cls.startsWith('icon-'));
                        const isIcon = hasIconClass || 
                                      node.tagName.toLowerCase() === 'i';
                                    
                        if (!isIcon) {
                           text += extractTextOnly(node);
                        }
                     }
                  }
                  return text;
               }
               
               cellValue = extractTextOnly(cell).trim();
               
               // If we couldn't extract text properly, fallback to full text
               if (!cellValue) {
                  cellValue = cell.textContent.trim();
               }
               
               // Handle empty values specially
               const normalizedValue = cellValue || '(Empty)';
               
               // Create the group if it doesn't exist yet
               if (!groupedData[normalizedValue]) {
                  groupedData[normalizedValue] = [];
               }
               
               // Add the row to the group
               groupedData[normalizedValue].push(row);
            });
            
            // Clear the tbody completely to start fresh
            while (tbody.firstChild) {
               tbody.removeChild(tbody.firstChild);
            }
            
            // Create a sorted array of group values
            const groupValues = Object.keys(groupedData).sort();
            console.log(`Created ${groupValues.length} groups`);
            
            // Add rows back with group headers
            groupValues.forEach(groupValue => {
               const rowsInThisGroup = groupedData[groupValue];
               console.log(`Adding group: "${groupValue}" with ${rowsInThisGroup.length} rows`);
               
               // Create group header
               const groupHeader = document.createElement('tr');
               groupHeader.className = 'group-header';
               groupHeader.setAttribute('data-group', groupValue);
               
               const groupCell = document.createElement('td');
               // Get the correct column count from thead
               const headerRow = table.querySelector('thead tr');
               const colCount = headerRow ? headerRow.cells.length : 
                               (rowsInThisGroup.length > 0 ? rowsInThisGroup[0].cells.length : 1);
               groupCell.colSpan = colCount;
               
               const groupContent = document.createElement('div');
               groupContent.className = 'group-header-content';
               groupContent.style.display = 'flex';
               groupContent.style.alignItems = 'center';
               groupContent.style.padding = '8px';
               groupContent.style.backgroundColor = '#f5f7f9';
               groupContent.style.borderRadius = '4px';
               
               const groupIcon = document.createElement('span');
               groupIcon.className = 'material-symbols-outlined icon group-toggle';
               groupIcon.textContent = 'expand_more';
               groupIcon.style.marginRight = '8px';
               groupIcon.style.color = '#0071ce';
               groupIcon.style.fontFamily = "'Material Symbols Outlined', sans-serif";
               groupIcon.style.fontWeight = 'normal';
               groupIcon.style.fontSize = '20px';
               groupIcon.style.lineHeight = '1';
               groupIcon.style.display = 'flex';
               groupIcon.style.alignItems = 'center';
               groupIcon.style.justifyContent = 'center';
               
               const groupTitle = document.createElement('span');
               groupTitle.className = 'group-header-title';
               groupTitle.textContent = `${columnName}: ${groupValue}`;
               groupTitle.style.fontWeight = '500';
               groupTitle.style.color = '#333';
               
               const groupCount = document.createElement('span');
               groupCount.className = 'group-count';
               groupCount.textContent = `${rowsInThisGroup.length} items`;
               groupCount.style.marginLeft = '12px';
               groupCount.style.fontSize = '0.85em';
               groupCount.style.color = '#666';
               groupCount.style.backgroundColor = 'rgba(0, 113, 206, 0.1)';
               groupCount.style.padding = '2px 8px';
               groupCount.style.borderRadius = '12px';
               
               groupContent.appendChild(groupIcon);
               groupContent.appendChild(groupTitle);
               groupContent.appendChild(groupCount);
               groupCell.appendChild(groupContent);
               groupHeader.appendChild(groupCell);
               
               // Add toggle functionality and make it more obvious
               groupHeader.title = 'Click to expand/collapse group';
               groupHeader.style.cursor = 'pointer';
               
               /* Add tooltip text to make it clear this is collapsible
               const tooltipSpan = document.createElement('span');
               tooltipSpan.className = 'group-tooltip';
               tooltipSpan.textContent = 'Click to expand/collapse';
               tooltipSpan.style.fontSize = '0.75em';
               tooltipSpan.style.color = '#666';
               tooltipSpan.style.marginLeft = '8px';
               tooltipSpan.style.padding = '2px 6px';
               tooltipSpan.style.background = 'rgba(0, 113, 206, 0.08)';
               tooltipSpan.style.borderRadius = '4px';
               groupContent.appendChild(tooltipSpan);*/
               
               groupHeader.addEventListener('click', function(event) {
                  // Prevent event propagation
                  event.stopPropagation();
                  
                  this.classList.toggle('collapsed');
                  const isCollapsed = this.classList.contains('collapsed');
                  const groupValue = this.getAttribute('data-group');
                  
                  // Ensure we're getting the right rows by being more specific with our selector
                  // We need to escape special characters in the group value for the selector
                  const escapedGroupValue = groupValue.replace(/"/g, '\\"');
                  const groupRows = tbody.querySelectorAll(`tr[data-group="${escapedGroupValue}"]:not(.group-header)`);
                  
                  console.log(`Toggle group: "${groupValue}", Collapsed: ${isCollapsed}, Found rows: ${groupRows.length}`);
                  
                  // Toggle row visibility with CSS classes for better performance
                  groupRows.forEach(row => {
                     if (isCollapsed) {
                        row.classList.add('collapsed-row');
                        row.style.display = 'none';
                     } else {
                        row.classList.remove('collapsed-row');
                        row.style.display = '';
                     }
                  });
                  
                  // Update the icon with proper styling
                  const icon = this.querySelector('.group-toggle');
                  if (icon) {
                     icon.textContent = isCollapsed ? 'chevron_right' : 'expand_more';
                     
                     // Ensure consistent icon styling after text change
                     icon.style.fontFamily = "'Material Symbols Outlined', sans-serif";
                     icon.style.fontWeight = 'normal';
                     icon.style.fontSize = '20px';
                     icon.style.lineHeight = '1';
                     icon.style.display = 'flex';
                     icon.style.alignItems = 'center';
                     icon.style.justifyContent = 'center';
                  }
                  
                  /* Update tooltip text based on collapsed state
                  const tooltipElement = this.querySelector('.group-tooltip');
                  if (tooltipElement) {
                     tooltipElement.textContent = isCollapsed ? 'Click to expand' : 'Click to collapse';
                  }*/
                  
                  // Show a count of collapsed items when collapsed
                  const existingBadge = this.querySelector('.collapsed-count');
                  if (existingBadge) {
                     existingBadge.remove();
                  }
                  
                  if (isCollapsed) {
                     const count = groupRows.length;
                     const countBadge = document.createElement('span');
                     countBadge.className = 'collapsed-count';
                     countBadge.textContent = `(${count} items hidden)`;
                     countBadge.style.fontSize = '0.7em';
                     countBadge.style.padding = '2px 8px';
                     countBadge.style.backgroundColor = 'rgba(0, 113, 206, 0.15)';
                     countBadge.style.color = 'rgba(0, 113, 206, 0.9)';
                     countBadge.style.borderRadius = '10px';
                     countBadge.style.marginLeft = '10px';
                     countBadge.style.fontWeight = '500';
                     countBadge.style.border = '1px solid rgba(0, 113, 206, 0.3)';
                     
                     const headerContent = this.querySelector('.group-header-content');
                     if (headerContent) {
                        headerContent.appendChild(countBadge);
                     }
                  }
               });
               
               // Add the group header to the tbody
               tbody.appendChild(groupHeader);
               
               // Add the rows for this group with data-group attribute
               groupedData[groupValue].forEach((row, i) => {
                  // Set data-group attribute for proper identification
                  row.setAttribute('data-group', groupValue);
                  
                  // Style the first row in each group differently if needed
                  if (i === 0) {
                     row.classList.add('first-in-group');
                  }
                  
                  // Add the row to the tbody
                  tbody.appendChild(row);
               });
            });
            
            // Make sure we have consistent styles for grouped table
            const style = document.createElement('style');
            style.textContent = `
               .group-header { background-color: #f5f7f9; }
               .group-header td { padding: 0 !important; }
               .group-header-content { padding: 10px; }
               .collapsed-row { display: none; }
               tr.first-in-group td { border-top: 1px solid #e0e0e0; }
               .group-header:hover { background-color: #eef1f5; }
               
               /* Material Icons proper styling */
               .material-symbols-outlined.icon {
                  font-family: 'Material Symbols Outlined', sans-serif !important;
                  font-weight: normal !important;
                  font-style: normal !important;
                  font-size: 20px !important;
                  line-height: 1 !important;
                  display: inline-flex !important;
                  align-items: center !important;
                  justify-content: center !important;
                  text-transform: none !important;
                  letter-spacing: normal !important;
                  overflow-wrap: normal !important;
                  white-space: nowrap !important;
                  direction: ltr !important;
                  -webkit-font-smoothing: antialiased !important;
               }
            `;
            
            // Only add the style if it doesn't exist yet
            if (!document.querySelector('style[data-group-styles="true"]')) {
                style.setAttribute('data-group-styles', 'true');
                document.head.appendChild(style);
            }
            
            console.log('Group headers and rows added to table');
            
            // Re-apply pagination if it's enabled
            if (table.hasAttribute('data-paginated')) {
               console.log('Table is paginated, re-applying pagination after grouping');
               // Re-store table data since grouping has changed the structure
               storeTableData(table);
               // Reset to first page and update
               table.setAttribute('data-current-page', '1');
               paginateTable(table);
            }
         }
         
         function resetGrouping(table) {
            console.log('Resetting table grouping - START');
            const tbody = table.querySelector('tbody');
            if (!tbody) {
               console.error('No tbody found in table during resetGrouping');
               return;
            }
            
            try {
               // Backup of all non-header rows (important data rows)
               const allRows = Array.from(tbody.querySelectorAll('tr'));
               const dataRows = allRows.filter(row => !row.classList.contains('group-header'));
               
               console.log(`Found ${allRows.length} total rows, ${dataRows.length} data rows to restore`);
               
               // Make a clean copy of each data row to avoid any reference issues
               const cleanDataRows = dataRows.map(row => {
                  const clonedRow = row.cloneNode(true);
                  
                  // Reset any grouping-related attributes and styling
                  clonedRow.removeAttribute('data-group');
                  clonedRow.classList.remove('first-in-group', 'collapsed-row');
                  clonedRow.style.display = '';
                  
                  // Ensure any row that was hidden is now visible
                  if (row.style.display === 'none') {
                     clonedRow.style.display = '';
                  }
                  
                  return clonedRow;
               });
               
               console.log(`Created ${cleanDataRows.length} clean rows for regrouping`);
               
               // Clear the tbody completely to start fresh
               console.log('Clearing tbody to start fresh');
               while (tbody.firstChild) {
                  tbody.removeChild(tbody.firstChild);
               }
               
               // Re-add all data rows in their original order with clean state
               console.log('Re-adding clean data rows to table');
               cleanDataRows.forEach(row => tbody.appendChild(row));
               
               // Re-apply pagination if it's enabled
               if (table.hasAttribute('data-paginated')) {
                  console.log('Table is paginated, restoring pagination after group reset');
                  // Re-store table data since we've reset the grouping
                  storeTableData(table);
                  // Reset to first page and update
                  table.setAttribute('data-current-page', '1');
                  paginateTable(table);
               }
               
               console.log('Resetting table grouping - COMPLETE');
            } catch (error) {
               console.error('Error in resetGrouping:', error);
            }
         }
         
         function sortTable(table, columnIndex, header) {
            const sortDirection = header.getAttribute('data-sort-direction');
            const newDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            
            // Reset all headers
            const headers = table.querySelectorAll('th');
            headers.forEach(h => {
               h.setAttribute('data-sort-direction', '');
               const indicator = h.querySelector('.sort-indicator');
               if (indicator) indicator.innerHTML = '&nbsp;';
               indicator.style.opacity = '0.6';
            });
            
            // Set current header
            header.setAttribute('data-sort-direction', newDirection);
            const sortIndicator = header.querySelector('.sort-indicator');
            sortIndicator.innerHTML = newDirection === 'asc' ? '&nbsp;' : '&nbsp;';
            sortIndicator.style.opacity = '1';
            
            // Check if table is grouped
            const tbody = table.querySelector('tbody');
            const groupHeaders = tbody.querySelectorAll('.group-header');
            
            if (groupHeaders.length > 0) {
               // Table is grouped, sort within each group
               const groups = {};
               
               // Collect all groups
               groupHeaders.forEach(header => {
                  const groupValue = header.getAttribute('data-group');
                  groups[groupValue] = [];
                  
                  // Find all rows in this group
                  const groupRows = tbody.querySelectorAll(`tr[data-group="${groupValue}"]:not(.group-header)`);
                  groupRows.forEach(row => groups[groupValue].push(row));
                  
                  // Sort rows in this group
                  groups[groupValue].sort((rowA, rowB) => {
                     const cellA = rowA.cells[columnIndex].textContent.trim();
                     const cellB = rowB.cells[columnIndex].textContent.trim();
                     
                     // Check if values are numbers
                     const numA = parseFloat(cellA);
                     const numB = parseFloat(cellB);
                     
                     if (!isNaN(numA) && !isNaN(numB)) {
                        return newDirection === 'asc' ? numA - numB : numB - numA;
                     } else {
                        // String comparison
                        return newDirection === 'asc' 
                           ? cellA.localeCompare(cellB) 
                           : cellB.localeCompare(cellA);
                     }
                  });
                  
                  // Remove existing rows
                  groupRows.forEach(row => {
                     tbody.removeChild(row);
                  });
                  
                  // Insert sorted rows after their group header
                  let insertAfter = header;
                  const isGroupCollapsed = header.classList.contains('collapsed');
                  
                  groups[groupValue].forEach((row, idx) => {
                     // Preserve the collapsed state from the group header
                     if (isGroupCollapsed) {
                        row.classList.add('collapsed-row');
                     } else {
                        row.classList.remove('collapsed-row');
                     }
                     
                     // Add first-in-group class to the first row
                     if (idx === 0) {
                        row.classList.add('first-in-group');
                     } else {
                        row.classList.remove('first-in-group');
                     }
                     
                     if (insertAfter.nextSibling) {
                        tbody.insertBefore(row, insertAfter.nextSibling);
                     } else {
                        tbody.appendChild(row);
                     }
                     insertAfter = row;
                  });
               });
               
            } else {
               // Normal sorting (no groups)
               const rows = Array.from(tbody.querySelectorAll('tr'));
               
               // Sort rows
               rows.sort((rowA, rowB) => {
                  const cellA = rowA.cells[columnIndex].textContent.trim();
                  const cellB = rowB.cells[columnIndex].textContent.trim();
                  
                  // Check if values are numbers
                  const numA = parseFloat(cellA);
                  const numB = parseFloat(cellB);
                  
                  if (!isNaN(numA) && !isNaN(numB)) {
                     return newDirection === 'asc' ? numA - numB : numB - numA;
                  } else {
                     // String comparison
                     return newDirection === 'asc' 
                        ? cellA.localeCompare(cellB) 
                        : cellB.localeCompare(cellA);
                  }
               });
               
               // Remove existing rows
               rows.forEach(row => tbody.removeChild(row));
               
               // Add sorted rows
               rows.forEach(row => tbody.appendChild(row));
            }
            
            // Re-apply pagination if it's enabled
            if (table.hasAttribute('data-paginated')) {
               // Re-store table data since sorting has changed the structure
               storeTableData(table);
               paginateTable(table);
            }
            
            // Add a highlight effect on sorting
            tbody.style.transition = 'background-color 0.3s ease';
            tbody.style.backgroundColor = 'rgba(0, 113, 206, 0.05)';
            setTimeout(() => {
               tbody.style.backgroundColor = '';
            }, 500);
         }
      </script>

      <style>
         :root {
         /* Light Theme */
         --cgd-blue: #0071CE;
         --product-accent: #0071CE;
         --product-accent-hover: #00559A;
         --text-primary: #202124;
         --text-secondary: #5f6368;
         --border-color: #dadce0;
         --background-main: #f8f9fa;
         --background-card: #ffffff;
         --background-hover: #f1f3f4;
         --background-button: #0071CE;
         --background-button-text: #ffffff;
         /* Icon Colors */
         --color-red: #d93025;
         --color-amber: #f9ab00;
         --color-green: #1e8e3e;
         }
        html.dark-mode {
         /* Dark Theme - Improved for better visibility and contrast */
         --product-accent: #4285f4;
         --product-accent-hover: #5294ff;
         --text-primary: #ffffff;
         --text-secondary: #ffffff;
         --border-color: #5f6368;
         --background-main: #1a1a1a;
         --background-card: #2d2d2d;
         --background-hover: #404040;
         --background-button: #4285f4;
         --background-button-text: #ffffff;
         /* Improved Icon Colors for dark mode */
         --color-red: #f28b82;
         --color-amber: #fdd663;
         --color-green: #81c995;
         }
         html {
         color: var(--text-primary);
         background-color: var(--background-main);
         box-sizing: border-box;
         scroll-behavior: smooth;
         }
         *, *::before, *::after { box-sizing: inherit; }
         body {
         margin: 0; padding: 0; width: 100%;
         font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
         font-size: 14px; line-height: 1.6;
         text-rendering: optimizeLegibility;
         overflow-x: hidden;
         text-align: left;
         color: var(--text-primary);
         background-color: var(--background-main);
         transition: background-color 0.3s ease, color 0.3s ease;
         }
         /* --- HEADER --- */
         /* --- READING PROGRESS INDICATOR --- */
         .reading-progress {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 3px;
         background-color: rgba(0, 113, 206, 0.1);
         z-index: 103;
         opacity: 0;
         transition: opacity 0.3s ease;
         }
         .reading-progress.show {
         opacity: 1;
         }
         .reading-progress-fill {
         height: 100%;
         background: linear-gradient(90deg, var(--product-accent) 0%, #00559A 100%);
         width: 0%;
         transition: width 0.1s ease-out;
         border-radius: 0 2px 2px 0;
         box-shadow: 0 0 10px rgba(0, 113, 206, 0.3);
         }
         .reading-progress-text {
         position: fixed;
         top: 8px;
         right: 20px;
         background-color: var(--background-card);
         color: var(--text-secondary);
         font-size: 0.75rem;
         font-weight: 500;
         padding: 0.25rem 0.5rem;
         border-radius: 12px;
         border: 1px solid var(--border-color);
         z-index: 104;
         opacity: 0;
         visibility: hidden;
         transition: all 0.3s ease;
         backdrop-filter: blur(8px);
         }
         .reading-progress-text.show {
         opacity: 1;
         visibility: visible;
         }
         .header {
         background-color: var(--background-card);
         box-shadow: 0 1px 2px rgba(0,0,0,0.1);
         position: sticky;
         top: 0;
         z-index: 102;
         width: 100%;
         border-bottom: 1px solid var(--border-color);
         transition: background-color 0.3s ease, border-color 0.3s ease;
         }
         .header-container {
         display: flex;
         align-items: center;
         justify-content: space-between;
         padding: 0.5rem 1.5rem; /* Reduced padding */
         max-width: 100%;
         margin: 0 auto;
         }
         .header-brand { display: flex; align-items: center; }
         .header-logo { height: 38px; margin-right: 1rem; }
         .header-title { font-size: 18px; font-weight: 600; color: var(--cgd-blue); padding: 0; }
         .header-controls { display: flex; align-items: center; gap: 0.5rem; }
         .support-button {
         background-color: var(--background-button);
         color: var(--background-button-text);
         border: 1px solid transparent;
         border-radius: 4px;
         padding: 8px 16px;
         font-size: 14px;
         font-weight: 500;
         text-decoration: none;
         cursor: pointer;
         transition: background-color 0.2s ease, box-shadow 0.2s ease;
         margin-left: 1rem;
         }
         .support-button:hover {
         background-color: var(--product-accent-hover);
         box-shadow: 0 1px 3px rgba(0,0,0,0.1);
         }
         .icon-button {
         background: none; border: none; cursor: pointer;
         padding: 8px; border-radius: 50%;
         display: inline-flex; align-items: center; justify-content: center;
         color: var(--text-secondary);
         transition: background-color 0.2s ease, color 0.2s ease;
         }
         .icon-button:hover { background-color: var(--background-hover); color: var(--text-primary); }
         .icon-button .icon { margin: 0; vertical-align: -6px; }
         /* --- MAIN CONTENT & TYPOGRAPHY --- */
         .content { max-width: 100%; padding: 0 1.5rem; margin: 0 auto; }
         .product-header {
         background-color: var(--background-card);
         padding: 2rem 1.5rem;
         margin-bottom: 0;
         border-bottom: 1px solid var(--border-color);
         transition: background-color 0.3s ease, border-color 0.3s ease;
         }
         .document-meta {
         display: flex;
         align-items: center;
         gap: 1rem;
         margin-top: 0.5rem;
         color: var(--text-secondary);
         font-size: 0.875rem;
         }
         .read-time { display: flex; align-items: center; gap: 0.25rem; }
         .read-time .icon { font-size: 18px; vertical-align: -4px; }
         h1, h2, h3, h4 { color: var(--text-primary); text-align: left; font-weight: 600; margin-bottom: 1rem; }
         h1 { margin-top: 0; font-size: 2.25rem; padding-bottom: 0.5rem; }
         h2 { font-size: 1.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); transition: border-color 0.3s ease; }
         h3 { font-size: 1.4rem; }
         h4 { font-size: 1.2rem; }
         p { margin: 1rem 0; color: var(--text-secondary); }
         /* --- ICON STYLES --- */
         .icon { font-family: 'Material Symbols Outlined', sans-serif; font-weight: normal; font-style: normal; font-size: 20px; line-height: 1; letter-spacing: normal; text-transform: none; display: inline-block; white-space: nowrap; word-wrap: normal; direction: ltr; -webkit-font-smoothing: antialiased; vertical-align: -5px; margin-right: 0.07em; }
         .icon-high { color: var(--color-red); }
         .icon-medium { color: var(--color-amber); }
         .icon-low { color: var(--color-green); }
         .icon-check { color: var(--color-green); }
         .icon-cross { color: var(--color-red); }
         .icon-question { color: var(--text-secondary); }
         /* --- BREADCRUMB NAVIGATION --- */
         .breadcrumb-container {
         background-color: var(--background-main);
         border-top: 1px solid var(--border-color);
         padding: 0.5rem 1.5rem;
         transition: all 0.3s ease;
         }
         .breadcrumb {
         display: flex;
         align-items: center;
         flex-wrap: wrap;
         gap: 0.5rem;
         font-size: 0.8rem;
         color: var(--text-secondary);
         max-width: 1200px;
         margin: 0 auto;
         }
         .breadcrumb-item {
         display: flex;
         align-items: center;
         gap: 0.25rem;
         }
         .breadcrumb-link {
         color: var(--text-secondary);
         text-decoration: none;
         padding: 0.25rem 0.5rem;
         border-radius: 4px;
         transition: all 0.2s ease;
         cursor: pointer;
         }
         .breadcrumb-link:hover {
         color: var(--product-accent);
         background-color: var(--background-hover);
         }
         .breadcrumb-link.active {
         color: var(--product-accent);
         font-weight: 500;
         background-color: rgba(0, 113, 206, 0.1);
         }
         .breadcrumb-separator {
         color: var(--border-color);
         font-size: 0.75rem;
         margin: 0 0.25rem;
         }
         .breadcrumb-home {
         display: flex;
         align-items: center;
         gap: 0.25rem;
         color: var(--text-secondary);
         text-decoration: none;
         padding: 0.25rem 0.5rem;
         border-radius: 4px;
         transition: all 0.2s ease;
         }
         .breadcrumb-home:hover {
         color: var(--product-accent);
         background-color: var(--background-hover);
         }
         .breadcrumb-home .icon {
         font-size: 16px;
         }
         .breadcrumb-section-info {
         margin-left: auto;
         display: flex;
         align-items: center;
         gap: 1rem;
         font-size: 0.8rem;
         color: var(--text-secondary);
         }
         .breadcrumb-progress {
         display: flex;
         align-items: center;
         gap: 0.25rem;
         }
         .breadcrumb-progress-bar {
         width: 60px;
         height: 4px;
         background-color: var(--border-color);
         border-radius: 2px;
         overflow: hidden;
         }
         .breadcrumb-progress-fill {
         height: 100%;
         background-color: var(--product-accent);
         width: 0%;
         transition: width 0.3s ease;
         }
         /* Mobile adjustments for breadcrumb */
         @media (max-width: 768px) {
         .breadcrumb-container {
         padding: 0.4rem 1rem;
         }
         .breadcrumb {
         font-size: 0.75rem;
         }
         .breadcrumb-section-info {
         display: none;
         }
         .breadcrumb-link {
         padding: 0.2rem 0.4rem;
         }
         }
         @media (max-width: 480px) {
         .breadcrumb-container {
         padding: 0.3rem 1rem;
         }
         .breadcrumb {
         font-size: 0.7rem;
         gap: 0.25rem;
         }
         .breadcrumb-link {
         padding: 0.15rem 0.3rem;
         max-width: 100px;
         overflow: hidden;
         text-overflow: ellipsis;
         white-space: nowrap;
         }
         }
         /* --- TAB STYLES --- */
         .tab-navigation-container {
         position: sticky; top: 62px; /* After header (which now includes breadcrumb) */
         background-color: var(--background-card);
         z-index: 101;
         border-bottom: 1px solid var(--border-color);
         width: 100vw; margin-left: calc(-50vw + 50%);
         transition: background-color 0.3s ease, border-color 0.3s ease;
         }
         .tab-nav-scroller { overflow-x: auto; scrollbar-width: thin; scrollbar-color: var(--border-color) transparent; padding: 0 1.5rem; }
         .tab-navigation { display: flex; flex-wrap: nowrap; white-space: nowrap; margin: 0; padding: 0; list-style: none; }
         .tab-link { padding: 0.75rem 0; margin: 0 1.25rem; cursor: pointer; background: none; border: none; border-bottom: 3px solid transparent; color: var(--text-secondary); font-size: 0.9rem; font-weight: 500; transition: color 0.2s ease, border-color 0.2s ease; margin-bottom: -1px; text-align: center; }
         
         
         .tab-link:hover { color: var(--product-accent); }
         .tab-link.active { color: var(--product-accent); border-bottom-color: var(--product-accent); }
         .tab-link:first-child { margin-left: 0; } .tab-link:last-child { margin-right: 0; }
         .tab-content { padding-top: 2rem; }
         .tab-pane { display: none; animation: fadeIn 0.5s ease; }
         .tab-pane.active { display: block; }
         .tab-link span {font-weight: 550; }
         @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
         .product-section { margin-bottom: 3rem; background: var(--background-card); border-radius: 8px; border: 1px solid var(--border-color); padding: 0 2rem; transition: background-color 0.3s ease, border-color 0.3s ease; }
         /* --- TABLES --- */
         .table-container { width: 100%; overflow-x: auto; margin: 1.5rem 0; border: 1px solid var(--border-color); border-radius: 8px; transition: border-color 0.3s ease; }
         table { width: 100%; border-collapse: collapse; min-width: 650px; }
         th, td { padding: 12px 16px; text-align: left; vertical-align: middle; font-size: 0.875rem; border-bottom: 1px solid var(--border-color); transition: border-color 0.3s ease;}
         th { background-color: var(--background-main); color: var(--text-primary); font-weight: 500; position: sticky; top: 0; z-index: 10; transition: background-color 0.3s ease, color 0.3s ease; }
         tr:last-child td { border-bottom: none; }
         tr:hover { background-color: var(--background-hover); }
         td strong { color: var(--text-primary); font-weight: 500; }
         td .icon { margin-left: -4px; }

         /* Sortable table styles */
         th[data-sort-direction="asc"],
         th[data-sort-direction="desc"] {
            background-color: rgba(0, 113, 206, 0.1);
         }
         th .sort-indicator {
            transition: transform 0.2s ease, opacity 0.2s ease;
         }
         th:hover .sort-indicator {
            opacity: 1 !important;
         }
         th:hover {
            background-color: rgba(0, 113, 206, 0.05);
         }
         tbody tr.sort-highlight {
            animation: highlightRow 1s ease;
         }
         @keyframes highlightRow {
            0% { background-color: rgba(0, 113, 206, 0.1); }
            100% { background-color: transparent; }
         }
         
         /* Table grouping styles */
         .table-group-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 0px;
            padding: 8px 12px;
            background-color: var(--background-main);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            transition: border-color 0.3s ease, background-color 0.3s ease;
         }
         
         .group-title {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9rem;
         }
         
         .group-options {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
         }
         
         .group-option {
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--background-card);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
         }
         
         .group-option:hover {
            background-color: var(--background-hover);
            color: var(--text-primary);
         }
         
         .group-option.active {
            background-color: var(--product-accent);
            color: white;
            border-color: var(--product-accent);
            font-weight: 500;
         }
         
         tr.group-header {
            background-color: rgba(0, 113, 206, 0.08);
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            border-radius: 4px;
            border-left: 3px solid rgba(0, 113, 206, 0.6);
         }
         
         tr.group-header:hover {
            background-color: rgba(0, 113, 206, 0.15);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
         }
         
         tr.group-header.collapsed {
            background-color: rgba(0, 113, 206, 0.12);
            border-left-color: rgba(0, 113, 206, 0.6);
            margin-bottom: 0;
            border-bottom: 2px solid rgba(0, 113, 206, 0.4);
            position: relative; /* For the ::after pseudo-element */
         }
         
         tr.group-header.collapsed:hover {
            background-color: rgba(0, 113, 206, 0.18);
         }
         
         /* Add visual indicator of collapsed rows below */
         tr.group-header.collapsed::after {
            content: "";
            height: 3px;
            background: linear-gradient(to right, rgba(0, 113, 206, 0.4), rgba(0, 113, 206, 0.1), transparent);
            display: block;
            position: relative;
            margin-top: 2px;
         }
         
         /* Add a more prominent indicator for collapsed content */
         tr.group-header.collapsed td:first-child {
            position: relative;
         }
         
         tr.group-header.collapsed td:first-child::before {
            content: ""; /* Down-pointing triangle */
            position: absolute;
            right: 10px;
            color: rgba(0, 113, 206, 0.6);
            font-size: 12px;
         }
         
         .group-header-content {
            display: flex;
            align-items: center;
            padding: 4px 0;
            flex-wrap: wrap;
         }
         
         .group-header-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-right: 8px;
         }
         
         .group-count {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background-color: var(--background-card);
            padding: 2px 8px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
         }
         
         .group-toggle {
            margin-right: 10px;
            transition: all 0.3s ease;
            color: rgba(0, 113, 206, 0.8);
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 113, 206, 0.1);
            width: 26px;
            height: 26px;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            font-size: 18px;
         }
         
         tr.group-header:hover .group-toggle {
            background-color: rgba(0, 113, 206, 0.2);
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
         }
         
         tr.group-header.collapsed .group-toggle {
            transform: rotate(-90deg);
            color: rgba(0, 113, 206, 0.6);
            background-color: rgba(0, 113, 206, 0.05);
         }
         
         /* Simplify the animation */
         tr.group-header.collapsed:hover .group-toggle {
            background-color: rgba(0, 113, 206, 0.15);
            transform: rotate(-90deg) scale(1.05);
         }
         
         /* Styles for grouped rows */
         tr[data-group] {
            transition: all 0.3s ease;
         }
         
         /* Collapsed rows - completely hidden */
         tbody tr.collapsed-row {
            display: none !important;
         }
         
         tr.first-in-group {
            border-top: 1px solid rgba(0, 113, 206, 0.1);
         }
         
         @media (max-width: 768px) {
            .table-group-controls {
               flex-direction: column;
               align-items: flex-start;
               gap: 8px;
            }
            
            .group-options {
               width: 100%;
            }
         }
         
         /* Table Pagination Styles */
         .table-pagination {
            margin-top: 1rem;
            border-top: 1px solid var(--border-color);
            padding-top: 0.75rem;
         }
         
         .pagination-top-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-left:12px;
            padding-right: 12px;
         }
         
         .page-size-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
         }
         
         .page-size-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
         }
         
         .page-size-select {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--background-card);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
         }
         
         .page-size-select:focus {
            outline: none;
            border-color: var(--product-accent);
            box-shadow: 0 0 0 2px rgba(0, 113, 206, 0.1);
         }
         
         .pagination-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
         }
         
         .pagination-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            padding: 8px 0;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
         }
         
         .pagination-button {
            min-width: 36px;
            height: 36px;
            padding: 0;
            border: none;
            border-radius: 4px;
            background-color: transparent;
            color: var(--product-accent);
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin: 0 2px;
         }
         
         .pagination-button:hover:not(:disabled) {
            background-color: rgba(0, 113, 206, 0.08);
            color: var(--product-accent);
         }
         
         .pagination-button {
            background-color: var(--product-accent);
            color: white;
            font-weight: 500;
         }
         
         /* Navigation buttons styling */
         .pagination-button.prev,
         .pagination-button.next,
         .pagination-button.first,
         .pagination-button.last {
            background-color: transparent;
            border-radius: 50%;
         }
         
         /* Number buttons styling */
         .pagination-button.page-number {
            font-family: 'Roboto', Arial, sans-serif;
            font-weight: 500;
         }
         
         .pagination-button.ellipsis {
            cursor: default;
            min-width: 24px;
         }
         
         .pagination-button.ellipsis:hover {
            background-color: transparent;
         }
         
         .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: var(--text-secondary);
         }
         
         .pagination-button.prev,
         .pagination-button.next,
         .pagination-button.first,
         .pagination-button.last {
            background-color: transparent;
            border: none;
         }
         
         .pagination-button.prev:hover:not(:disabled),
         .pagination-button.next:hover:not(:disabled),
         .pagination-button.first:hover:not(:disabled),
         .pagination-button.last:hover:not(:disabled) {
            background-color: rgba(0, 113, 206, 0.08);
            border: none;
         }
         
         .pagination-button .icon {
            font-size: 20px;
            margin: 0;
            font-family: 'Material Symbols Outlined', sans-serif !important;
            vertical-align: middle;
            font-style: normal;
         }
         
         .icon {
            font-family: 'Material Symbols Outlined', sans-serif !important;
            font-weight: normal;
            font-style: normal;
            line-height: 1;
            text-transform: none;
            letter-spacing: normal;
            word-wrap: normal;
            white-space: nowrap;
            direction: ltr;
            display: inline-block;
            text-rendering: auto;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
         }
         
         /* Ensure Material Symbols are properly applied */
         span.material-symbols-outlined,
         .material-symbols-outlined {
            font-family: 'Material Symbols Outlined', sans-serif !important;
            font-weight: normal;
            font-style: normal;
            font-size: 20px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            font-feature-settings: 'liga';
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
         }
         
         .pagination-button.ellipsis {
            cursor: default;
            color: var(--text-secondary);
         }
         
         .pagination-button.ellipsis:hover {
            background-color: transparent;
         }
         
         /* Mobile adjustments for pagination */
         @media (max-width: 768px) {
            .pagination-top-controls {
               flex-direction: column;
               align-items: flex-start;
               gap: 0.5rem;
            }
            
            .pagination-info {
               margin-top: 0.25rem;
            }
            
            .pagination-button {
               min-width: 32px;
               height: 32px;
            }
         }
         
         @media (max-width: 480px) {
            .pagination-button:not(.prev):not(.next):not(.active):not(.first):not(.last) {
               display: none;
            }
            
            .pagination-button.ellipsis:first-of-type,
            .pagination-button.ellipsis:last-of-type {
               display: flex;
            }
            
            .pagination-nav {
               width: 100%;
               justify-content: space-between;
            }
         }
         /* --- FLOATING TABLE OF CONTENTS --- */
         .floating-toc {
         position: fixed;
         top: 50%;
         right: 20px;
         transform: translateY(-50%);
         background-color: var(--background-card);
         border: 1px solid var(--border-color);
         border-radius: 12px;
         padding: 1rem;
         max-width: 280px;
         min-width: 240px;
         max-height: 70vh;
         overflow-y: auto;
         z-index: 1001;
         box-shadow: 0 8px 32px rgba(0,0,0,0.12);
         opacity: 0;
         visibility: hidden;
         transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
         backdrop-filter: blur(8px);
         }
         .floating-toc.show {
         opacity: 1;
         visibility: visible;
         }
         .floating-toc-header {
         display: flex;
         align-items: center;
         justify-content: space-between;
         margin-bottom: 1rem;
         padding-bottom: 0.5rem;
         border-bottom: 1px solid var(--border-color);
         }
         .floating-toc-title {
         font-size: 0.875rem;
         font-weight: 600;
         color: var(--text-primary);
         display: flex;
         align-items: center;
         gap: 0.5rem;
         }
         .floating-toc-close {
         background: none;
         border: none;
         cursor: pointer;
         padding: 4px;
         border-radius: 4px;
         color: var(--text-secondary);
         transition: background-color 0.2s ease, color 0.2s ease;
         }
         .floating-toc-close:hover {
         background-color: var(--background-hover);
         color: var(--text-primary);
         }
         .floating-toc-list {
         list-style: none;
         padding: 0;
         margin: 0;
         }
         .floating-toc-item {
         margin-bottom: 0.5rem;
         }
         .floating-toc-link {
         display: block;
         padding: 0.5rem 0.75rem;
         text-decoration: none;
         color: var(--text-secondary);
         font-size: 0.8rem;
         line-height: 1.4;
         border-radius: 6px;
         transition: all 0.2s ease;
         cursor: pointer;
         position: relative;
         border-left: 3px solid transparent;
         }
         .floating-toc-link:hover {
         background-color: var(--background-hover);
         color: var(--text-primary);
         }
         .floating-toc-link.active {
         background-color: rgba(0, 113, 206, 0.1);
         color: var(--product-accent);
         border-left-color: var(--product-accent);
         font-weight: 500;
         }
         .floating-toc-progress {
         position: absolute;
         right: 0.5rem;
         top: 50%;
         transform: translateY(-50%);
         width: 20px;
         height: 20px;
         border-radius: 50%;
         background-color: var(--border-color);
         border: 2px solid var(--background-card);
         transition: all 0.2s ease;
         }
         .floating-toc-link.active .floating-toc-progress {
         background-color: var(--product-accent);
         }
         .floating-toc-progress-fill {
         position: absolute;
         top: 2px;
         left: 2px;
         right: 2px;
         bottom: 2px;
         border-radius: 50%;
         background-color: var(--product-accent);
         transform: scale(0);
         transition: transform 0.2s ease;
         }
         .floating-toc-link.reading .floating-toc-progress-fill {
         transform: scale(1);
         }
         .floating-toc-toggle {
         position: fixed;
         top: 50%;
         right: 20px;
         transform: translateY(-50%);
         background-color: var(--product-accent);
         color: var(--background-button-text);
         border: none;
         border-radius: 50%;
         width: 48px;
         height: 48px;
         display: flex;
         align-items: center;
         justify-content: center;
         cursor: pointer;
         z-index: 1002;
         box-shadow: 0 4px 16px rgba(0,0,0,0.15);
         opacity: 0;
         visibility: hidden;
         transition: all 0.3s ease;
         }
         .floating-toc-toggle.show {
         opacity: 1;
         visibility: visible;
         }
         .floating-toc-toggle:hover {
         background-color: var(--product-accent-hover);
         transform: translateY(-50%) scale(1.05);
         }
         /* --- FULL-SCREEN READING MODE --- */
         .fullscreen-reading-mode {
         position: fixed;
         top: 0;
         left: 0;
         right: 0;
         bottom: 0;
         background-color: var(--background-main);
         z-index: 2000;
         overflow-y: auto;
         padding: 2rem;
         opacity: 0;
         visibility: hidden;
         transition: opacity 0.3s ease, visibility 0.3s ease;
         }
         .fullscreen-reading-mode.active {
         opacity: 1;
         visibility: visible;
         }
         .fullscreen-reading-content {
         max-width: 800px;
         margin: 0 auto;
         line-height: 1.8;
         font-size: 1.1rem;
         color: var(--text-primary);
         }
         .fullscreen-reading-content h2 {
         font-size: 2rem;
         margin-bottom: 1.5rem;
         color: var(--text-primary);
         border-bottom: 2px solid var(--product-accent);
         padding-bottom: 0.5rem;
         }
         .fullscreen-reading-content h3 {
         font-size: 1.5rem;
         margin-top: 2rem;
         margin-bottom: 1rem;
         color: var(--text-primary);
         }
         .fullscreen-reading-content h4 {
         font-size: 1.25rem;
         margin-top: 1.5rem;
         margin-bottom: 0.75rem;
         color: var(--text-primary);
         }
         .fullscreen-reading-content p {
         margin-bottom: 1.5rem;
         text-align: justify;
         color: var(--text-secondary);
         }
         .fullscreen-reading-content table {
         margin: 2rem 0;
         font-size: 0.95rem;
         }
         .fullscreen-reading-controls {
         position: fixed;
         top: 20px;
         right: 20px;
         display: flex;
         gap: 0.5rem;
         z-index: 2001;
         }
         .fullscreen-reading-control {
         background-color: var(--background-card);
         border: 1px solid var(--border-color);
         border-radius: 8px;
         padding: 0.5rem;
         cursor: pointer;
         color: var(--text-secondary);
         transition: all 0.2s ease;
         backdrop-filter: blur(8px);
         }
         .fullscreen-reading-control:hover {
         background-color: var(--background-hover);
         color: var(--text-primary);
         }
         .fullscreen-reading-exit {
         background-color: var(--product-accent);
         color: var(--background-button-text);
         }
         .fullscreen-reading-exit:hover {
         background-color: var(--product-accent-hover);
         }
         .fullscreen-reading-progress {
         position: fixed;
         bottom: 20px;
         left: 50%;
         transform: translateX(-50%);
         background-color: var(--background-card);
         border: 1px solid var(--border-color);
         border-radius: 20px;
         padding: 0.5rem 1rem;
         font-size: 0.875rem;
         color: var(--text-secondary);
         backdrop-filter: blur(8px);
         z-index: 2001;
         }
         .fullscreen-font-controls {
         position: fixed;
         top: 20px;
         left: 20px;
         display: flex;
         gap: 0.5rem;
         z-index: 2001;
         }
         .fullscreen-font-control {
         background-color: var(--background-card);
         border: 1px solid var(--border-color);
         border-radius: 8px;
         padding: 0.5rem;
         cursor: pointer;
         color: var(--text-secondary);
         transition: all 0.2s ease;
         backdrop-filter: blur(8px);
         min-width: 40px;
         text-align: center;
         }
         .fullscreen-font-control:hover {
         background-color: var(--background-hover);
         color: var(--text-primary);
         }
         /* Hide UI elements when in fullscreen reading mode */
         body.fullscreen-reading .header,
         body.fullscreen-reading .product-header,
         body.fullscreen-reading .tab-navigation-container,
         body.fullscreen-reading .footer,
         body.fullscreen-reading .floating-toc,
         body.fullscreen-reading .floating-toc-toggle,
         body.fullscreen-reading #back-to-top,
         body.fullscreen-reading .reading-progress,
         body.fullscreen-reading .reading-progress-text {
         display: none !important;
         }
         /* Mobile adjustments for fullscreen reading */
         @media (max-width: 768px) {
         .fullscreen-reading-mode {
         padding: 1rem;
         }
         .fullscreen-reading-content {
         font-size: 1rem;
         line-height: 1.7;
         }
         .fullscreen-reading-controls {
         top: 10px;
         right: 10px;
         }
         .fullscreen-font-controls {
         top: 10px;
         left: 10px;
         }
         .fullscreen-reading-progress {
         bottom: 10px;
         padding: 0.4rem 0.8rem;
         font-size: 0.8rem;
         }
         }
         /* Hide TOC on smaller screens */
         @media (max-width: 1024px) {
         .floating-toc,
         .floating-toc-toggle {
         display: none !important;
         }
         }
         
         /* Mobile adjustments for reading progress */
         @media (max-width: 768px) {
         .reading-progress-text {
         right: 10px;
         top: 6px;
         font-size: 0.7rem;
         padding: 0.2rem 0.4rem;
         }
         }
         
         @media (max-width: 480px) {
         .reading-progress-text {
         right: 5px;
         top: 4px;
         font-size: 0.65rem;
         padding: 0.15rem 0.3rem;
         max-width: 120px;
         text-overflow: ellipsis;
         overflow: hidden;
         white-space: nowrap;
         }
         }
         /* --- MISC & FOOTER --- */
         .ai-disclaimer { text-align: center; font-style: italic; color: var(--text-secondary); font-size: 0.875rem; margin: -1rem auto -2rem; padding: 0 1rem; line-height: 1.5; }
         #back-to-top {
         position: fixed; bottom: 20px; left: 20px;
         background-color: var(--product-accent); color: var(--background-button-text);
         border: none; border-radius: 50%;
         width: 50px; height: 50px;
         display: none; align-items: center; justify-content: center;
         cursor: pointer; z-index: 1000;
         box-shadow: 0 4px 8px rgba(0,0,0,0.2);
         opacity: 0;
         transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s ease;
         }
         #back-to-top.show { opacity: 1; display: flex; }
         #back-to-top:hover { background-color: var(--product-accent-hover); transform: translateY(-2px); }
         .footer { background-color: var(--background-card); color: var(--text-secondary); padding: 2rem 1.5rem; margin-top: 4rem; text-align: center; border-top: 1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease;}
         .footer-container { max-width: 1440px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; gap: 1.5rem; }
         .footer-brand { display: flex; align-items: center; gap: 1rem; }
         .footer-logo { height: 32px; }
         .footer-wordmark { font-size: 1rem; font-weight: 500; color: var(--cgd-blue); }
         .footer-copyright { font-size: 0.8rem; }
         .footer-socials { display: flex; gap: 1rem; }
         .footer-socials a { color: var(--text-secondary); text-decoration: none; display: inline-block; transition: color 0.2s ease, transform 0.2s ease; }
         .footer-socials a:hover { color: var(--product-accent); transform: scale(1.1); }
         .footer-socials svg { width: 24px; height: 24px; fill: currentColor; }
         @media (max-width: 768px) {
         .content, .product-header { padding-left: 1rem; padding-right: 1rem; }
         .footer-container { flex-direction: column; text-align: center; gap: 1.5rem; }
         }
         @media print {
         /* Print styles remain largely the same */
         .header, .footer, .tab-navigation-container, .ai-disclaimer, #back-to-top, .header-controls { display: none !important; }
         }
      </style>
   </head>
   <body>
      <!-- Reading Progress Indicator -->
      <div id="reading-progress" class="reading-progress">
         <div id="reading-progress-fill" class="reading-progress-fill"></div>
      </div>
      <div id="reading-progress-text" class="reading-progress-text">
         0% read
      </div>
      
      <header class="header">
         <div class="header-container">
            <div class="header-brand">
               <img src="https://www.cgd.pt/PublishingImages/WSImages/Novo-CGD/logo-ap_Blue.png" alt="CGD Logo" class="header-logo">
            </div>
            <div class="header-controls">
               <div id="tts-controls" style="display: none;">
                  <button id="tts-play-pause-btn" class="icon-button" title="Listen to this section">
                  <span class="icon">play_arrow</span>
                  </button>
                  <button id="tts-stop-btn" class="icon-button" title="Stop listening">
                  <span class="icon">stop</span>
                  </button>
               </div>
               <button id="fullscreen-reading-btn" class="icon-button" title="Enter fullscreen reading mode">
               <span class="icon">fullscreen</span>
               </button>
               <button id="dark-mode-toggle" class="icon-button" title="Toggle dark/light mode">
               <span class="icon">light_mode</span>
               </button>
               <a href="mailto:david.alexandre.rosa@cgd.pt?subject=Support Request for Application Technical Profile&cc=dsi-arquitetura_empresarial@cgd.pt" target="_blank" class="support-button">Ask for Support</a>
            </div>
         </div>
         
         <!-- Breadcrumb Navigation integrated in header -->
         <div id="breadcrumb-container" class="breadcrumb-container">
            <nav class="breadcrumb" aria-label="Breadcrumb navigation">
               <a href="#" id="breadcrumb-home" class="breadcrumb-home" title="Go to overview">
                  <span class="icon">home</span>
                  <span>Overview</span>
               </a>
               <span class="breadcrumb-separator"></span>
               <div id="breadcrumb-current" class="breadcrumb-item">
                  <span class="breadcrumb-link active">Current Section</span>
               </div>
               <div class="breadcrumb-section-info">
                  <div class="breadcrumb-progress">
                     <span class="icon">trending_up</span>
                     <div class="breadcrumb-progress-bar">
                        <div id="breadcrumb-progress-fill" class="breadcrumb-progress-fill"></div>
                     </div>
                     <span id="breadcrumb-progress-text">0%</span>
                  </div>
                  <div id="breadcrumb-section-count">
                     Section 1 of 13
                  </div>
               </div>
            </nav>
         </div>
      </header>
      
      <div class="product-header">
         <h1 id="application-technical-profile">Application Technical Profile</h1>
         <p style="font-size: 16px">A structured and in-depth technical overview of the application, capturing key architectural elements, technology stack, system components, and more. This profile serves as a foundational reference for modernization, migration, and governance initiatives.</p>
         <div class="document-meta">
            <div class="read-time" id="total-read-time">
               <span class="icon">schedule</span>
               <span>Calculating...</span>
            </div>
         </div>
      </div>
      <div id="tab-container-placeholder"></div>
      
      <main class="content" id="main-content-area">
<div class="product-section"><h2 id="1-application-overview">1. Application overview</h2>
<p>This section provides high-level, application-level information,
extracted from the provided source code, including build files,
deployment scripts, and core application components.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Acronym</strong></td>
<td style="text-align: left;">SPDI / GIE</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Application name</strong></td>
<td style="text-align: left;">Servio de Produo de Documentos e
Impressos (SPDI) / Gesto de Impressos Electrnicos (GIE)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Primary business
purpose</strong></td>
<td style="text-align: left;">A comprehensive enterprise system for
managing the entire lifecycle of banking documents. This includes
template creation, dynamic PDF generation from data, a web portal (GIE)
for searching and retrieving documents and kits, and automated processes
for document archival, expiration, and rule-based regeneration.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Business domain</strong></td>
<td style="text-align: left;">Banking / Financial Services Document
Management</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Build files</strong></td>
<td style="text-align: left;">Multiple <code>pom.xml</code> files for a
multi-module Maven project. Key files include parent POM,
<code>ptsmBuildManagement/release-pom.xml</code>,
<code>spdiMdw-ejb/pom.xml</code>, and <code>gieWeb/pom.xml</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Module / Project definition
files</strong></td>
<td style="text-align: left;">5 modules identified:
<code>cmsMdw-ejb</code>, <code>spdiMdw-ejb</code>,
<code>spdiMdw-ear</code>, <code>spdiWeb</code>,
<code>gieWeb</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Files</strong></td>
<td style="text-align: left;">151 files analyzed: <br>- <strong>GitHub
Workflows (.yml):</strong> 3 <br>- <strong>Java source files
(.java):</strong> 87 <br>- <strong>Maven POMs (.xml):</strong> 8 <br>-
<strong>JBoss/Java EE Descriptors (.xml):</strong> 39 <br>-
<strong>XHTML Pages (.xhtml):</strong> 11 <br>- <strong>Properties files
(.properties):</strong> 3 <br>- <strong>Shell Scripts (.sh):</strong>
3</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Main programming
language(s)</strong></td>
<td style="text-align: left;"><span class="icon icon-check"
title="Yes/Used/Supported">check_circle</span> Java (1.6)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Target Java Version / Jakarta EE /
Java EE Version(s)</strong></td>
<td style="text-align: left;">- <strong>Java:</strong> 1.6 (specified in
<code>ptsmBuildManagement/pom.xml</code>) <br>- <strong>Java
EE:</strong> 5 (inferred from <code>application.xml</code> version=5
and <code>web.xml</code> schema version=2.5)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Application type</strong></td>
<td style="text-align: left;">Enterprise Application (EAR) composed of
EJB modules (business logic), Web modules (WARs for UI and APIs),
utilizing JBoss Seam and JSF.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Output type</strong></td>
<td style="text-align: left;">.ear (spdiMdw-ear), .war (gieWeb,
spdiWeb), .jar (spdiMdw-ejb, cmsMdw-ejb)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Deployment model</strong></td>
<td style="text-align: left;">On-premises (JBoss server)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Deployment target
platform</strong></td>
<td style="text-align: left;">JBoss EAP 5.x/6.x (inferred from Java EE
5/6 technologies, JBoss Seam 2.2, and deployment scripts).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Complexity</strong></td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Last updated (Source
code)</strong></td>
<td style="text-align: left;">2015-06-18</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Last updated
(Documentation)</strong></td>
<td style="text-align: left;">2025-07-18</td>
</tr>
</tbody>
</table></div>
<h3 id="11-main-components-and-features">1.1. Main components and
features</h3>
<p>This section describes the main components of the application, their
relationships, and key features. It provides a structured overview of
the applications architecture and functionality.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Component</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Key features</th>
<th style="text-align: left;">Dependencies</th>
<th style="text-align: left;">Related modules / archives</th>
<th style="text-align: left;">Technologies</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>GIE Web UI (gieWeb)</strong></td>
<td style="text-align: left;">The primary user-facing web application
for searching, viewing, and managing electronic documents and kits.</td>
<td style="text-align: left;">- Document and Kit Search <br>- Document
Download (single &amp; multiple) <br>- Kit Details Viewing <br>- Display
of Recently Added &amp; Discontinued Documents</td>
<td style="text-align: left;">JBoss Seam, JSF (RichFaces),
<code>spdiMdw-ejb</code> (via proxy)</td>
<td style="text-align: left;"><code>gieWeb.war</code></td>
<td style="text-align: left;">Java 1.6, JSF, JBoss Seam, RichFaces,
Tomahawk</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SPDI Middleware
(spdiMdw)</strong></td>
<td style="text-align: left;">The core backend service layer, containing
business logic for document template management, dynamic generation
(GFD), lifecycle, and integration with external systems.</td>
<td style="text-align: left;">- Document generation from templates <br>-
Document archival and regeneration <br>- Asynchronous processing (HAPB)
<br>- Data access and persistence</td>
<td style="text-align: left;">EJB, JPA (Hibernate), iText, JAX-WS,
JAX-RS</td>
<td style="text-align: left;"><code>spdiMdw-ear</code>,
<code>spdiMdw-ejb.jar</code>, <code>cmsMdw-ejb.jar</code></td>
<td style="text-align: left;">Java EE 5, EJB, JPA, Hibernate, iText</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Web Services Layer
(spdiWeb)</strong></td>
<td style="text-align: left;">Exposes application functionalities via
SOAP and REST APIs for consumption by other systems.</td>
<td style="text-align: left;">- SOAP endpoints for document operations
(<code>SpdiWsSoap</code>) <br>- REST endpoint for image retrieval
(<code>SpdiRestGetImage</code>)</td>
<td style="text-align: left;">JAX-WS (JBossWS), JAX-RS (Jersey),
<code>spdiMdw-ejb</code></td>
<td style="text-align: left;"><code>spdiWeb.war</code></td>
<td style="text-align: left;">JAX-WS, JAX-RS</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Document Generation
(GFD)</strong></td>
<td style="text-align: left;">A dedicated internal framework for
rendering PDF documents by merging templates with runtime data.</td>
<td style="text-align: left;">- Dynamic PDF generation from XML data
(<code>criaDoc</code>) <br>- PDF stamping and concatenation
(<code>PdfStampsTools</code>)</td>
<td style="text-align: left;">iText, xhtmlrenderer</td>
<td style="text-align: left;"><code>spdiMdw-ejb.jar</code></td>
<td style="text-align: left;">Java, iText, xhtmlrenderer</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Batch Document
Regeneration</strong></td>
<td style="text-align: left;">A subsystem responsible for identifying
and regenerating documents affected by changes to shared resources
(e.g., global texts, images).</td>
<td style="text-align: left;">- Identify affected documents <br>- Queue
documents for regeneration <br>- Process regeneration queue</td>
<td style="text-align: left;"><code>SpdiRegenBDHelper</code></td>
<td style="text-align: left;"><code>spdiMdw-ejb.jar</code></td>
<td style="text-align: left;">EJB, JPA, Hibernate</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Asynchronous Archival
(HAPB)</strong></td>
<td style="text-align: left;">A backend service that queues and
processes requests for document archival to an external system
(HAPB/Alnova).</td>
<td style="text-align: left;">- Queuing of archival requests via JMS
<br>- Retry mechanism for failed attempts <br>- Asynchronous processing
to avoid blocking user actions</td>
<td style="text-align: left;"><code>HapbAsyncQueueService</code></td>
<td style="text-align: left;"><code>spdiMdw-ejb.jar</code></td>
<td style="text-align: left;">EJB, JMS, Java Threads</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CI/CD Automation</strong></td>
<td style="text-align: left;">GitHub Actions pipelines for building,
testing, and deploying the application to different environments (CQ,
PR).</td>
<td style="text-align: left;">- Automated builds triggered by pushes
<br>- Artifact retrieval from Nexus <br>- Deployment to JBoss servers
via SSH/SCP <br>- Database script execution</td>
<td style="text-align: left;">GitHub Actions, Maven, Shell,
PowerShell</td>
<td style="text-align: left;"><code>.github/workflows/</code></td>
<td style="text-align: left;">YAML, Maven, Shell</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>flowchart TD
    subgraph &quot;CI/CD Pipeline&quot;
        direction LR
        GH_Actions[&quot;GitHub Actions&lt;br&gt;(pipeline-build-pdi.yml)&quot;]
        Nexus[&quot;Nexus Repository&lt;br&gt;(nexus.grupocgd.com)&quot;]
        InfraHub[&quot;InfraHub API&quot;]
        GH_Actions -- &quot;1. Triggers Build&quot; --&gt; InfraHub
        GH_Actions -- &quot;2. Manages Dependencies&quot; --&gt; Nexus
        GH_Actions -- &quot;3. Deploys Artifacts&quot; --&gt; Nexus
    end

    subgraph &quot;Application Components&quot;
        GieWeb[&quot;gieWeb.war&lt;br&gt;(JSF/Seam UI)&quot;]
        SpdiWeb[&quot;spdiWeb.war&lt;br&gt;(SOAP/REST APIs)&quot;]
        SpdiMdwEJB[&quot;spdiMdw-ejb.jar&lt;br&gt;(Business Logic, GFD)&quot;]
        CmsMdwEJB[&quot;cmsMdw-ejb.jar&lt;br&gt;(CMS Logic)&quot;]
        SpdiEar[&quot;spdiMdw-ear&lt;br&gt;(Enterprise Archive)&quot;]
    end
    
    subgraph &quot;Deployment Environment&quot;
        JBossFE[&quot;JBoss Server (Frontend)&lt;br&gt;uqc6001fea01, uqc6001fea02&quot;]
        JBossBE[&quot;JBoss Server (Backend)&lt;br&gt;uqc6001bea01, uqc6001bea02&quot;]
        OracleDB[&quot;Oracle Database&lt;br&gt;lqc6001sca07, lpc6001sca09&quot;]
    end

    subgraph &quot;External Systems&quot;
        Documentum[&quot;Documentum (Archive)&quot;]
        Alnova_HAPB[&quot;Alnova / HAPB (Core Banking)&quot;]
        LDAP[&quot;LDAP / Active Directory&quot;]
    end

    GieWeb -- &quot;EJB Calls&quot; --&gt; SpdiMdwEJB
    SpdiWeb -- &quot;EJB Calls&quot; --&gt; SpdiMdwEJB
    SpdiEar --&gt; JBossBE
    GieWeb --&gt; JBossFE
    SpdiWeb --&gt; JBossFE
    
    SpdiMdwEJB -- &quot;JPA/Hibernate&quot; --&gt; OracleDB
    CmsMdwEJB -- &quot;JPA/Hibernate&quot; --&gt; OracleDB
    SpdiMdwEJB -- &quot;SOAP API Calls&quot; --&gt; Documentum
    SpdiMdwEJB -- &quot;JMS Queue&quot; --&gt; Alnova_HAPB
    SpdiMdwEJB -- &quot;LDAP Queries&quot; --&gt; LDAP

    Nexus -- &quot;Deploys To&quot; --&gt; JBossFE
    Nexus -- &quot;Deploys To&quot; --&gt; JBossBE</code></pre>
<center>
Figure 1 - High-level component diagram showing the build, deployment,
and runtime relationships.
</center>
<h3 id="12-builds">1.2. Builds</h3>
<p>This section provides an overview of the primary build configurations
in the application, including the main build files and their associated
modules or subprojects. It serves as a reference for understanding how
the application is structured and built.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Build file</th>
<th style="text-align: left;">Modules (Maven) / Subprojects
(Gradle)</th>
<th style="text-align: left;">Primary IDE / Build Tool version</th>
</tr>
</thead>
<tbody>
<tr>
<td
style="text-align: left;"><code>ptsmBuildManagement/pom.xml</code></td>
<td style="text-align: left;">This is the parent POM for the entire
application. It defines dependency management and build configurations
inherited by other modules.</td>
<td style="text-align: left;">Apache Maven 3.0.5</td>
</tr>
<tr>
<td
style="text-align: left;"><code>ptsmBuildManagement/release-pom.xml</code></td>
<td style="text-align: left;">This POM aggregates the modules for a
release build. <br>- <code>cmsMdw-ejb</code> <br>-
<code>spdiMdw-ejb</code> <br>- <code>spdiMdw-ear</code> <br>-
<code>spdiWeb</code> <br>- <code>gieWeb</code></td>
<td style="text-align: left;">Apache Maven 3.0.5</td>
</tr>
<tr>
<td style="text-align: left;"><code>gieWeb/pom.xml</code></td>
<td style="text-align: left;">Defines the build for the
<code>gieWeb</code> WAR module.</td>
<td style="text-align: left;">Apache Maven 3.0.5</td>
</tr>
<tr>
<td style="text-align: left;"><code>spdiMdw-ejb/pom.xml</code></td>
<td style="text-align: left;">Defines the build for the
<code>spdiMdw-ejb</code> EJB module.</td>
<td style="text-align: left;">Apache Maven 3.0.5</td>
</tr>
<tr>
<td style="text-align: left;"><code>spdiWeb/pom.xml</code></td>
<td style="text-align: left;">Defines the build for the
<code>spdiWeb</code> WAR module.</td>
<td style="text-align: left;">Apache Maven 3.0.5</td>
</tr>
<tr>
<td style="text-align: left;"><code>spdiMdw-ear/pom.xml</code></td>
<td style="text-align: left;">Defines the build for the
<code>spdiMdw-ear</code> EAR module.</td>
<td style="text-align: left;">Apache Maven 3.0.5</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>mindmap
  root((spdiParent))
    ptsmBuildManagement
      release-pom.xml
        cmsMdw-ejb
        spdiMdw-ejb
        spdiMdw-ear
        spdiWeb
        gieWeb
    gieWeb
    spdiWeb
    spdiMdw-ejb
    cmsMdw-ejb
    spdiMdw-ear</code></pre>
<center>
Figure 2 - Build structure visualization.
</center>
<h3 id="13-modules">1.3. Modules</h3>
<p>This section provides a detailed overview of the individual modules
within the application, including their main objectives, types, output
packaging, and key components. It serves as a reference for
understanding the modular structure of the application and how each
module contributes to its overall functionality.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
<col style="width: 8%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Parent build file</th>
<th style="text-align: left;">Module Artifact Id (Maven) / Name
(Gradle)</th>
<th style="text-align: left;">Main objectives</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Output packaging</th>
<th style="text-align: left;">Version</th>
<th style="text-align: left;">Java version (Source / Target)</th>
<th style="text-align: left;">Jakarta EE / Java EE / Spring Version</th>
<th style="text-align: left;">Key configuration files</th>
<th style="text-align: left;">Principal classes / components</th>
<th style="text-align: left;">Internal dependencies (other modules)</th>
<th style="text-align: left;">External dependencies (key libraries)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>spdiParent</code></td>
<td style="text-align: left;"><code>gieWeb</code></td>
<td style="text-align: left;">Provides the web user interface for the
Electronic Forms Management (GIE) system. Handles user interactions for
searching, viewing, and downloading documents and kits.</td>
<td style="text-align: left;">Web Application Module (WAR)</td>
<td style="text-align: left;"><code>war</code></td>
<td style="text-align: left;">0.0.1-SNAPSHOT</td>
<td style="text-align: left;">1.6</td>
<td style="text-align: left;">Java EE 5, JBoss Seam</td>
<td style="text-align: left;"><code>web.xml</code>,
<code>faces-config.xml</code>, <code>pages.xml</code>,
<code>components.xml</code></td>
<td style="text-align: left;"><code>PesquisaGieDocsBean</code>,
<code>DetalhesKitGieBean</code>, <code>GieDocsBaseBean</code></td>
<td style="text-align: left;"><code>spdiCommons</code>,
<code>internalWebCore</code>, <code>internalJSFComponents</code></td>
<td style="text-align: left;"><code>richfaces-api</code>,
<code>richfaces-ui</code>, <code>seam-deps</code>,
<code>tomahawk</code>, <code>itextpdf</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>spdiParent</code></td>
<td style="text-align: left;"><code>spdiMdw-ejb</code></td>
<td style="text-align: left;">Contains the core business logic for the
Document and Forms Production Service (SPDI), including template
management, document generation (GFD), persistence, batch regeneration,
and integration with external systems.</td>
<td style="text-align: left;">EJB Module</td>
<td style="text-align: left;"><code>jar</code></td>
<td style="text-align: left;">0.0.1-SNAPSHOT</td>
<td style="text-align: left;">1.6</td>
<td style="text-align: left;">EJB, JPA, JMS</td>
<td style="text-align: left;"><code>ejb-jar.xml</code>,
<code>ehcache.xml</code></td>
<td style="text-align: left;"><code>SpdiHelper</code>,
<code>SpdiRegenBDHelper</code>, <code>GieService</code>,
<code>HapbAsyncQueueService</code>,
<code>TrxClientProcurarDocumentos</code></td>
<td style="text-align: left;"><code>spdiCommons</code></td>
<td style="text-align: left;"><code>hibernate-core</code>,
<code>jboss-ejb3-api</code>, <code>com.lowagie:itext</code>,
<code>org.beanshell:bsh</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>spdiParent</code></td>
<td style="text-align: left;"><code>cmsMdw-ejb</code></td>
<td style="text-align: left;">Contains business logic related to a
Content Management System (CMS), likely for managing templates or static
content.</td>
<td style="text-align: left;">EJB Module</td>
<td style="text-align: left;"><code>jar</code></td>
<td style="text-align: left;">0.0.1-SNAPSHOT</td>
<td style="text-align: left;">1.6</td>
<td style="text-align: left;">EJB, JPA</td>
<td style="text-align: left;"><code>ejb-jar.xml</code> (implicit)</td>
<td style="text-align: left;">N/A (code not provided)</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;"><code>hibernate-core</code>,
<code>jboss-ejb3-api</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>spdiParent</code></td>
<td style="text-align: left;"><code>spdiMdw-ear</code></td>
<td style="text-align: left;">Assembles the EJB modules
(<code>spdiMdw-ejb</code>, <code>cmsMdw-ejb</code>) and shared libraries
into a deployable Enterprise Archive (EAR).</td>
<td style="text-align: left;">Enterprise Application (EAR)</td>
<td style="text-align: left;"><code>ear</code></td>
<td style="text-align: left;">0.0.1-SNAPSHOT</td>
<td style="text-align: left;">1.6</td>
<td style="text-align: left;">Java EE 5</td>
<td style="text-align: left;"><code>application.xml</code>,
<code>jboss-app.xml</code>, <code>persistence.xml</code>,
<code>*-ds.xml</code></td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;"><code>spdiMdw-ejb</code>,
<code>cmsMdw-ejb</code></td>
<td style="text-align: left;"><code>itext</code>,
<code>itextpdf</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>spdiParent</code></td>
<td style="text-align: left;"><code>spdiWeb</code></td>
<td style="text-align: left;">Provides web-facing components, primarily
the SOAP and REST APIs for system-to-system integration. May also
contain an administrative or complementary UI.</td>
<td style="text-align: left;">Web Application Module (WAR)</td>
<td style="text-align: left;"><code>war</code></td>
<td style="text-align: left;">0.0.1-SNAPSHOT</td>
<td style="text-align: left;">1.6</td>
<td style="text-align: left;">Java EE 5, JBoss Seam, JAX-RS, JAX-WS</td>
<td style="text-align: left;"><code>web.xml</code>,
<code>faces-config.xml</code></td>
<td style="text-align: left;"><code>SpdiWsSoap</code>,
<code>GieWsSoap</code>, <code>SpdiRestGetImage</code></td>
<td style="text-align: left;"><code>spdiCommons</code>,
<code>internalWebCore</code>, <code>spdiMdw-ejb</code></td>
<td style="text-align: left;"><code>seam-deps</code>,
<code>jersey-server</code></td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>flowchart TD
    subgraph &quot;Enterprise Application (spdiMdw-ear)&quot;
        direction TB
        spdiMdw_ejb[&quot;spdiMdw-ejb.jar&lt;br&gt;Core Business Logic&quot;]
        cmsMdw_ejb[&quot;cmsMdw-ejb.jar&lt;br&gt;CMS Logic&quot;]
        libs[&quot;lib/ (Shared Libraries)&lt;br&gt;itext, etc.&quot;]
        
        spdiMdw_ejb --&gt; libs
        cmsMdw_ejb --&gt; libs
    end
    
    subgraph &quot;Web Applications (WARs)&quot;
        direction TB
        gieWeb[&quot;gieWeb.war&lt;br&gt;Main User Interface&quot;]
        spdiWeb[&quot;spdiWeb.war&lt;br&gt;APIs &amp; Secondary UI&quot;]
    end
    
    gieWeb -- &quot;EJB Invocations&quot; --&gt; spdiMdw_ejb
    spdiWeb -- &quot;EJB Invocations&quot; --&gt; spdiMdw_ejb
    
    subgraph &quot;Deployment&quot;
        JBoss[&quot;JBoss Application Server&quot;]
        spdiMdw_ear --&gt; JBoss
        gieWeb --&gt; JBoss
        spdiWeb --&gt; JBoss
    end</code></pre>
<center>
Figure 3 - Module dependency and packaging structure.
</center>
</div>
<div class="product-section"><h2 id="2-functional-overview">2. Functional overview</h2>
<p>This section provides a high-level functional decomposition of the
application, using table format. It identifies the major, distinct
functional blocks or modules as inferred from the codes high-level
structure (e.g., top-level namespaces, solution folders, primary class
groups). This overview serves as a map to the applications core
responsibilities.</p>
<h3 id="21-executive-summary">2.1. Executive summary</h3>
<p>This section provides a high-level summary of the applications
primary purpose and its core function from a business or operational
perspective. The summary is an inference based on the main entry points
of the code, the names of the most central classes and modules, and the
nature of the core processes identified. It answers the fundamental
question: What primary problem does this application solve?</p>
<p>The <strong>SPDI/GIE</strong> application is a comprehensive
enterprise system designed for <strong>Caixa Geral de Depsitos
(CGD)</strong> to centralize and automate the entire lifecycle of
institutional and client-facing documents. Its primary function is to
serve as the single source of truth for document production and
management.</p>
<p>The <strong>SPDI (Sistema de Produo de Documentos de
Informao)</strong> backend handles the core logic: defining document
templates with complex business metadata, dynamically generating PDFs by
merging templates with data, and managing document states (archival,
deletion). A key feature is its ability to perform mass, rule-based
regeneration of documents when shared resources (like logos or legal
texts) are updated.</p>
<p>The <strong>GIE (Gesto de Impressos Electrnicos)</strong> frontend
provides the primary user-facing web portal. It allows bank employees to
search for, view, and download individual documents or pre-defined
Kits (collections of documents). It also provides interfaces for
administrators to manage templates and permissions.</p>
<p>Together, SPDI/GIE provides an end-to-end solution for ensuring
document consistency, compliance, and accessibility across the
organization.</p>
<h3 id="22-functional-decomposition">2.2. Functional decomposition</h3>
<p>This section provides a detailed breakdown of the applications
functional areas or modules, inferred from the code structure. Each
module is described in terms of its primary responsibilities and how it
contributes to the overall functionality of the application.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Functional Area / Module</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Primary Classes / Components</th>
<th style="text-align: left;">Key Responsibilities</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>User Interaction &amp;
Presentation (gieWeb)</strong></td>
<td style="text-align: left;">Manages all user-facing interfaces,
handles user input for searches, and renders document lists and details.
It serves as the primary gateway for users to interact with the document
management system.</td>
<td style="text-align: left;"><code>PesquisaGieDocsBean</code>,
<code>PesquisaGieKitsBean</code>, <code>DetalhesKitGieBean</code>,
<code>*.xhtml</code> pages, <code>*.jpdl.xml</code> files</td>
<td style="text-align: left;">- Render search forms and result tables.
<br>- Handle user actions like searching, sorting, and pagination. <br>-
Orchestrate multi-step user workflows using jBPM. <br>- Initiate
document and kit download processes.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Core Business Logic
(spdiMdw-ejb)</strong></td>
<td style="text-align: left;">Encapsulates the central business rules
for document lifecycle, generation, and state management. This layer
contains the EJB services that are invoked by the web tier and external
APIs.</td>
<td style="text-align: left;"><code>SpdiHelper</code>,
<code>GieService</code>, <code>BKOGfdService</code>,
<code>HapbAsyncQueueService</code></td>
<td style="text-align: left;">- Process search queries and retrieve data
from the database. <br>- Manage the lifecycle of documents (creation,
archival, state changes). <br>- Assemble and merge PDF documents for kit
downloads. <br>- Interact with external systems like Documentum and
HAPB.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Template &amp; Metadata
Management</strong></td>
<td style="text-align: left;">Manages the definition, association, and
lifecycle of document templates and their business metadata.</td>
<td style="text-align: left;"><code>SpdiGenericosHelper</code>,
<code>SpdiToGfdHelper</code>, <code>SpdTemplateGfd</code>,
<code>SpdReferenciasMetadados</code></td>
<td style="text-align: left;">- Create, edit, and delete template
associations. <br> - Define metadata (family, product, contract,
currency) for documents. <br> - Manage template states (New, Edition,
Production, Expired).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Document Generation &amp;
Rendering</strong></td>
<td style="text-align: left;">The core engine that generates final
documents, primarily PDFs, by merging templates with data.</td>
<td style="text-align: left;"><code>SpdiGeraPdfsHelper</code>,
<code>DocGenerator</code> hierarchy, <code>iText</code>,
<code>xhtmlrenderer</code></td>
<td style="text-align: left;">- Generate PDFs from structured XML data.
<br> - Render HTML/CSS content into PDFs. <br> - Stamp maquettes,
footers, and headers onto existing PDFs.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Batch Document
Regeneration</strong></td>
<td style="text-align: left;">A batch-oriented subsystem responsible for
identifying and regenerating documents affected by changes to shared
resources.</td>
<td style="text-align: left;"><code>SpdiRegenBDHelper</code>,
<code>SpdRegenDocumentosGie</code>,
<code>SpdRegenDocumentosSpdi</code></td>
<td style="text-align: left;">- Identify all documents using a specific
global text or image. <br> - Create regeneration requests in a queue
table. <br> - Process regeneration requests to create new document
versions.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Web Services &amp; API Layer
(spdiWeb)</strong></td>
<td style="text-align: left;">Exposes SPDI functionalities to other
applications via SOAP and REST protocols.</td>
<td style="text-align: left;"><code>SpdiWsSoap</code>,
<code>GieWsSoap</code>, <code>SpdiRestGetImage</code></td>
<td style="text-align: left;">- Provide SOAP endpoints for creating
metadata, generating documents, and querying data. <br> - Provide a REST
endpoint for retrieving images.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CI/CD &amp; Deployment
Automation</strong></td>
<td style="text-align: left;">Defines the automated processes for
building the application from source code and deploying it to the
various JBoss server environments.</td>
<td style="text-align: left;"><code>pipeline-build-pdi.yml</code>,
<code>pipeline-deploy-aplicacional.yml</code>, <code>pom.xml</code></td>
<td style="text-align: left;">- Compile Java code and package modules
(<code>.war</code>, <code>.ear</code>). <br>- Manage dependencies using
Maven and Nexus. <br>- Automate deployment to Quality and Production
servers. <br>- Execute database scripts (<code>.sql</code>).</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>graph TD
    UI[&quot;User Interaction &amp; Presentation&lt;br&gt;(gieWeb)&quot;]
    API[&quot;Web Services &amp; API Layer&lt;br&gt;(spdiWeb)&quot;]
    BL[&quot;Core Business Logic&lt;br&gt;(spdiMdw-ejb)&quot;]
    TPL[&quot;Template &amp; Metadata Mgmt&quot;]
    GEN[&quot;Document Generation &amp; Rendering&quot;]
    REGEN[&quot;Batch Document Regeneration&quot;]
    DP[&quot;Data Persistence &amp; Management&lt;br&gt;(JPA/Hibernate)&quot;]
    CICD[&quot;CI/CD &amp; Deployment Automation&lt;br&gt;(GitHub Actions)&quot;]
    DB[&quot;Oracle Database&quot;]
    Ext[&quot;External Systems&lt;br&gt;(Documentum, HAPB, LDAP)&quot;]
    
    UI -- &quot;Invokes&quot; --&gt; BL
    API -- &quot;Invokes&quot; --&gt; BL
    BL -- &quot;Uses&quot; --&gt; TPL
    BL -- &quot;Uses&quot; --&gt; GEN
    BL -- &quot;Uses&quot; --&gt; REGEN
    BL -- &quot;Uses&quot; --&gt; DP
    BL -- &quot;Interacts with&quot; --&gt; Ext
    DP -- &quot;Reads/Writes&quot; --&gt; DB
    CICD -- &quot;Builds &amp; Deploys&quot; --&gt; UI
    CICD -- &quot;Builds &amp; Deploys&quot; --&gt; API
    CICD -- &quot;Builds &amp; Deploys&quot; --&gt; BL
    CICD -- &quot;Executes Scripts On&quot; --&gt; DB</code></pre>
<center>
Figure 4 - Functional decomposition of the application.
</center>
<h3 id="23-user-roles-and-permissions">2.3. User roles and
permissions</h3>
<p>This section identifies all distinct types of users that interact
with the application, as inferred from the security implementation.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Role</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Permissions</th>
<th style="text-align: left;">Key Actions</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Template
Administrator</strong></td>
<td style="text-align: left;">A user responsible for creating, managing,
and publishing document templates and their metadata.</td>
<td style="text-align: left;">Create, Read, Update, Delete on template
and metadata entities. Publish templates to production.</td>
<td style="text-align: left;"><code>criaMetadados</code>,
<code>adicionaAssociacaoGenerico</code>,
<code>defineEstadoTemplate</code></td>
<td style="text-align: left;"><code>SpdTemplateGfd</code>,
<code>SpdGcdMetadados</code>, <code>SpdReferenciasMetadados</code></td>
<td style="text-align: left;">Inferred from methods that create or
modify template structures and the <code>criarTemplate.jpdl.xml</code>
pageflow.</td>
<td style="text-align: left;">This is a power-user role, critical for
the systems operation.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Back-Office Operator (GIE
User)</strong></td>
<td style="text-align: left;">A standard user who performs day-to-day
document operations, such as searching, viewing, and generating
documents.</td>
<td style="text-align: left;">Read-only access to most documents and
kits. Execute document generation and archival processes.</td>
<td style="text-align: left;">- Search and download documents/kits <br>
- <code>criaDoc</code>, <code>arquivaDoc</code></td>
<td style="text-align: left;"><code>SpdGieDocsFE</code>,
<code>SpdGieKit</code>, <code>SpdGcdDados</code></td>
<td style="text-align: left;">This role encompasses the GIE User
(Read-Only) and some Write functionalities for document
instances.</td>
<td style="text-align: left;">These users are the primary consumers of
the document generation and retrieval services.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>System Administrator</strong></td>
<td style="text-align: left;">A user with high-level privileges,
responsible for system maintenance, batch processes, and managing global
resources and user permissions.</td>
<td style="text-align: left;">Trigger global document regeneration.
Manage system-level configurations and user profiles.</td>
<td
style="text-align: left;"><code>criaPedidosRegeneracaoDocsGie</code>,
Manage users/groups via <code>prf.pages.xml</code> flows.</td>
<td style="text-align: left;"><code>SpdRegenDocumentosGie</code>,
<code>GfdGlobalTexts</code>, <code>User</code>, <code>Group</code></td>
<td style="text-align: left;">Inferred from the existence of batch
regeneration helpers and the user/permission management UI flows.</td>
<td style="text-align: left;">This role ensures system consistency and
manages access control.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Automated System / Service
User</strong></td>
<td style="text-align: left;">An autonomous system or background process
that interacts with the application.</td>
<td style="text-align: left;">Permissions to execute specific
system-level tasks without direct user interaction.</td>
<td
style="text-align: left;"><code>TemplateExpirationThread.execute</code>,
<code>HapbAsyncQueueService.inserirNovoItem</code>, Process regeneration
queue.</td>
<td style="text-align: left;"><code>SpdTemplateGfd</code>,
<code>HapbAsyncQueueItem</code>, <code>SpdRegenDocumentosGie</code></td>
<td style="text-align: left;">Inferred from background threads and
message-driven services.</td>
<td style="text-align: left;">These are not human users but are critical
actors within the systems operational workflows.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>classDiagram
    class User {
        +username: string
        +roles: Set~string~
    }
    class TemplateAdministrator {
        &lt;&lt;Role&gt;&gt;
    }
    class BackOfficeOperator {
        &lt;&lt;Role&gt;&gt;
    }
    class SystemAdministrator {
        &lt;&lt;Role&gt;&gt;
    }
    class AutomatedSystem {
        &lt;&lt;Role&gt;&gt;
    }

    User &lt;|-- TemplateAdministrator
    User &lt;|-- BackOfficeOperator
    User &lt;|-- SystemAdministrator

    TemplateAdministrator ..&gt; SpdTemplateGfd : &quot;Manages&quot;
    BackOfficeOperator ..&gt; SpdGieDocsFE : &quot;Searches &amp; Downloads&quot;
    BackOfficeOperator ..&gt; SpdGcdDados : &quot;Creates Instances Of&quot;
    SystemAdministrator ..&gt; SpdRegenDocumentosGie : &quot;Manages&quot;
    AutomatedSystem ..&gt; SpdTemplateGfd : &quot;Expires&quot;
    AutomatedSystem ..&gt; HapbAsyncQueueItem : &quot;Processes&quot;

    class SpdTemplateGfd { &lt;&lt;Entity&gt;&gt; }
    class SpdGieDocsFE { &lt;&lt;Entity&gt;&gt; }
    class SpdGcdDados { &lt;&lt;Entity&gt;&gt; }
    class SpdRegenDocumentosGie { &lt;&lt;Entity&gt;&gt; }
    class HapbAsyncQueueItem { &lt;&lt;Entity&gt;&gt; }</code></pre>
<center>
Figure 5 - User roles and their interactions with key data entities.
</center>
<h3 id="24-core-business-capabilities">2.4. Core business
capabilities</h3>
<p>This section lists the main, high-level capabilities of the
application, representing its major functional domains.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Capability</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Key Features</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Document Template &amp; Metadata
Management</strong></td>
<td style="text-align: left;">The complete set of functions related to
designing, defining, and managing document templates and their
associated business rules and metadata.</td>
<td style="text-align: left;">- Create/Edit Metadata
(<code>criaMetadados</code>) <br> - Associate Templates with Business
Contexts (<code>adicionaAssociacaoGenerico</code>) <br> - Template
Versioning &amp; Lifecycle (<code>SpdiTemplateEstados</code>)</td>
<td style="text-align: left;"><code>SpdTemplateGfd</code>,
<code>SpdGcdMetadados</code>, <code>SpdReferenciasMetadados</code></td>
<td style="text-align: left;">Inferred from helper classes and DAOs
dedicated to manipulating template entities.</td>
<td style="text-align: left;">This capability forms the foundation of
the entire system.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Dynamic Document
Generation</strong></td>
<td style="text-align: left;">The core capability of creating PDF
documents on-demand by merging a specific template with provided
data.</td>
<td style="text-align: left;">- On-demand PDF Generation
(<code>criaDoc</code>) <br> - PDF Generation from Static Files
(<code>geraDocGieEstatico</code>) <br> - PDF Stamping and Merging
(<code>PdfStampsTools</code>)</td>
<td style="text-align: left;"><code>SpdGcdDados</code>,
<code>SpdGieDocumentos</code>, <code>GfdTemplateVersions</code></td>
<td style="text-align: left;">Inferred from <code>SpdiHelper</code> and
the <code>com.cgd.general.services.gfd.docgenerator</code> package.</td>
<td style="text-align: left;">This is the primary runtime function of
the application.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Document Search and
Discovery</strong></td>
<td style="text-align: left;">The complete set of functions related to
finding and retrieving documents and document kits from the
repository.</td>
<td style="text-align: left;">- Metadata-based search (category, area,
company, etc.) <br> - Keyword search on document titles and
descriptions. <br> - Viewing lists of recent and discontinued
documents.</td>
<td style="text-align: left;"><code>SpdGieDocsFE</code>,
<code>SpdGieKit</code>, <code>SpdGieReferencias</code></td>
<td style="text-align: left;">Inferred from classes like
<code>PesquisaGieDocsBean</code> and
<code>PesquisaGieKitsBean</code>.</td>
<td style="text-align: left;">This is the primary user-facing capability
of the GIE application.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Global Document
Regeneration</strong></td>
<td style="text-align: left;">A system-wide process to automatically
update documents when a shared resource (like a global text or image) is
modified.</td>
<td style="text-align: left;">- Identify Affected Documents <br> - Queue
Documents for Regeneration (<code>criaPedidosRegeneracaoDocsGie</code>)
<br> - Batch Processing of Regeneration Queue</td>
<td style="text-align: left;"><code>SpdRegenDocumentosGie</code>,
<code>SpdRegenDocumentosSpdi</code>, <code>GfdGlobalTexts</code></td>
<td style="text-align: left;">Inferred from the
<code>SpdiRegenBDHelper</code> class.</td>
<td style="text-align: left;">This ensures document consistency and
automates a massive manual task.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Document Kit
Management</strong></td>
<td style="text-align: left;">The ability to group multiple related
documents into a single kit for a business process and download them
as a merged PDF.</td>
<td style="text-align: left;">- Kit Definition (<code>SpdGieKit</code>)
<br> - Association of SPDI and external documents <br> - On-the-fly PDF
merging for Kit downloads.</td>
<td style="text-align: left;"><code>SpdGieKit</code>,
<code>SpdGieKitRefs</code>, <code>SpdGieKitDdocs</code></td>
<td style="text-align: left;">Inferred from
<code>DetalhesKitGieBean</code> and
<code>GieWsSoap.consultaKit</code>.</td>
<td style="text-align: left;">This supports complex business processes
that require a collection of documents.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CI/CD Automation</strong></td>
<td style="text-align: left;">The end-to-end automated process of
building the application from source code, managing dependencies, and
deploying it to various server environments.</td>
<td style="text-align: left;">- Automated build using Maven. <br>-
Dependency management via Nexus. <br>- Automated deployment to JBoss
servers. <br>- Automated execution of SQL scripts.</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">Inferred from the GitHub Actions workflow
files (<code>.yml</code>).</td>
<td style="text-align: left;">This capability is crucial for operational
efficiency and reliable delivery.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>quadrantChart
    title &quot;Core Business Capabilities&quot;
    x-axis &quot;Technical Focus&quot; --&gt; &quot;User-Facing Focus&quot;
    y-axis &quot;Configuration &amp; Design&quot; --&gt; &quot;Runtime &amp; Execution&quot;
    quadrant-1 &quot;User Interaction &amp; Search&quot;
    quadrant-2 &quot;System Setup &amp; Design&quot;
    quadrant-3 &quot;Backend Processing&quot;
    quadrant-4 &quot;Operational Automation&quot;
    &quot;Document Search and Discovery&quot;: [0.8, 0.8]
    &quot;Document Kit Management&quot;: [0.7, 0.7]
    &quot;Dynamic Document Generation&quot;: [0.6, 0.6]
    &quot;Document Template &amp; Metadata Management&quot;: [0.3, 0.2]
    &quot;Global Document Regeneration&quot;: [0.2, 0.3]
    &quot;CI/CD Automation&quot;: [0.1, 0.1]</code></pre>
<center>
Figure 6 - Quadrant chart of core business capabilities.
</center>
<h3 id="25-detailed-feature-breakdown">2.5. Detailed feature
breakdown</h3>
<p>This section provides a granular breakdown of individual features
within each Core Business Capability.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Feature</th>
<th style="text-align: left;">User Story / Description</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Create/Edit Metadata
Template</strong></td>
<td style="text-align: left;">As a <em>Template Administrator</em>, I
can define or modify the structure and metadata for a document type, so
that it can be used for generating consistent documents. This involves
specifying fields, data types, and business context
(<code>criaMetadados</code>, <code>editaAssociacaoGenerico</code>).</td>
<td style="text-align: left;"><code>SpdGcdMetadados</code>,
<code>SpdReferenciasMetadados</code>, <code>SpdTemplateGfd</code></td>
<td style="text-align: left;">Assumes a UI exists for administrators to
perform these actions, which then call the backend EJB services.</td>
<td style="text-align: left;">This is a foundational setup feature.
Errors here will propagate to all documents generated from the
template.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Generate On-Demand
Document</strong></td>
<td style="text-align: left;">As a <em>Back-Office Operator</em> or
<em>System</em>, I can request the generation of a document by providing
its unique reference data, so that I receive a URL to the final PDF
(<code>criaDoc</code>). The system validates the data against the
production template before generation.</td>
<td style="text-align: left;"><code>SpdGcdDados</code>,
<code>SpdDocumentosUrls</code>, <code>SpdReferenciasDados</code></td>
<td style="text-align: left;">Assumes the input data is provided in a
structured format (XML) that matches the templates metadata.</td>
<td style="text-align: left;">This is the main transactional feature of
the application, used for real-time document creation.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Download Document
Kit</strong></td>
<td style="text-align: left;">As a GIE User, I can select multiple
documents from a Kits detail page and download them as a single, merged
PDF file.</td>
<td style="text-align: left;"><code>SpdGieKit</code>,
<code>SpdGieKitDdocs</code></td>
<td style="text-align: left;">Inferred from the
<code>downloadSelecao()</code> method in
<code>DetalhesKitGieBean</code>, which calls a proxy to merge multiple
documents.</td>
<td style="text-align: left;">This is a complex feature that involves
retrieving multiple binaries and merging them on the server before
streaming to the user.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Queue Documents for
Regeneration</strong></td>
<td style="text-align: left;">As a <em>System Administrator</em>, when a
global resource is updated, I can trigger a process to find all affected
documents and queue them for regeneration
(<code>criaPedidosRegeneracaoDocsGie</code>).</td>
<td style="text-align: left;"><code>SpdGieDocumentos</code>,
<code>SpdRegenDocumentosGie</code>, <code>GfdGlobalTexts</code></td>
<td style="text-align: left;">Assumes the system can trace dependencies
from global resources to specific document instances.</td>
<td style="text-align: left;">This feature is the first step in the
automated batch regeneration workflow.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Process Regeneration
Queue</strong></td>
<td style="text-align: left;">As an <em>Automated System</em>, I can
process queued regeneration requests one by one, creating a new version
of each document with the updated resources
(<code>regeneraDocumentoGie</code>).</td>
<td style="text-align: left;"><code>SpdRegenDocumentosGie</code>,
<code>SpdGieDocumentos</code></td>
<td style="text-align: left;">Assumes a background job (MDB or
Scheduler) is responsible for invoking this logic.</td>
<td style="text-align: left;">This is the execution part of the
regeneration workflow, ensuring eventual consistency of all
documents.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Expire Obsolete
Templates</strong></td>
<td style="text-align: left;">As an <em>Automated System</em>, I can
periodically check for and deactivate templates that have passed their
expiration date (<code>TemplateExpirationThread</code>).</td>
<td style="text-align: left;"><code>SpdTemplateGfd</code></td>
<td style="text-align: left;">Assumes a scheduled job runs this thread
to perform cleanup.</td>
<td style="text-align: left;">This is a system maintenance feature to
prevent the use of outdated templates.</td>
</tr>
</tbody>
</table></div>
<h3 id="26-key-data-entities-and-their-attributes">2.6. Key data
entities and their attributes</h3>
<p>This section documents the applications core data structures, as
inferred from the Java entity classes.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Entity</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Key Attributes</th>
<th style="text-align: left;">Data Type</th>
<th style="text-align: left;">Validation Rules</th>
<th style="text-align: left;">Relationships</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>SpdTemplateGfd</strong></td>
<td style="text-align: left;">Represents a document template managed by
the GFD. It holds the version, state, and links to metadata.</td>
<td style="text-align: left;"><code>templateGfdId</code>,
<code>templateVersion</code>, <code>estadoTemplate</code>,
<code>dataExpiracao</code></td>
<td style="text-align: left;">Long, Short, Short, Date</td>
<td style="text-align: left;"><code>estadoTemplate</code> must be one of
the defined states in <code>SpdiTemplateEstados</code>.</td>
<td style="text-align: left;">Many-to-One with
<code>SpdGcdMetadados</code>.</td>
<td style="text-align: left;">This entity is central to the entire
document generation process.</td>
<td style="text-align: left;">Its state (<code>PRODUCAO</code>,
<code>EDICAO</code>) controls its availability.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SpdGcdMetadados</strong></td>
<td style="text-align: left;">Stores the metadata definition for a
document template, including fields and validation rules, in an XML
structure.</td>
<td style="text-align: left;"><code>gcdMetadadosId</code>,
<code>xmlStruct</code></td>
<td style="text-align: left;">Long, String (CLOB)</td>
<td style="text-align: left;"><code>xmlStruct</code> contains the
well-formed XML definition.</td>
<td style="text-align: left;">One-to-One with
<code>SpdReferenciasMetadados</code>.</td>
<td style="text-align: left;">This holds the schema for a document
type.</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><strong>SpdGieDocumentos</strong></td>
<td style="text-align: left;">Represents a single electronic document
version with its metadata and lifecycle information within the GIE
system.</td>
<td style="text-align: left;"><code>gieDocumentosId</code>,
<code>versao</code>, <code>dataInicio</code>, <code>dataFim</code>,
<code>spdiEstados</code></td>
<td style="text-align: left;">Long, String, Date, Date, Short</td>
<td style="text-align: left;"><code>gieDocumentosId</code> is the
primary key.</td>
<td style="text-align: left;">Many-to-one with
<code>SpdGieReferencias</code>.</td>
<td style="text-align: left;">This is the central entity for a document
instance visible in the GIE portal.</td>
<td style="text-align: left;">Its state determines its visibility and
behavior.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SpdGieKit</strong></td>
<td style="text-align: left;">Represents a collection or Kit of
related documents.</td>
<td style="text-align: left;"><code>gieKitId</code>,
<code>codigo</code>, <code>designacao</code>, <code>ativo</code></td>
<td style="text-align: left;">Long, String, String, boolean</td>
<td style="text-align: left;"><code>codigo</code> is a unique business
key (e.g., K0001).</td>
<td style="text-align: left;">One-to-many with
<code>SpdGieKitRefs</code> and <code>SpdGieKitDdocs</code>.</td>
<td style="text-align: left;">A Kit is a primary way for users to find
and download document packages.</td>
<td style="text-align: left;">The <code>ativo</code> flag controls its
visibility.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>SpdGcdDados</strong></td>
<td style="text-align: left;">Represents a specific instance of a
generated document, containing the actual data used for generation and
the resulting PDF binary.</td>
<td style="text-align: left;"><code>gcdDadosId</code>, <code>pdf</code>,
<code>xmlStruct</code>, <code>simulacao</code></td>
<td style="text-align: left;">Long, String (CLOB/BLOB), String (CLOB),
boolean</td>
<td style="text-align: left;"><code>gcdDadosId</code> is the primary
key.</td>
<td style="text-align: left;">Many-to-One with
<code>SpdReferenciasDados</code>.</td>
<td style="text-align: left;">This entity stores the filled-in form
and the final output.</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td
style="text-align: left;"><strong>SpdRegenDocumentosGie</strong></td>
<td style="text-align: left;">A request record to regenerate a specific
<code>SpdGieDocumentos</code>. These records act as a queue for the
batch regeneration process.</td>
<td style="text-align: left;"><code>gieRegenId</code>,
<code>emTratamento</code>, <code>erro</code></td>
<td style="text-align: left;">Long, boolean, String</td>
<td style="text-align: left;"><code>gieRegenId</code> is the primary
key.</td>
<td style="text-align: left;">One-to-One with
<code>SpdGieDocumentos</code>.</td>
<td style="text-align: left;">This entity drives the automated document
update workflow.</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><strong>HapbAsyncQueueItem</strong></td>
<td style="text-align: left;">Represents a single asynchronous request
for document archival in the HAPB system.</td>
<td style="text-align: left;"><code>id</code>, <code>estado</code>,
<code>nrTentativas</code>, <code>invokeMethod</code></td>
<td style="text-align: left;">Long, char, int, String</td>
<td style="text-align: left;">State is managed by the
<code>HapbAsyncQueueThread</code>.</td>
<td style="text-align: left;">Many-to-one with
<code>SpdReferenciasDados</code>.</td>
<td style="text-align: left;">This entity enables a reliable,
asynchronous integration pattern.</td>
<td style="text-align: left;">The <code>nrTentativas</code> attribute
suggests a built-in retry mechanism.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>erDiagram
    SpdTemplateGfd {
        long templateGfdId PK
        short templateVersion
        short estadoTemplate
    }
    SpdGcdMetadados {
        long gcdMetadadosId PK
        string xmlStruct
    }
    SpdReferenciasMetadados {
        long refMetadadosId PK
        string familia
        string produto
    }
    SpdGieDocumentos {
        long gieDocumentosId PK
        string versao
        date dataInicio
        date dataFim
    }
    SpdGieReferencias {
        long gieReferenciasId PK
        string numero
    }
    SpdGcdDados {
        long gcdDadosId PK
        string pdf
        boolean simulacao
    }
    SpdRegenDocumentosGie {
        long gieRegenId PK
        boolean emTratamento
    }
    SpdGieKit {
        long gieKitId PK
        string codigo
    }
    SpdGieKitRefs {
        long gieKitRefsId PK
    }
    SpdGieKitDdocs {
        long gieKitDdocsId PK
    }

    SpdGcdMetadados ||--|{ SpdTemplateGfd : &quot;defines&quot;
    SpdReferenciasMetadados ||--|| SpdGcdMetadados : &quot;is for&quot;
    SpdTemplateGfd ||--o{ SpdGieDocumentos : &quot;is used by&quot;
    SpdGieReferencias ||--o{ SpdGieDocumentos : &quot;has versions&quot;
    SpdGieDocumentos ||--o{ SpdRegenDocumentosGie : &quot;has regeneration request&quot;
    SpdReferenciasMetadados ||--o{ SpdGcdDados : &quot;is data for&quot;
    SpdGieKit ||--o{ SpdGieKitRefs : &quot;contains&quot;
    SpdGieReferencias ||--o{ SpdGieKitRefs : &quot;is part of&quot;
    SpdGieKit ||--o{ SpdGieKitDdocs : &quot;contains external&quot;</code></pre>
<center>
Figure 7 - Entity Relationship Diagram for core SPDI/GIE entities.
</center>
<h3 id="27-business-process-workflows">2.7. Business process
workflows</h3>
<p>This section describes and visualizes critical end-to-end processes,
showing how different user roles and system features interact.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Workflow ID</th>
<th style="text-align: left;">Workflow Name</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Key Steps</th>
<th style="text-align: left;">User Roles Involved</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>BPW-001</strong></td>
<td style="text-align: left;">New Document Template Onboarding</td>
<td style="text-align: left;">The end-to-end process of defining a new
document type, creating its template, and making it available for
production use.</td>
<td style="text-align: left;">1. Define Metadata
(<code>criaMetadados</code>) <br> 2. Create Template
(<code>criaTemplate</code>) <br> 3. Associate Template with Context
(<code>adicionaAssociacaoGenerico</code>) <br> 4. Publish Template
(<code>defineEstadoTemplate</code>)</td>
<td style="text-align: left;">Template Administrator</td>
<td style="text-align: left;"><code>SpdGcdMetadados</code>,
<code>SpdTemplateGfd</code>, <code>SpdReferenciasMetadados</code></td>
<td style="text-align: left;">A UI-driven process where the
administrator provides the necessary metadata and configuration.</td>
<td style="text-align: left;">This is a setup workflow that must be
completed before any documents of this type can be generated.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>BPW-002</strong></td>
<td style="text-align: left;">On-Demand PDF Generation</td>
<td style="text-align: left;">The process of a user or system requesting
and receiving a single PDF document based on a specific data
reference.</td>
<td style="text-align: left;">1. Receive Request (<code>criaDoc</code>)
<br> 2. Validate Data against Template <br> 3. Generate PDF
(<code>geraPdf</code>) <br> 4. Persist Data and URL <br> 5. Return URL
to Caller</td>
<td style="text-align: left;">Back-Office Operator, Automated
System</td>
<td style="text-align: left;"><code>SpdGcdDados</code>,
<code>SpdDocumentosUrls</code>, <code>SpdReferenciasDados</code></td>
<td style="text-align: left;">The caller has the necessary reference
data (family, product, etc.) to identify the correct template.</td>
<td style="text-align: left;">This is the most common transactional
workflow in the application.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>BPW-003</strong></td>
<td style="text-align: left;">Document Search and Download (GIE)</td>
<td style="text-align: left;">A user searches for a document using
specific criteria in the GIE portal, views the results, and downloads
the document PDF.</td>
<td style="text-align: left;">1. User provides search criteria. <br> 2.
System queries and displays results. <br> 3. User selects a document for
download. <br> 4. System retrieves binary and streams it to the user.
<br> 5. System asynchronously updates the download counter.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>SpdGieDocsFE</code>,
<code>SpdGieDocBinaries</code></td>
<td style="text-align: left;">The user has the necessary permissions to
view and download documents.</td>
<td style="text-align: left;">This is the most common user workflow in
the GIE portal.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>BPW-004</strong></td>
<td style="text-align: left;">Document Kit Download (GIE)</td>
<td style="text-align: left;">A user navigates to a document kit,
selects multiple documents, and downloads them as a single merged
PDF.</td>
<td style="text-align: left;">1. User accesses a Kits detail page. <br>
2. User selects desired documents. <br> 3. System retrieves and merges
binaries. <br> 4. System streams the merged PDF to the user.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>SpdGieKit</code>,
<code>SpdGieKitRefs</code>, <code>SpdGieKitDdocs</code></td>
<td style="text-align: left;">The system can access and merge PDFs from
both its internal database and external repositories.</td>
<td style="text-align: left;">This workflow provides significant value
by packaging related documents for the user.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>BPW-005</strong></td>
<td style="text-align: left;">Global Resource Update and Batch
Regeneration</td>
<td style="text-align: left;">The automated workflow triggered by a
change in a shared resource (e.g., global text), which results in the
regeneration of all affected documents.</td>
<td style="text-align: left;">1. Identify Affected Documents <br> 2.
Queue Regeneration Requests (<code>criaPedidosRegeneracaoDocsGie</code>)
<br> 3. Background Job Processing
(<code>regeneraDocumentoGie</code>)</td>
<td style="text-align: left;">System Administrator, Automated
System</td>
<td style="text-align: left;"><code>GfdGlobalTexts</code>,
<code>SpdGieDocumentos</code>, <code>SpdRegenDocumentosGie</code></td>
<td style="text-align: left;">A dependency link exists between global
resources and the templates that use them.</td>
<td style="text-align: left;">This workflow is crucial for maintaining
data consistency across thousands of documents.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>BPW-006</strong></td>
<td style="text-align: left;">Build and Deploy to CQ</td>
<td style="text-align: left;">A developer pushes code to the
<code>cq</code> branch, which triggers an automated pipeline to build
the application and deploy it to the Quality Control (CQ)
environment.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">The CQ environment consists of multiple
JBoss servers for frontend and backend components.</td>
<td style="text-align: left;">This workflow automates the testing and
validation phase of the development lifecycle.</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>graph TD
    subgraph &quot;User-Initiated Workflows&quot;
        A1[&quot;BPW-001: Template Onboarding&quot;]
        A2[&quot;BPW-002: On-Demand PDF Generation&quot;]
        A3[&quot;BPW-003: GIE Document Search &amp; Download&quot;]
        A4[&quot;BPW-004: GIE Kit Download&quot;]
    end

    subgraph &quot;System-Initiated Workflows&quot;
        B1[&quot;BPW-005: Batch Regeneration&quot;]
        B2[&quot;BPW-006: CI/CD Build &amp; Deploy&quot;]
    end

    subgraph &quot;Triggers&quot;
        T1[&quot;Admin Action&quot;]
        T2[&quot;User/System API Call&quot;]
        T3[&quot;User UI Action&quot;]
        T4[&quot;Global Resource Change&quot;]
        T5[&quot;Git Push&quot;]
    end

    T1 --&gt; A1
    T2 --&gt; A2
    T3 --&gt; A3
    T3 --&gt; A4
    T4 --&gt; B1
    T5 --&gt; B2</code></pre>
<center>
Figure 8 - High-level visualization of key business process workflows.
</center>
<h4 id="271-workflow-bpw-001-new-document-template-onboarding">2.7.1.
Workflow BPW-001: New Document Template Onboarding</h4>
<p>This section provides a detailed breakdown of the New Document
Template Onboarding workflow, including the steps involved, user roles,
key data entities, and any assumptions made.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">1. <strong>Define Metadata</strong></td>
<td style="text-align: left;">The Template Administrator submits the
metadata structure (fields, tables) for the new document type, typically
as an XML payload. The system invokes <code>criaMetadados</code>.</td>
<td style="text-align: left;">Template Administrator</td>
<td style="text-align: left;"><code>SpdGcdMetadados</code>,
<code>SpdReferenciasMetadados</code></td>
<td style="text-align: left;">Assumes a front-end UI exists for the
administrator to define and submit this structure.</td>
<td style="text-align: left;">The submitted XML must be well-formed and
adhere to the systems expected schema.</td>
</tr>
<tr>
<td style="text-align: left;">2. <strong>Create Template in
GFD</strong></td>
<td style="text-align: left;">The system processes the metadata and
calls the GFD (Document Generation Framework) via
<code>SpdiToGfdHelper.criaTemplate</code> to create the underlying
template layout and variables.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;"><code>GfdTemplateVersions</code>,
<code>GfdTemplateAreas</code>, <code>GfdTemplateVars</code></td>
<td style="text-align: left;">Assumes the GFD is an internal or tightly
coupled library/service that handles the low-level template rendering
logic.</td>
<td style="text-align: left;">This step translates the business metadata
into a renderable template.</td>
</tr>
<tr>
<td style="text-align: left;">3. <strong>Associate Template with
Context</strong></td>
<td style="text-align: left;">The administrator associates the newly
created template with a specific business context (e.g., product,
family, currency) using a service like
<code>adicionaAssociacaoGenerico</code>.</td>
<td style="text-align: left;">Template Administrator</td>
<td style="text-align: left;"><code>SpdTemplateGenerico</code></td>
<td style="text-align: left;">Assumes a UI allows the administrator to
manage these associations.</td>
<td style="text-align: left;">This step is crucial for the system to be
able to look up the correct template at runtime.</td>
</tr>
<tr>
<td style="text-align: left;">4. <strong>Publish Template</strong></td>
<td style="text-align: left;">The administrator promotes the template to
Production state via a service that calls
<code>defineEstadoTemplate</code>. This makes the template active for
document generation.</td>
<td style="text-align: left;">Template Administrator</td>
<td style="text-align: left;"><code>SpdTemplateGfd</code></td>
<td style="text-align: left;">Assumes a publishing action in the UI
triggers this state change. An approval step might exist but is not
visible in the code.</td>
<td style="text-align: left;">Once in production, the template can be
used by the <code>criaDoc</code> service.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>sequenceDiagram
    participant Admin as &quot;Template Administrator&quot;
    participant UI as &quot;GIE Web UI&quot;
    participant EJB as &quot;SpdiService (EJB)&quot;
    participant GFD as &quot;GFD Helper&quot;

    Admin-&gt;&gt;UI: Submits new template definition (XML)
    UI-&gt;&gt;EJB: criaMetadados(gcdMetadados)
    activate EJB
    EJB-&gt;&gt;GFD: criaTemplate(spdGcdMetadados, ...)
    activate GFD
    GFD--&gt;&gt;EJB: Returns GfdTemplateVersions
    deactivate GFD
    EJB-&gt;&gt;EJB: Persists SpdTemplateGfd
    EJB--&gt;&gt;UI: Success Reply
    deactivate EJB
    
    Admin-&gt;&gt;UI: Publishes Template
    UI-&gt;&gt;EJB: defineEstadoTemplate(template)
    activate EJB
    EJB-&gt;&gt;EJB: Updates SpdTemplateGfd state to &#39;PRODUCAO&#39;
    EJB--&gt;&gt;UI: Success Reply
    deactivate EJB</code></pre>
<center>
Figure 9 - Sequence diagram for the New Document Template Onboarding
workflow.
</center>
<h4 id="272-workflow-bpw-002-on-demand-pdf-generation">2.7.2. Workflow
BPW-002: On-Demand PDF Generation</h4>
<p>This section provides a detailed breakdown of the On-Demand PDF
Generation workflow.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">1. <strong>Receive Request</strong></td>
<td style="text-align: left;">An external system or a user action from
the UI triggers the <code>criaDoc</code> service, providing the document
reference and data in an XML structure (<code>GCDDados</code>).</td>
<td style="text-align: left;">Back-Office Operator, Automated
System</td>
<td style="text-align: left;"><code>GCDDados</code> (Input DTO)</td>
<td style="text-align: left;">The input XML is well-formed and contains
all necessary data for generation.</td>
<td style="text-align: left;">This is the entry point for all on-demand
document generation.</td>
</tr>
<tr>
<td style="text-align: left;">2. <strong>Validate Request</strong></td>
<td style="text-align: left;">The system validates the request by
looking up the corresponding production template based on the provided
reference (<code>validaDadosComMetadados</code>).</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;"><code>SpdGcdMetadados</code>,
<code>SpdReferenciasMetadados</code></td>
<td style="text-align: left;">A valid, active template must exist in
Production state for the given business context.</td>
<td style="text-align: left;">If no template is found, the process
fails.</td>
</tr>
<tr>
<td style="text-align: left;">3. <strong>Generate PDF</strong></td>
<td style="text-align: left;">The system invokes the GFD via
<code>SpdiGeraPdfsHelper.geraPdf</code>, passing the data and the
located template to render the PDF binary.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;"><code>GfdTemplateVersions</code>,
<code>SpdGcdDados</code></td>
<td style="text-align: left;">The GFD handles the complexities of
merging data with the template layout (HTML/CSS to PDF).</td>
<td style="text-align: left;">This is the core rendering step.</td>
</tr>
<tr>
<td style="text-align: left;">4. <strong>Persist &amp; Create
URL</strong></td>
<td style="text-align: left;">The system saves the generated PDF binary
and the input data into the <code>SpdGcdDados</code> entity and creates
a unique, time-limited access URL by creating a
<code>SpdDocumentosUrls</code> record.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;"><code>SpdGcdDados</code>,
<code>SpdDocumentosUrls</code></td>
<td style="text-align: left;">The database is available and can store
the potentially large PDF binary data.</td>
<td style="text-align: left;">The generated URL provides a secure,
temporary access point to the document.</td>
</tr>
<tr>
<td style="text-align: left;">5. <strong>Return URL</strong></td>
<td style="text-align: left;">The unique URL is returned to the original
caller.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;"><code>DocumentoUrlOut</code> (Output
DTO)</td>
<td style="text-align: left;">The caller is responsible for handling the
URL, for example, by displaying it to a user or storing it.</td>
<td style="text-align: left;">The workflow concludes by providing the
access link to the generated document.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>sequenceDiagram
    participant Caller as &quot;User / System&quot;
    participant EJB as &quot;SpdiService (EJB)&quot;
    participant Validator as &quot;SpdiValidadores&quot;
    participant Generator as &quot;SpdiGeraPdfsHelper&quot;
    participant DB as &quot;Database&quot;

    Caller-&gt;&gt;EJB: criaDoc(GCDDados)
    activate EJB
    EJB-&gt;&gt;Validator: validaDadosComMetadados(dados)
    activate Validator
    Validator-&gt;&gt;DB: Find Production Template
    DB--&gt;&gt;Validator: SpdGcdMetadados
    Validator--&gt;&gt;EJB: Returns valid Metadados
    deactivate Validator
    
    EJB-&gt;&gt;Generator: geraPdf(dados, metadados)
    activate Generator
    Generator--&gt;&gt;EJB: Returns PDF binary
    deactivate Generator
    
    EJB-&gt;&gt;DB: Save SpdGcdDados (with PDF)
    DB--&gt;&gt;EJB: Persisted SpdGcdDados
    EJB-&gt;&gt;DB: Create SpdDocumentosUrls
    DB--&gt;&gt;EJB: Persisted SpdDocumentosUrls
    
    EJB--&gt;&gt;Caller: Returns DocumentoUrlOut
    deactivate EJB</code></pre>
<center>
Figure 10 - Sequence diagram for the On-Demand PDF Generation workflow.
</center>
<h4 id="273-workflow-bpw-003-document-search-and-download-gie">2.7.3.
Workflow BPW-003: Document Search and Download (GIE)</h4>
<p>This section provides a detailed breakdown of the Document Search and
Download workflow.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">1. <strong>Provide Search
Criteria</strong></td>
<td style="text-align: left;">The user fills out the search form on the
<code>pesquisa-documentos.xhtml</code> page with criteria such as
category, area, company, country, or keywords.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">The user knows what they are looking for
and can provide relevant search terms.</td>
<td style="text-align: left;">The form is backed by the
<code>PesquisaGieDocsBean</code>.</td>
</tr>
<tr>
<td style="text-align: left;">2. <strong>Execute Search</strong></td>
<td style="text-align: left;">The user clicks the Pesquisar Documentos
button, triggering the <code>pesquisaDocumentos()</code> action in
<code>PesquisaGieDocsBean</code>. This bean calls
<code>GieProxy.pesquisaReferenciasFE()</code> to query the backend.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>SpdGieDocsFE</code></td>
<td style="text-align: left;">The backend EJB service is available and
can process the search query against the database.</td>
<td style="text-align: left;">The results are paginated and displayed in
a data table.</td>
</tr>
<tr>
<td style="text-align: left;">3. <strong>Select Document for
Download</strong></td>
<td style="text-align: left;">The user identifies the desired document
in the results table and clicks the PDF download icon.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>SpdGieDocsFE</code></td>
<td style="text-align: left;">The document is available for download
(e.g., has the <code>aplicaGie</code> flag set to true).</td>
<td style="text-align: left;">This action calls the
<code>download(SpdGieDocsFE)</code> method in
<code>GieDocsBaseBean</code>.</td>
</tr>
<tr>
<td style="text-align: left;">4. <strong>Retrieve and Stream
Binary</strong></td>
<td style="text-align: left;">The system calls
<code>GieProxy.getSpdGieDocBinaries()</code> to fetch the documents
binary content from the database. The content is then decoded from
Base64 and streamed to the users browser as a PDF file.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;"><code>SpdGieDocBinaries</code></td>
<td style="text-align: left;">The binary data stored in the database is
a valid Base64-encoded PDF.</td>
<td style="text-align: left;">The <code>DownloadUtils.redirect()</code>
method handles the HTTP response to initiate the file download.</td>
</tr>
<tr>
<td style="text-align: left;">5. <strong>Update Download
Counter</strong></td>
<td style="text-align: left;">In parallel with the download, a new
<code>GieActualizaContadorDownloadThread</code> is started. This
background thread makes an asynchronous call to
<code>GieProxy.incContadorDownloadsDocumento()</code> to increment the
download counter for the specific document.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;"><code>SpdGieDocumentos</code></td>
<td style="text-align: left;">The database update is designed to be
asynchronous to not delay the users download.</td>
<td style="text-align: left;">This demonstrates a fire-and-forget
pattern to improve user experience.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>sequenceDiagram
    participant User
    participant UI as &quot;pesquisa-documentos.xhtml&quot;
    participant Bean as &quot;PesquisaGieDocsBean&quot;
    participant EJB as &quot;GieService (EJB)&quot;
    participant Thread as &quot;GieActualizaContadorDownloadThread&quot;

    User-&gt;&gt;UI: Fills search form and clicks &#39;Pesquisar&#39;
    UI-&gt;&gt;Bean: pesquisaDocumentos()
    Bean-&gt;&gt;EJB: pesquisaReferenciasFE(...)
    EJB--&gt;&gt;Bean: Returns List of SpdGieDocsFE
    Bean--&gt;&gt;UI: Displays results in a table
    
    User-&gt;&gt;UI: Clicks Download Icon
    UI-&gt;&gt;Bean: download(doc)
    Bean-&gt;&gt;EJB: getSpdGieDocBinaries(doc.id)
    EJB--&gt;&gt;Bean: Returns binary content
    Bean--&gt;&gt;User: Stream PDF file to browser
    
    activate Bean
    Bean-&gt;&gt;Thread: new GieActualizaContadorDownloadThread(doc.id).start()
    deactivate Bean
    
    Thread-&gt;&gt;EJB: incContadorDownloadsDocumento(doc.id)
    EJB--&gt;&gt;Thread: Returns success/failure</code></pre>
<center>
Figure 11 - Sequence diagram for the Document Search and Download
workflow.
</center>
<h4 id="274-workflow-bpw-004-document-kit-download-gie">2.7.4. Workflow
BPW-004: Document Kit Download (GIE)</h4>
<p>This section provides a detailed breakdown of the Document Kit
Download workflow.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">1. <strong>Access Kit
Details</strong></td>
<td style="text-align: left;">The user navigates to a kits detail page,
likely by clicking a link from the kit search results. This triggers
<code>detalhesKitGieBean.carregaKitGie()</code>.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>SpdGieKit</code></td>
<td style="text-align: left;">The Kit ID is passed as a parameter to the
page.</td>
<td style="text-align: left;">The bean fetches all documents (internal
and external) associated with the Kit.</td>
</tr>
<tr>
<td style="text-align: left;">2. <strong>Select Documents</strong></td>
<td style="text-align: left;">The user uses checkboxes on the UI to
select which documents from the kit they wish to download.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>SpdGieKitRefs</code>,
<code>SpdGieKitDdocs</code></td>
<td style="text-align: left;">The UI allows for the selection of both
internal (<code>SpdGieDocsFE</code>) and external
(<code>SpdGieKitDdocs</code>) documents.</td>
<td style="text-align: left;">The selections are stored in the
<code>selectedIds</code> map within the Seam conversation-scoped
beans.</td>
</tr>
<tr>
<td style="text-align: left;">3. <strong>Initiate Download</strong></td>
<td style="text-align: left;">The user clicks the Download Seleo
button, triggering the <code>detalhesKitGieBean.downloadSelecao()</code>
action.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">At least one document must be selected for
the download to proceed.</td>
<td style="text-align: left;">This action orchestrates the retrieval and
merging of all selected documents.</td>
</tr>
<tr>
<td style="text-align: left;">4. <strong>Retrieve and Merge
Binaries</strong></td>
<td style="text-align: left;">The system calls
<code>GieProxy.mergeMultiGieDocs()</code> for internal documents and
<code>detalhesDdocKitGieBean.downloadSelecao()</code> for external ones.
The external document download involves looking up a Documentum
token.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;"><code>SpdGieDocBinaries</code>,
<code>SpdGieKitDdocs</code></td>
<td style="text-align: left;">The system has access to both the internal
database and the external Documentum repository via the configured
proxies.</td>
<td style="text-align: left;">The <code>appendPdf</code> method in
<code>DetalhesKitGieBean</code> uses iText to merge the byte arrays of
the individual PDFs.</td>
</tr>
<tr>
<td style="text-align: left;">5. <strong>Stream Merged PDF</strong></td>
<td style="text-align: left;">The final, merged PDF byte array is
streamed to the users browser as a single file download.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">The iText library is capable of
successfully merging the provided PDF files.</td>
<td style="text-align: left;">The download counter is also updated for
each of the downloaded internal documents.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>sequenceDiagram
    participant User
    participant UI as &quot;detalhes-kit-gie.xhtml&quot;
    participant KitBean as &quot;DetalhesKitGieBean&quot;
    participant DdocBean as &quot;DetalhesDdocKitGieBean&quot;
    participant EJB as &quot;GieService (EJB)&quot;
    
    User-&gt;&gt;UI: Clicks on a Kit to view details
    UI-&gt;&gt;KitBean: carregaKitGie(kitId)
    KitBean-&gt;&gt;EJB: getSpdGieKit(kitId)
    EJB--&gt;&gt;KitBean: Returns Kit details and documents
    KitBean--&gt;&gt;UI: Renders document lists
    
    User-&gt;&gt;UI: Selects documents via checkboxes
    UI-&gt;&gt;KitBean: Updates selectedIds map
    
    User-&gt;&gt;UI: Clicks &#39;Download Seleo&#39;
    UI-&gt;&gt;KitBean: downloadSelecao()
    
    activate KitBean
    KitBean-&gt;&gt;EJB: mergeMultiGieDocs(selectedInternalDocs)
    EJB--&gt;&gt;KitBean: Merged PDF of internal docs
    
    KitBean-&gt;&gt;DdocBean: downloadSelecao()
    activate DdocBean
    DdocBean-&gt;&gt;EJB: mergeMultiGieDdocs(selectedExternalDocs)
    EJB--&gt;&gt;DdocBean: Merged PDF of external docs
    DdocBean--&gt;&gt;KitBean: Returns merged PDF
    deactivate DdocBean
    
    KitBean-&gt;&gt;KitBean: appendPdf(internalPDF, externalPDF)
    KitBean--&gt;&gt;User: Stream final merged PDF
    deactivate KitBean</code></pre>
<center>
Figure 12 - Sequence diagram for the Document Kit Download workflow.
</center>
<h4
id="275-workflow-bpw-005-global-resource-update-and-batch-regeneration">2.7.5.
Workflow BPW-005: Global Resource Update and Batch Regeneration</h4>
<p>This section provides a detailed breakdown of the Global Resource
Update and Batch Regeneration workflow.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">1. <strong>Identify Affected
Documents</strong></td>
<td style="text-align: left;">A System Administrator updates a shared
resource (e.g., a global text). A system process is triggered that calls
<code>SpdiRegenBDHelper</code> to find all <code>SpdGieDocumentos</code>
that depend on this resource.</td>
<td style="text-align: left;">System Administrator</td>
<td style="text-align: left;"><code>GfdGlobalTexts</code>,
<code>SpdGieDocumentos</code></td>
<td style="text-align: left;">The system maintains a dependency map or
can query for dependencies between templates and global resources.</td>
<td style="text-align: left;">This step is crucial for identifying the
scope of the regeneration.</td>
</tr>
<tr>
<td style="text-align: left;">2. <strong>Queue Regeneration
Requests</strong></td>
<td style="text-align: left;">For each affected document, the system
calls <code>criaPedidosRegeneracaoDocsGie</code> to create a new record
in the <code>SpdRegenDocumentosGie</code> table.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;"><code>SpdRegenDocumentosGie</code></td>
<td style="text-align: left;">The <code>SpdRegenDocumentosGie</code>
table acts as a persistent queue for the regeneration job.</td>
<td style="text-align: left;">This decouples the identification of
documents from their actual regeneration.</td>
</tr>
<tr>
<td style="text-align: left;">3. <strong>Background Job
Processing</strong></td>
<td style="text-align: left;">A scheduled background job (e.g., MDB or a
scheduled EJB) periodically queries the
<code>SpdRegenDocumentosGie</code> table for pending requests.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;"><code>SpdRegenDocumentosGie</code></td>
<td style="text-align: left;">A scheduler or message queue listener is
configured and running.</td>
<td style="text-align: left;">This ensures that regeneration happens
asynchronously without blocking the administrator.</td>
</tr>
<tr>
<td style="text-align: left;">4. <strong>Regenerate
Document</strong></td>
<td style="text-align: left;">For each request, the job invokes
<code>regeneraDocumentoGie</code>. This method clones the existing
document, deactivates the old version, generates a new PDF with the
updated resources, and saves the new version.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;"><code>SpdGieDocumentos</code></td>
<td style="text-align: left;">The regeneration logic correctly handles
versioning and state transitions (e.g., <code>ELIMINADO</code> for the
old version).</td>
<td style="text-align: left;">This is the core execution step where the
document is actually updated.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>graph TD
    A[Admin updates Global Resource] --&gt; B{&quot;Identify Affected Documents&lt;br&gt;(SpdiRegenBDHelper)&quot;};
    B --&gt; C{&quot;Queue Regeneration Requests&lt;br&gt;(criaPedidosRegeneracaoDocsGie)&quot;};
    C --&gt; D[&quot;Background Job &lt;br&gt;(e.g., MDB or Scheduler)&quot;];
    D --&gt; E{&quot;For each request: regeneraDocumentoGie()&quot;};
    E --&gt; F[&quot;- Clone document&lt;br&gt;- Apply new resource&lt;br&gt;- Generate new PDF&lt;br&gt;- Deactivate old version&quot;];
    F --&gt; G{&quot;Update Request Status&quot;};
    G --&gt; H[End];
    E -- On Error --&gt; I[Log Error &amp; Mark Request];
    I --&gt; G;</code></pre>
<center>
Figure 13 - Flowchart for the Global Resource Update and Batch
Regeneration workflow.
</center>
<h4 id="276-workflow-bpw-006-build-and-deploy-to-cq">2.7.6. Workflow
BPW-006: Build and Deploy to CQ</h4>
<p>This section provides a detailed breakdown of the automated build and
deployment workflow to the Quality Control (CQ) environment.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">1. <strong>Trigger</strong></td>
<td style="text-align: left;">A developer pushes code changes to the
<code>cq</code> branch in the Git repository.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">The workflow is configured to run only on
pushes to the <code>cq</code> branch.</td>
<td style="text-align: left;">The workflow is defined in
<code>pipeline-deploy-aplicacional.yml</code>.</td>
</tr>
<tr>
<td style="text-align: left;">2. <strong>Download
Artifacts</strong></td>
<td style="text-align: left;">The GitHub Actions runner executes a
<code>curl</code> command to download the pre-built application
artifacts (<code>.ear</code>, <code>.war</code>) from the Nexus
repository.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">The required artifacts
(<code>spdiMdw-ear</code>, <code>spdiWeb</code>, <code>gieWeb</code>)
have been previously built and published to Nexus.</td>
<td style="text-align: left;">This step separates the build and deploy
pipelines.</td>
</tr>
<tr>
<td style="text-align: left;">3. <strong>Prepare Deployment
Package</strong></td>
<td style="text-align: left;">The runner creates temporary directories,
copies the downloaded artifacts and necessary deployment scripts
(<code>jboss_stop.sh</code>, <code>jboss_start.sh</code>,
<code>backup_and_copy.sh</code>) into them, and zips them up.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">The deployment scripts are present in the
<code>scripts/</code> directory of the repository.</td>
<td style="text-align: left;">The process prepares separate packages for
backend (bea) and frontend (fea) servers.</td>
</tr>
<tr>
<td style="text-align: left;">4. <strong>Transfer and
Unpack</strong></td>
<td style="text-align: left;">The runner uses <code>scp</code> to
transfer the zip files to the target CQ servers (e.g.,
<code>uqc6001fea01</code>, <code>uqc6001bea02</code>) and then uses
<code>ssh</code> to unzip them into a temporary folder.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">The runner has SSH access to the target
servers using credentials stored in GitHub Secrets.</td>
<td style="text-align: left;">Weak SSH algorithms (<code>ssh-rsa</code>,
<code>hmac-sha1-96</code>) are used, which is a security risk.</td>
</tr>
<tr>
<td style="text-align: left;">5. <strong>Stop JBoss
Services</strong></td>
<td style="text-align: left;">The runner executes
<code>jboss_stop.sh</code> on the remote servers via <code>ssh</code> to
stop the running application instances.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">The script is executed with the
appropriate user context (e.g., <code>YYUEG94</code>,
<code>YA00453</code>).</td>
<td style="text-align: left;">The script waits for 60 seconds to allow
services to stop gracefully.</td>
</tr>
<tr>
<td style="text-align: left;">6. <strong>Backup and Deploy</strong></td>
<td style="text-align: left;">The <code>backup_and_copy.sh</code> script
is executed. It first creates a backup of the currently deployed
artifact and then copies the new artifact from the temporary folder to
the JBoss <code>deploy</code> directory.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">The script handles the logic for both
backend and frontend artifacts based on the user context.</td>
<td style="text-align: left;">This provides a simple rollback mechanism
by restoring the <code>.backup</code> file.</td>
</tr>
<tr>
<td style="text-align: left;">7. <strong>Start JBoss
Services</strong></td>
<td style="text-align: left;">The <code>jboss_start.sh</code> script is
executed to start the JBoss instances with the newly deployed
artifacts.</td>
<td style="text-align: left;">Automated System</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">The script waits for 60 seconds to allow
services to start.</td>
<td style="text-align: left;">The workflow includes steps for multiple
servers, indicating a clustered or multi-node environment.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>sequenceDiagram
    participant Dev as &quot;Developer&quot;
    participant GH as &quot;GitHub (cq branch)&quot;
    participant GA as &quot;GitHub Actions Runner&quot;
    participant Nexus
    participant JBoss as &quot;JBoss CQ Servers&quot;

    Dev-&gt;&gt;GH: Push changes
    GH-&gt;&gt;GA: Trigger &#39;Pipeline Deploy Aplicacional&#39;
    
    activate GA
    GA-&gt;&gt;Nexus: Download .ear &amp; .war artifacts
    Nexus--&gt;&gt;GA: Artifacts
    GA-&gt;&gt;GA: Prepare deployment .zip packages
    GA-&gt;&gt;JBoss: scp packages
    GA-&gt;&gt;JBoss: ssh (unzip, fix scripts)
    
    GA-&gt;&gt;JBoss: ssh (execute jboss_stop.sh)
    note right of JBoss: JBoss services are stopped
    
    GA-&gt;&gt;JBoss: ssh (execute backup_and_copy.sh)
    note right of JBoss: Old artifacts backed up,&lt;br&gt;new ones copied to deploy/
    
    GA-&gt;&gt;JBoss: ssh (execute jboss_start.sh)
    note right of JBoss: JBoss services are started
    deactivate GA</code></pre>
<center>
Figure 14 - Sequence diagram for the Build and Deploy to CQ workflow.
</center>
<h3 id="28-system-inputs--outputs-interfaces">2.8. System inputs &amp;
outputs (interfaces)</h3>
<p>This section catalogs all identified points where data enters or
leaves the application boundary.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Name / Description</th>
<th style="text-align: left;">Data Formats</th>
<th style="text-align: left;">Data Source / Sink</th>
<th style="text-align: left;">Assumptions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Input</strong></td>
<td style="text-align: left;"><strong>User Interface
(gieWeb)</strong></td>
<td style="text-align: left;">HTML Forms, User Clicks</td>
<td style="text-align: left;">Users Web Browser</td>
<td style="text-align: left;">Users interact with the system via JSF
pages to search for and manage documents.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Input</strong></td>
<td style="text-align: left;"><strong>SOAP/REST API
Requests</strong></td>
<td style="text-align: left;">XML, JSON</td>
<td style="text-align: left;">External Client Applications</td>
<td style="text-align: left;">Other systems call the provided web
services to generate or query documents.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Input</strong></td>
<td style="text-align: left;"><strong>Direct Document
Access</strong></td>
<td style="text-align: left;">URL Parameters</td>
<td style="text-align: left;">External Systems, User Bookmarks</td>
<td style="text-align: left;">The <code>abrir.xhtml</code> page accepts
a <code>Codigo</code> parameter to directly fetch and serve a
document.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Input</strong></td>
<td style="text-align: left;"><strong>JMS Messages</strong></td>
<td style="text-align: left;">Java Objects</td>
<td style="text-align: left;">HAPB/Alnova System</td>
<td style="text-align: left;">The application listens on JMS queues for
asynchronous messages from other systems.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Output</strong></td>
<td style="text-align: left;"><strong>Document Download
(PDF)</strong></td>
<td style="text-align: left;">PDF, DOC</td>
<td style="text-align: left;">Users Web Browser</td>
<td style="text-align: left;">The system streams single or merged PDF
files to the user for download.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Output</strong></td>
<td style="text-align: left;"><strong>Web UI / API
Responses</strong></td>
<td style="text-align: left;">HTML, XML, JSON</td>
<td style="text-align: left;">Users Browser, Client Applications</td>
<td style="text-align: left;">Search results, document details, and API
responses are rendered in the appropriate format.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Flow</strong></td>
<td style="text-align: left;"><strong>Database Interaction
(Oracle)</strong></td>
<td style="text-align: left;">SQL, JDBC</td>
<td style="text-align: left;">Oracle Database</td>
<td style="text-align: left;">The application performs all CRUD
operations against an Oracle database via JPA/Hibernate.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Flow</strong></td>
<td style="text-align: left;"><strong>Artifact Repository
(Nexus)</strong></td>
<td style="text-align: left;">Maven Artifacts (.jar, .war, .ear)</td>
<td style="text-align: left;"><code>nexus.grupocgd.com</code></td>
<td style="text-align: left;">The CI/CD pipeline uses Nexus to store and
retrieve build artifacts.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Flow</strong></td>
<td style="text-align: left;"><strong>External Document Repository
(Documentum)</strong></td>
<td style="text-align: left;">SOAP</td>
<td style="text-align: left;">Documentum System</td>
<td style="text-align: left;">The application integrates with Documentum
to archive and retrieve documents.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Flow</strong></td>
<td style="text-align: left;"><strong>Core Banking System
(HAPB/Alnova)</strong></td>
<td style="text-align: left;">JMS Messages</td>
<td style="text-align: left;">HAPB/Alnova System</td>
<td style="text-align: left;">The application sends asynchronous
requests to the core banking system via JMS.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>graph TD
    subgraph &quot;External World&quot;
        User[&quot;User via Browser&quot;]
        ClientApps[&quot;Client Applications&quot;]
        ExtSystems[&quot;External Systems&lt;br&gt;(Documentum, HAPB, LDAP)&quot;]
        Nexus[&quot;Nexus Repository&quot;]
    end

    subgraph &quot;SPDI/GIE Application&quot;
        UI[&quot;Web UI (gieWeb)&quot;]
        APIs[&quot;Web Services (spdiWeb)&quot;]
        Backend[&quot;Backend Services (spdiMdw-ejb)&quot;]
        DB[&quot;Oracle Database&quot;]
        CICD[&quot;CI/CD Pipeline&quot;]
    end

    User -- &quot;HTTP/HTML Forms&quot; --&gt; UI
    ClientApps -- &quot;SOAP/REST&quot; --&gt; APIs
    UI -- &quot;EJB Calls&quot; --&gt; Backend
    APIs -- &quot;EJB Calls&quot; --&gt; Backend
    UI -- &quot;PDF/DOC Stream&quot; --&gt; User
    
    Backend -- &quot;JPA/Hibernate&quot; --&gt; DB
    Backend -- &quot;SOAP/JMS/LDAP&quot; --&gt; ExtSystems
    
    CICD -- &quot;Pulls/Pushes Artifacts&quot; --&gt; Nexus
    CICD -- &quot;Deploys To&quot; --&gt; UI
    CICD -- &quot;Deploys To&quot; --&gt; APIs
    CICD -- &quot;Deploys To&quot; --&gt; Backend</code></pre>
<center>
Figure 15 - System inputs, outputs, and data flows.
</center>
<h3 id="29-user-task-flows">2.9. User task flows</h3>
<p>This section describes the typical path a user takes through the
application to achieve a high-level objective, linking multiple features
together. The analysis of <code>.jpdl.xml</code> and
<code>.pages.xml</code> files reveals the use of jBPM and JBoss Seam to
manage user navigation and process flows.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Task Flow ID</th>
<th style="text-align: left;">Task Flow Name</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>UTF-001</strong></td>
<td style="text-align: left;">Create and Manage Document Template</td>
<td style="text-align: left;">A comprehensive flow for a Template
Administrator to define, configure, and publish a new document template
using a multi-step wizard.</td>
<td style="text-align: left;">Template Administrator</td>
<td style="text-align: left;"><code>SpdTemplateGfd</code>,
<code>GfdTemplateVars</code>, <code>GfdTemplateAreas</code></td>
<td style="text-align: left;">Inferred from the
<code>criarTemplate.jpdl.xml</code> pageflow.</td>
<td style="text-align: left;">This is a complex, multi-step UI flow for
template designers.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>UTF-002</strong></td>
<td style="text-align: left;">Assemble and Download a Document Package
(Kit)</td>
<td style="text-align: left;">A user needs to find a specific package of
documents (a Kit) and download all or a subset of its contents as a
single file.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>SpdGieKit</code>,
<code>SpdGieKitRefs</code>, <code>SpdGieKitDdocs</code></td>
<td style="text-align: left;">The required documents are logically
grouped into a Kit.</td>
<td style="text-align: left;">This flow adds significant value by
simplifying the process of collecting related documents.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>UTF-003</strong></td>
<td style="text-align: left;">Upload and Process a Static Document</td>
<td style="text-align: left;">A flow for a user to upload a static
document (like a pre-made PDF) and have the system process and store
it.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>SpdReferenciasDados</code></td>
<td style="text-align: left;">Inferred from the
<code>uploadDocumentos.jpdl.xml</code> pageflow.</td>
<td style="text-align: left;">This flow is for documents that are not
dynamically generated by the system.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>UTF-004</strong></td>
<td style="text-align: left;">Manage User and Group Permissions</td>
<td style="text-align: left;">An administrative flow for managing users,
groups, profiles, and their associated permissions within the
application.</td>
<td style="text-align: left;">System Administrator</td>
<td style="text-align: left;"><code>User</code>, <code>Group</code>,
<code>Profile</code> (inferred)</td>
<td style="text-align: left;">Inferred from the set of pages in
<code>prf.pages.xml</code>.</td>
<td style="text-align: left;">This flow controls access to all other
functionalities in the application.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>UTF-005</strong></td>
<td style="text-align: left;">Manage Secure Messages</td>
<td style="text-align: left;">A flow for users to create, view, and
manage secure messages within a dedicated messaging module.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>Message</code> (inferred)</td>
<td style="text-align: left;">Inferred from the
<code>secureMessages.jpdl.xml</code> pageflow.</td>
<td style="text-align: left;">This suggests the application has an
internal secure messaging or communication feature.</td>
</tr>
</tbody>
</table></div>
<h4
id="291-user-task-flow-utf-001-create-and-manage-document-template">2.9.1.
User task flow UTF-001: Create and Manage Document Template</h4>
<p>This section provides a detailed breakdown of the Create and Manage
Document Template task flow. This flow is defined in
<code>criarTemplate.jpdl.xml</code>.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">1. <strong>Create Template
(Initial)</strong></td>
<td style="text-align: left;">The administrator starts the process from
the <code>criarTemplate</code> page, providing initial information like
the template name and type.</td>
<td style="text-align: left;">Template Administrator</td>
<td style="text-align: left;"><code>SpdTemplateGfd</code></td>
<td style="text-align: left;">The user has the necessary permissions to
access this pageflow.</td>
<td style="text-align: left;">This is the entry point to the template
creation wizard.</td>
</tr>
<tr>
<td style="text-align: left;">2. <strong>Edit Variables</strong></td>
<td style="text-align: left;">The user transitions to the
<code>editarVariaveis</code> page to define the dynamic variables that
will be used in the template. They can add, edit, or remove
variables.</td>
<td style="text-align: left;">Template Administrator</td>
<td style="text-align: left;"><code>GfdTemplateVars</code></td>
<td style="text-align: left;">The UI provides a way to manage a list of
variables associated with the template.</td>
<td style="text-align: left;">Variables are placeholders for data that
will be injected during document generation.</td>
</tr>
<tr>
<td style="text-align: left;">3. <strong>Edit Conditions</strong></td>
<td style="text-align: left;">The user moves to the
<code>editarCondicoes</code> page to define conditional logic (e.g.,
show/hide a section based on a variables value).</td>
<td style="text-align: left;">Template Administrator</td>
<td style="text-align: left;"><code>GfdTemplateConds</code></td>
<td style="text-align: left;">The system uses a scripting engine (like
BeanShell, given the <code>bsh</code> dependency) to evaluate these
conditions.</td>
<td style="text-align: left;">This allows for creating dynamic and
intelligent document structures.</td>
</tr>
<tr>
<td style="text-align: left;">4. <strong>Edit Areas
(Layout)</strong></td>
<td style="text-align: left;">The user proceeds to the
<code>editarAreas</code> page, which is the main layout editor. Here,
they arrange variables and conditions into a visual structure, likely
using a rich-text editor.</td>
<td style="text-align: left;">Template Administrator</td>
<td style="text-align: left;"><code>GfdTemplateAreas</code></td>
<td style="text-align: left;">The UI for this step is complex, allowing
the user to design the entire document layout.</td>
<td style="text-align: left;">This is where the visual appearance of the
document is defined.</td>
</tr>
<tr>
<td style="text-align: left;">5. <strong>Save and Finish</strong></td>
<td style="text-align: left;">Once the design is complete, the user
saves the template. The flow ends, and the user is returned to the main
template search page (<code>voltar</code>).</td>
<td style="text-align: left;">Template Administrator</td>
<td style="text-align: left;"><code>SpdTemplateGfd</code></td>
<td style="text-align: left;">The system persists all the defined
variables, conditions, and areas to the database.</td>
<td style="text-align: left;">The template is now saved in an Edition
or New state, ready for publishing.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>graph TD
    A["Start: /gfdcriar-templatexhtml"] --&gt; B["Edit Variables<br>/gfdcriar-templateeditar-variaveisxhtml"];
    B --&gt; C{Add/Edit Variable?};
    C -- Yes --&gt; D["Create Variable<br>/gfdcriar-templatecriar-variavelxhtml"];
    D --&gt; B;
    C -- No --&gt; E["Edit Conditions<br>/gfdcriar-templateeditar-condicoesxhtml"];
    E --&gt; F{Add/Edit Condition?};
    F -- Yes --&gt; G["Create Condition<br>/gfdcriar-templatecriar-condicaoxhtml"];
    G --&gt; E;
    F -- No --&gt; H["Edit Areas (Layout)<br>/gfdcriar-templateeditar-areasxhtml"];
    H --&gt; I{Edit Specific Area?};
    I -- Yes --&gt; J["Edit Area<br>/gfdcriar-templateeditar-areaxhtml"];
    J --&gt; H;
    I -- No --&gt; K{Save Template?};
    K -- Yes --&gt; L["End: /gfdpesquisar-templatesxhtml"];
    K -- No --&gt; H;</code></pre>
<center>
Figure 16 - Pageflow diagram for creating a new document template.
</center>
<h4
id="292-user-task-flow-utf-002-assemble-and-download-a-document-package-kit">2.9.2.
User task flow UTF-002: Assemble and Download a Document Package
(Kit)</h4>
<p>This section provides a detailed breakdown of the Assemble and
Download a Document Package task flow.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">1. <strong>Navigate to Kit
Search</strong></td>
<td style="text-align: left;">The user accesses the Pesquisar KITs
page (<code>/private/pesquisar-kits/pesquisa-kits.xhtml</code>).</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">The user knows they need a collection of
documents rather than a single one.</td>
<td style="text-align: left;">This flow starts from a different search
interface than TF-001.</td>
</tr>
<tr>
<td style="text-align: left;">2. <strong>Find and Select a
Kit</strong></td>
<td style="text-align: left;">The user searches for a Kit by its code or
description and clicks on it in the results to view its details.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>SpdGieKit</code></td>
<td style="text-align: left;">The necessary documents are pre-associated
into a Kit by an administrator.</td>
<td style="text-align: left;">This action navigates the user to the
<code>detalhes-kit-gie.xhtml</code> page.</td>
</tr>
<tr>
<td style="text-align: left;">3. <strong>Review and Select
Documents</strong></td>
<td style="text-align: left;">The user reviews the list of all documents
contained within the Kit, which can include both internal GIE documents
and external documents (from Documentum). They use checkboxes to select
the specific documents they need.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>SpdGieKitRefs</code>,
<code>SpdGieKitDdocs</code></td>
<td style="text-align: left;">The user can identify the documents they
need from the list.</td>
<td style="text-align: left;">This UI is managed by
<code>DetalhesKitGieBean</code> and
<code>DetalhesDdocKitGieBean</code>.</td>
</tr>
<tr>
<td style="text-align: left;">4. <strong>Initiate Package
Download</strong></td>
<td style="text-align: left;">The user clicks the Download Seleo
button.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;">N/A</td>
<td style="text-align: left;">At least one document has been
selected.</td>
<td style="text-align: left;">This triggers the
<code>downloadSelecao()</code> method in
<code>DetalhesKitGieBean</code>.</td>
</tr>
<tr>
<td style="text-align: left;">5. <strong>Save Merged PDF
File</strong></td>
<td style="text-align: left;">The system retrieves all selected
documents, merges them into a single PDF file on the server, and streams
the result to the users browser.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>SpdGieDocBinaries</code></td>
<td style="text-align: left;">The backend services can successfully
access all document sources and the iText library can merge them without
errors.</td>
<td style="text-align: left;">This is a powerful feature that simplifies
the users work by providing a single, consolidated document
package.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>graph TD
    A[Start: User needs a document package] --&gt; B[&quot;Navigate to Kit Search Page&quot;]
    B --&gt; C[&quot;Search for a specific Kit&quot;]
    C --&gt; D[&quot;Select Kit to view its contents&quot;]
    D --&gt; E[&quot;Review list of documents in the Kit&quot;]
    E --&gt; F[&quot;Use checkboxes to select desired documents&quot;]
    F --&gt; G[&quot;Click &#39;Download Seleo&#39; button&quot;]
    G --&gt; H[&quot;System merges selected PDFs&quot;]
    H --&gt; I[End: User saves the single merged PDF file]</code></pre>
<center>
Figure 17 - Flowchart for the Assemble and Download a Document Package
task flow.
</center>
<h4
id="293-user-task-flow-utf-003-upload-and-process-a-static-document">2.9.3.
User task flow UTF-003: Upload and Process a Static Document</h4>
<p>This section provides a detailed breakdown of the Upload and Process
a Static Document task flow, based on the
<code>uploadDocumentos.jpdl.xml</code> pageflow.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>1. Get Reference</strong></td>
<td style="text-align: left;">The user navigates to the
<code>uploadDocumentosPasso1</code> page. Here, they provide the
business context (family, product, etc.) to obtain a document reference
from the system.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>SpdReferenciasDados</code></td>
<td style="text-align: left;">The system must be able to generate a
unique reference for the new static document.</td>
<td style="text-align: left;">This step links the uploaded file to a
business context.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>2. Upload Document</strong></td>
<td style="text-align: left;">The user proceeds to the
<code>uploadDocumentosPasso2</code> page. They use a file upload
component to select and upload the static PDF file.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;">N/A (File Stream)</td>
<td style="text-align: left;">The uploaded file is a valid PDF.</td>
<td style="text-align: left;">The file is temporarily stored for
processing.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>3. Confirm and Save</strong></td>
<td style="text-align: left;">The user moves to the
<code>uploadDocumentosPasso3</code> page, which displays the reference
information and the uploaded file details for confirmation. Upon
confirming, the system saves the document.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>SpdGcdDados</code></td>
<td style="text-align: left;">The backend logic saves the uploaded
binary and its associated reference to the database.</td>
<td style="text-align: left;">The static document is now stored in the
system, similar to a dynamically generated one.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>graph TD
    A[&quot;Start: Get Reference&lt;br&gt;(uploadDocumentosPasso1)&quot;] --&gt; B[&quot;Upload Document File&lt;br&gt;(uploadDocumentosPasso2)&quot;];
    B --&gt; C[&quot;Confirm Data&lt;br&gt;(uploadDocumentosPasso3)&quot;];
    C -- Save --&gt; D[&quot;End: Return to Start&quot;];
    C -- Back --&gt; B;
    B -- Back --&gt; A;</code></pre>
<center>
Figure 18 - Pageflow diagram for uploading a static document.
</center>
<h4
id="294-user-task-flow-utf-004-manage-user-and-group-permissions">2.9.4.
User task flow UTF-004: Manage User and Group Permissions</h4>
<p>This section provides a detailed breakdown of the Manage User and
Group Permissions task flow, inferred from the
<code>prf.pages.xml</code> configuration file.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">1. <strong>Access User
Management</strong></td>
<td style="text-align: left;">The administrator navigates to the user
management section (<code>/prf/pesquisa-users.xhtml</code>).</td>
<td style="text-align: left;">System Administrator</td>
<td style="text-align: left;"><code>User</code> (inferred)</td>
<td style="text-align: left;">The administrator has the
<code>Profilling.PesquisaUsers</code> role.</td>
<td style="text-align: left;">This is the entry point for all
user-related administration.</td>
</tr>
<tr>
<td style="text-align: left;">2. <strong>Search for
User/Group</strong></td>
<td style="text-align: left;">The administrator uses a search form to
find a specific user, group, or profile.</td>
<td style="text-align: left;">System Administrator</td>
<td style="text-align: left;"><code>User</code>, <code>Group</code>,
<code>Profile</code></td>
<td style="text-align: left;">The backend provides services to query
users and permissions.</td>
<td style="text-align: left;">The search result is typically a list of
entities.</td>
</tr>
<tr>
<td style="text-align: left;">3. <strong>Select and Edit</strong></td>
<td style="text-align: left;">The administrator selects a user or group
from the results list and navigates to an edit page (e.g.,
<code>/prf/editar-user.xhtml</code>).</td>
<td style="text-align: left;">System Administrator</td>
<td style="text-align: left;"><code>User</code>, <code>Group</code>,
<code>Profile</code></td>
<td style="text-align: left;">The UI allows for modifying attributes
like associated groups, profiles, or team memberships.</td>
<td style="text-align: left;">This is where permissions are actually
assigned or revoked.</td>
</tr>
<tr>
<td style="text-align: left;">4. <strong>Save Changes</strong></td>
<td style="text-align: left;">The administrator saves the changes. The
system persists the updated user/group information to the database.</td>
<td style="text-align: left;">System Administrator</td>
<td style="text-align: left;"><code>User</code>, <code>Group</code>,
<code>Profile</code></td>
<td style="text-align: left;">The backend services handle the update
logic.</td>
<td style="text-align: left;">The users permissions are now updated for
subsequent logins.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>sequenceDiagram
    participant Admin as &quot;Administrator&quot;
    participant UI as &quot;Profilling UI (.xhtml)&quot;
    participant Bean as &quot;User/Group Mgmt Bean&quot;
    participant EJB as &quot;Profilling EJB&quot;
    participant DB as &quot;Database&quot;

    Admin-&gt;&gt;UI: Navigates to User Search
    UI-&gt;&gt;Bean: init()
    
    Admin-&gt;&gt;UI: Enters search criteria for a user
    UI-&gt;&gt;Bean: searchUsers()
    activate Bean
    Bean-&gt;&gt;EJB: findUsers(criteria)
    activate EJB
    EJB-&gt;&gt;DB: Query users table
    DB--&gt;&gt;EJB: User list
    EJB--&gt;&gt;Bean: Returns results
    deactivate EJB
    Bean--&gt;&gt;UI: Display user list
    deactivate Bean

    Admin-&gt;&gt;UI: Clicks &#39;Edit&#39; on a user
    UI-&gt;&gt;Bean: editUser(user)
    activate Bean
    Bean-&gt;&gt;UI: Navigates to edit page with user data
    
    Admin-&gt;&gt;UI: Modifies user roles/groups and clicks &#39;Save&#39;
    UI-&gt;&gt;Bean: saveUser()
    Bean-&gt;&gt;EJB: updateUser(user)
    activate EJB
    EJB-&gt;&gt;DB: UPDATE user, user_roles
    DB--&gt;&gt;EJB: Success
    EJB--&gt;&gt;Bean: Success
    deactivate EJB
    Bean--&gt;&gt;UI: Redirects to search page
    deactivate Bean</code></pre>
<center>
Figure 19 - Sequence diagram for managing user permissions.
</center>
<h4 id="295-user-task-flow-utf-005-manage-secure-messages">2.9.5. User
task flow UTF-005: Manage Secure Messages</h4>
<p>This section provides a detailed breakdown of the Manage Secure
Messages task flow, based on the <code>secureMessages.jpdl.xml</code>
pageflow definition.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Step</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">User Role</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">1. <strong>Select Mailbox</strong></td>
<td style="text-align: left;">The user selects a mailbox to view, such
as Received, Sent, or Archive. The system transitions to the
<code>listaMensagens</code> page.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>Message</code> (inferred)</td>
<td style="text-align: left;">The application has a concept of different
mailboxes for organizing messages.</td>
<td style="text-align: left;">This is the main view for browsing
messages.</td>
</tr>
<tr>
<td style="text-align: left;">2. <strong>View Message List</strong></td>
<td style="text-align: left;">The <code>listaMensagens</code> page
displays a list of messages for the selected mailbox.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>Message</code></td>
<td style="text-align: left;">The user can see a summary of each message
(e.g., subject, sender, date).</td>
<td style="text-align: left;">From here, the user can perform actions on
one or more messages.</td>
</tr>
<tr>
<td style="text-align: left;">3. <strong>Perform Action</strong></td>
<td style="text-align: left;">The user can perform several actions: <br>
- <strong>Read:</strong> Select a message to view its full content
(<code>detalheMsgLeitura</code>). <br> - <strong>Delete:</strong> Select
messages and confirm deletion (<code>confirmaApagarEmLista</code>). <br>
- <strong>Archive:</strong> Select messages and confirm archival
(<code>confirmaArquivarEmLista</code>). <br> - <strong>Compose:</strong>
Start a new message (<code>novaMensagem</code>).</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>Message</code></td>
<td style="text-align: left;">The UI provides buttons or links for each
of these actions.</td>
<td style="text-align: left;">The pageflow handles the transitions to
confirmation and execution pages for each action.</td>
</tr>
<tr>
<td style="text-align: left;">4. <strong>Complete Action</strong></td>
<td style="text-align: left;">After confirming, the system executes the
action (e.g., calls <code>executaApagarEmLista</code>) and returns the
user to the updated message list.</td>
<td style="text-align: left;">Back-Office Operator</td>
<td style="text-align: left;"><code>Message</code></td>
<td style="text-align: left;">The backend services handle the actual
logic for deleting, archiving, or sending messages.</td>
<td style="text-align: left;">The task flow is cyclical, always
returning the user to a message list view after an action is
completed.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>graph TD
    A[Start: Select Mailbox] --&gt; B["View Message List<br>(/Smgcaixamensagensmensagensxhtml)"];
    B --&gt; C{Choose Action};
    C -- Read --&gt; D["View Message Detail<br>(/Smgcaixamensagensdetalhe-mensagemxhtml)"];
    C -- Delete --&gt; E["Confirm Deletion<br>(/Smgcaixamensagensmensagens-accaoxhtml)"];
    C -- Archive --&gt; F["Confirm Archival<br>(/Smgcaixamensagensmensagens-accaoxhtml)"];
    C -- Compose --&gt; G["New Message<br>(/Smgcaixamensagensnova-mensagemxhtml)"];
    
    D -- Reply --&gt; G;
    D -- Back --&gt; B;
    E -- Confirm --&gt; H[Execute Delete];
    E -- Back --&gt; B;
    F -- Confirm --&gt; I[Execute Archive];
    F -- Back --&gt; B;
    G -- Send --&gt; J[Confirm Send];
    G -- Back --&gt; B;
    
    H --&gt; B;
    I --&gt; B;
    J --&gt; B;</code></pre>
<center>
Figure 20 - Pageflow diagram for the secure messaging feature.
</center>
<h3 id="210-automated--scheduled-processes">2.10. Automated &amp;
scheduled processes</h3>
<p>This section describes any system-triggered processes that run
without direct user interaction, such as nightly jobs, scheduled
reports, or data synchronization tasks.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Process Name</th>
<th style="text-align: left;">Trigger / Schedule</th>
<th style="text-align: left;">Purpose</th>
<th style="text-align: left;">Key Actions</th>
<th style="text-align: left;">Key Data Entities</th>
<th style="text-align: left;">Assumptions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Template Expiration
Job</strong></td>
<td style="text-align: left;">Scheduled (e.g., nightly). Triggered by an
EJB Timer or external scheduler invoking
<code>TemplateExpirationThread</code>.</td>
<td style="text-align: left;">To automatically deactivate and clean up
document templates that have passed their expiration date, ensuring
compliance and preventing use of obsolete templates.</td>
<td style="text-align: left;">1. Query for templates where
<code>dataExpiracao</code> is in the past. <br> 2. For each expired
template, call <code>eliminarTemplate</code> to update its state to
inactive/deleted.</td>
<td style="text-align: left;"><code>SpdTemplateGfd</code></td>
<td style="text-align: left;">Inferred from
<code>TemplateExpirationThread.java</code>. Assumes a container-managed
or system-level scheduler is configured to run this thread.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Document State
Review</strong></td>
<td style="text-align: left;">Timed, Daily (at 00:30). Triggered by
<code>GieReviewDocStatesThread</code>.</td>
<td style="text-align: left;">To automatically update the status of
documents that have passed their expiration date
(<code>dataFim</code>).</td>
<td style="text-align: left;">1. Wakes up on a daily schedule. <br> 2.
Executes the <code>UPDATE_EXPIRED_GIE_DOCS</code> stored procedure. <br>
3. The procedure identifies documents where
<code>dataFim &lt; NOW()</code> and updates their state.</td>
<td style="text-align: left;"><code>SpdGieDocumentos</code></td>
<td style="text-align: left;">Inferred from
<code>GieReviewDocStatesThread.java</code>, which calculates the time to
the next cycle (daily at 00:30) and calls a database procedure to
perform the update.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Document Regeneration Batch
Job</strong></td>
<td style="text-align: left;">Event-based (triggered after a global
resource change) and processed by a background job.</td>
<td style="text-align: left;">To automatically regenerate all documents
that are affected by a change to a shared resource (e.g., global text,
logo), ensuring all documents remain consistent and up-to-date.</td>
<td style="text-align: left;">1. Query
<code>SpdRegenDocumentosGie</code> table for pending requests. <br> 2.
For each request, invoke <code>regeneraDocumentoGie</code>. <br> 3.
Clone the document, apply new resources, generate a new PDF, deactivate
the old version, and mark the request as complete.</td>
<td style="text-align: left;"><code>SpdRegenDocumentosGie</code>,
<code>SpdGieDocumentos</code></td>
<td style="text-align: left;">Inferred from
<code>SpdiRegenBDHelper.java</code>. Assumes an MDB or scheduled EJB is
polling the regeneration queue table.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>HAPB Asynchronous Request
Processor</strong></td>
<td style="text-align: left;">Continuous Polling Thread
(<code>HapbAsyncQueueThread</code>) or Message-based (MDB).</td>
<td style="text-align: left;">To process asynchronous requests to the
HAPB (Alnova) core banking system for operations like archiving
documents.</td>
<td style="text-align: left;">1. Polls the <code>HAPB_ASYNC_QUEUE</code>
table or listens on a JMS queue. <br> 2. For each item, invokes the
corresponding Alnova transaction. <br> 3. Implements a retry mechanism
(<code>nrTentativas</code>).</td>
<td style="text-align: left;"><code>HapbAsyncQueueItem</code></td>
<td style="text-align: left;">Inferred from
<code>HapbAsyncQueueThread.java</code> and
<code>HapbAsyncQueueService.java</code>. The system uses both a DB queue
and JMS.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>graph TD
    subgraph &quot;Scheduled Processes&quot;
        A["Scheduler (e.g., EJB Timer)"] --&gt; B(TemplateExpirationThread);
        B --&gt; C{Find Expired Templates};
        C --&gt; D[Deactivate Template];
        
        A2[Daily Timer at 00:30] --&gt; B2(GieReviewDocStatesThread)
        B2 --&gt; C2["Execute DB Procedure<br>UPDATE_EXPIRED_GIE_DOCS"]
    end
    
    subgraph &quot;Event-Driven &amp; Queued Processes&quot;
        E[Global Resource Change] --&gt; F{Queue Regeneration Requests};
        F --&gt; G[(Regeneration Queue Table)];
        H[Background Job / MDB] --&gt; G;
        H --&gt; I{Process Regeneration Request};
        I --&gt; J[Regenerate Document PDF];

        K[System sends message] --&gt; L[(HAPB DB Queue / JMS Queue)];
        M[HAPB Queue Processor Thread/MDB] --&gt; L;
        M --&gt; N{Process HAPB Request};
        N --&gt; O[Invoke Alnova Transaction];
    end</code></pre>
<center>
Figure 21 - Overview of automated and scheduled processes.
</center>
</div>
<div class="product-section"><h2 id="3-architecture-and-design">3. Architecture and design</h2>
<p>This section provides a comprehensive overview of the architectural
and design patterns applied in the application.</p>
<h3 id="31-architecture-pattern">3.1. Architecture pattern</h3>
<p>This section describes the primary architectural pattern applied in
the application design.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Pattern Name</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Example Technologies / Use Cases</th>
<th style="text-align: left;">Purpose / Benefit</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Primary Architectural
Patterns</strong></td>
<td style="text-align: left;"><strong>N-Tier / Layered
Architecture</strong></td>
<td style="text-align: left;">The application is logically and
physically separated into Presentation (Web), Business (EJB), and Data
(JPA/Hibernate) tiers. This is a classic Java EE architecture.</td>
<td style="text-align: left;">- <strong>Presentation:</strong> JSF/Seam
(<code>gieWeb</code>), JAX-RS/WS (<code>spdiWeb</code>) <br>-
<strong>Business:</strong> Stateless Session EJBs
(<code>spdiMdw-ejb</code>) <br>- <strong>Data:</strong> JPA with
Hibernate, Oracle DB</td>
<td style="text-align: left;">Separation of concerns, maintainability,
scalability, and testability. Allows different teams to work on
different layers independently.</td>
<td style="text-align: left;">Inferred from the project structure
(<code>.war</code>, <code>-ejb.jar</code>, <code>.ear</code>) and the
technologies used in each module.</td>
<td style="text-align: left;">This is a very common and robust pattern
for enterprise Java applications of its era.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Component / UI
Patterns</strong></td>
<td style="text-align: left;"><strong>Model-View-Controller (MVC)
variant</strong></td>
<td style="text-align: left;">JBoss Seam, in conjunction with JSF,
implements a variation of the MVC pattern. JSF pages
(<code>.xhtml</code>) act as the View, Seam Beans (<code>@Name</code>)
act as the Controller, and backend EJBs/Entities act as the Model.</td>
<td style="text-align: left;">- <strong>View:</strong>
<code>pesquisa-documentos.xhtml</code> <br>-
<strong>Controller:</strong> <code>PesquisaGieDocsBean.java</code> <br>-
<strong>Model:</strong> <code>SpdGieDocsFE</code> entity,
<code>GieService</code> EJB</td>
<td style="text-align: left;">Organizes UI code, separates presentation
from business logic, and manages component state through
conversations.</td>
<td style="text-align: left;">The use of JSF backing beans
(<code>@Name</code>, <code>@Scope</code>) that mediate between the UI
and backend services is a clear indicator of this pattern.</td>
<td style="text-align: left;">Seams conversation scope and jBPM
pageflows are key features for managing complex, stateful user
interactions.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Jakarta EE / Java EE
Patterns</strong></td>
<td style="text-align: left;"><strong>Session Faade</strong></td>
<td style="text-align: left;">Stateless Session EJBs
(<code>GieService</code>, <code>SpdiService</code>) are used to provide
a coarse-grained, simplified interface to the complex business logic and
data access layers.</td>
<td style="text-align: left;"><code>GieProxy</code> and
<code>SpdiService</code> EJB expose high-level business methods like
<code>criaDoc</code> and <code>consultaKit</code>, hiding the underlying
complexity of helpers and DAOs.</td>
<td style="text-align: left;">Decouples clients from the internal
business logic, simplifies the API, and provides a clear transactional
boundary.</td>
<td style="text-align: left;">The use of EJBs with helper classes
strongly indicates this pattern.</td>
<td style="text-align: left;">This is a core Java EE design
pattern.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Jakarta EE / Java EE
Patterns</strong></td>
<td style="text-align: left;"><strong>Data Access Object
(DAO)</strong></td>
<td style="text-align: left;">Data access logic is encapsulated within
specific DAO classes (<code>SpdiTablesDAO</code>,
<code>GfdTablesDAO</code>), separating persistence from business
logic.</td>
<td style="text-align: left;"><code>SpdiTablesDAO</code> uses Hibernate
<code>Criteria</code> to query the database, abstracting the persistence
mechanism from the <code>SpdiHelper</code> classes.</td>
<td style="text-align: left;">Decouples business logic from the
persistence technology (Hibernate), making it easier to manage and test
data access.</td>
<td style="text-align: left;">The presence of classes ending in
<code>DAO</code> that handle all database interactions is clear
evidence.</td>
<td style="text-align: left;">The DAOs are implemented using the native
Hibernate API, not the standard JPA <code>EntityManager</code>.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>graph TD
    subgraph &quot;Presentation Tier (WARs)&quot;
        A[&quot;Web UI (gieWeb)&lt;br&gt;JSF/Seam&quot;]
        B[&quot;Web APIs (spdiWeb)&lt;br&gt;JAX-RS/WS&quot;]
    end
    
    subgraph &quot;Business Tier (spdiMdw-ejb.jar)&quot;
        C[&quot;Session Faade (EJBs)&lt;br&gt;GieService, SpdiService&quot;]
        D[&quot;Business Logic (Helpers)&lt;br&gt;SpdiHelper, SpdiRegenBDHelper&quot;]
    end
    
    subgraph &quot;Data Tier&quot;
        E[&quot;DAO (SpdiTablesDAO)&quot;]
        F[&quot;JPA/Hibernate Entities&quot;]
        G[&quot;Oracle Database&quot;]
    end
    
    A -- &quot;Interacts with&quot; --&gt; C
    B -- &quot;Interacts with&quot; --&gt; C
    C -- &quot;Delegates to&quot; --&gt; D
    D -- &quot;Uses&quot; --&gt; E
    E -- &quot;Maps to/from&quot; --&gt; F
    E -- &quot;Accesses&quot; --&gt; G</code></pre>
<center>
Figure 22 - Layered architecture of the SPDI/GIE application.
</center>
<h3 id="32-architecture-style">3.2. Architecture style</h3>
<p>This section describes the architectural style applied to the
application design.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Layering</strong></td>
<td style="text-align: left;">- <strong>Presentation:</strong> JSF with
RichFaces components, managed by JBoss Seam beans. JAX-RS (Jersey) and
JAX-WS (JBossWS) for APIs. <br>- <strong>Business:</strong> Stateless
Session EJBs containing the core business logic, often delegating to
helper classes. <br>- <strong>Persistence:</strong> JPA with Hibernate
as the provider, using DAO classes to interact with the database. <br>-
<strong>Integration:</strong> A mix of direct EJB lookups, synchronous
SOAP/REST clients, and asynchronous processing via JMS and custom
database queues/threads.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Dependency flow</strong></td>
<td style="text-align: left;">The dependency flow is strictly top-down:
<code>Web (JSF/Seam/API) -&gt; Business (EJB) -&gt; Persistence (JPA/DAO) -&gt; Database</code>.
There are no apparent violations of this layering.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Bounded contexts</strong></td>
<td style="text-align: left;">The application appears to be a single,
large bounded context focused on Document Management. However, the
module names and functional areas suggest subdomains: <br>-
<strong>SPDI:</strong> Core document production, services, and backend
logic. <br>- <strong>GIE:</strong> User-facing document retrieval and
kit management. <br>- <strong>GFD:</strong> The internal document
generation framework. <br>- <strong>CMS:</strong> A content management
subsystem.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Communication between
modules/services</strong></td>
<td style="text-align: left;">- <strong>Web to EJB:</strong> Primarily
through proxy classes (<code>GieProxy</code>) or direct EJB injection
that look up and invoke stateless session EJBs. <br>-
<strong>Asynchronous:</strong> JMS is used for reliable messaging to the
HAPB system. Custom Java threads and database polling
(<code>HapbAsyncQueueThread</code>) are used for other non-blocking
operations.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Use of dependency injection / IoC
container</strong></td>
<td style="text-align: left;"><strong>JBoss Seam</strong> is the primary
IoC container for the web layer. Annotations like <code>@Name</code>,
<code>@Scope</code>, <code>@In</code>, and <code>@AutoCreate</code> are
used to manage component lifecycle and inject dependencies. <strong>EJB
injection</strong> is used within the EJB tier.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Assumptions</strong></td>
<td style="text-align: left;">The architecture is a traditional,
monolithic Java EE application deployed as an EAR. The separation into
WAR and EJB modules follows standard Java EE practices for applications
of its era.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Notes</strong></td>
<td style="text-align: left;">The use of JBoss Seam is a key
characteristic, providing a component and conversation model that
bridges the gap between the stateless web tier and the stateful business
logic required for complex user flows, including integration with jBPM
for pageflows.</td>
</tr>
</tbody>
</table></div>
<pre class="mermaid"><code>graph TD
    subgraph &quot;Web Tier (WARs)&quot;
        direction LR
        JSF_Pages[&quot;.xhtml Pages &amp; jBPM Pageflows&quot;]
        Seam_Beans[&quot;Seam Beans&lt;br&gt;@Name, @Scope&quot;]
        APIs[&quot;JAX-RS/WS Endpoints&quot;]
    end
    
    subgraph &quot;Business Tier (EJB Modules)&quot;
        direction LR
        Proxy[&quot;Service Proxy&lt;br&gt;(GieProxy)&quot;]
        EJBs[&quot;Stateless EJBs&lt;br&gt;@Stateless&quot;]
    end
    
    subgraph &quot;Data Tier&quot;
        direction LR
        DAO[&quot;DAO Layer&lt;br&gt;(SpdiTablesDAO)&quot;]
        JPA[&quot;JPA/Hibernate Entities&lt;br&gt;@Entity&quot;]
    end
    
    subgraph &quot;Database&quot;
        Oracle[(&quot;Oracle DB&quot;)]
    end

    JSF_Pages -- &quot;Backing Beans&quot; --&gt; Seam_Beans
    Seam_Beans -- &quot;Calls&quot; --&gt; Proxy
    APIs -- &quot;Calls&quot; --&gt; EJBs
    Proxy -- &quot;Invokes&quot; --&gt; EJBs
    EJBs -- &quot;Uses&quot; --&gt; DAO
    DAO -- &quot;Maps&quot; --&gt; JPA
    DAO -- &quot;CRUD&quot; --&gt; Oracle</code></pre>
<center>
Figure 23 - Architectural style and dependency flow.
</center>
<h3 id="33-key-design-patterns-and-principles-applied">3.3. Key design
patterns and principles applied</h3>
<p>This section describes the key design patterns and principles applied
in the application.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>SOLID principles</strong></td>
<td style="text-align: left;">- <strong>Single Responsibility
Principle:</strong> Partially applied. DAOs and some beans have a single
responsibility. However, large helper classes like
<code>SpdiHelper</code> and <code>SpdiRegenBDHelper</code> have many
responsibilities and high complexity, violating SRP. <br>-
<strong>Open/Closed Principle:</strong> The use of interfaces for
external services (<code>ProcurarDocumentosService</code>) allows for
extension. However, the heavy use of concrete helper classes makes the
core logic less open to extension.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>DRY (Dont Repeat
Yourself)</strong></td>
<td style="text-align: left;">Generally followed through the use of base
classes (<code>GieDocsBaseBean</code>), helper utilities
(<code>SpdiExceptionUtils</code>), and a shared <code>commons</code>
library.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>KISS (Keep It Simple,
Stupid)</strong></td>
<td style="text-align: left;">The overall architecture is standard and
straightforward for its time. However, the logic within some methods is
highly complex due to intricate business rules.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>YAGNI (You Aint Gonna Need
It)</strong></td>
<td style="text-align: left;">No obvious signs of over-engineering. The
features seem directly tied to the applications extensive document
management purpose.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>GRASP patterns</strong></td>
<td style="text-align: left;">- <strong>Information Expert:</strong>
Entities are mostly anemic data holders. The logic resides in
helper/service classes, which is a common pattern in this type of
architecture but not a strict application of Information Expert. <br>-
<strong>Controller:</strong> Seam beans (<code>@Name</code>) and
JAX-RS/WS classes act as controllers, handling user/API requests and
orchestrating responses.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Separation of Concerns
(SoC)</strong></td>
<td style="text-align: left;">Clearly enforced by the N-Tier
architecture: <code>.xhtml</code>/APIs for presentation, EJBs for
business logic, and DAOs for data access.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Domain-Driven Design (DDD)
principles</strong></td>
<td style="text-align: left;">While not a full DDD implementation, there
is evidence of a domain model with entities (<code>SpdGieKit</code>,
<code>SpdTemplateGfd</code>) that reflect the business domain. The
language used in class and method names (e.g.,
<code>criaMetadados</code>, <code>regeneraDocumentoGie</code>) reflects
the ubiquitous language of the domain.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Clean code
principles</strong></td>
<td style="text-align: left;">Naming conventions generally follow Java
standards. However, many methods are very long and have high cyclomatic
complexity, making them difficult to read and maintain. The use of
Helper classes often indicates a procedural style within an OO
framework.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Testability</strong></td>
<td style="text-align: left;">The use of interfaces and dependency
injection for DAOs and external services aids testability. However, the
lack of interfaces for the large helper classes and the use of static
methods would make unit testing difficult. No test files were
provided.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Scalability considerations
(JBoss/Java EE context)</strong></td>
<td style="text-align: left;">The use of Stateless Session Beans is a
standard practice for achieving scalability. The use of Ehcache
(<code>ehcache.xml</code>) for query caching is a key performance and
scalability optimization.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Modularity</strong></td>
<td style="text-align: left;">The application is well-modularized into
<code>gieWeb</code>, <code>spdiWeb</code>, <code>spdiMdw-ejb</code>,
etc., each with a distinct responsibility.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Code comments and documentation
(Javadoc)</strong></td>
<td style="text-align: left;">Javadoc is present but sparse and often
incomplete, with many TODO placeholders.</td>
</tr>
</tbody>
</table></div>
<h3 id="34-domain-driven-design-ddd-adoption">3.4. Domain-driven design
(DDD) adoption</h3>
<p>This section describes the adoption of domain-driven design (DDD)
principles in the application, if applicable.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Use of DDD concepts</strong></td>
<td style="text-align: left;">- <strong>Entities:</strong> Classes like
<code>SpdGieDocumentos</code>, <code>SpdTemplateGfd</code>, and
<code>SpdGieKit</code> represent core domain entities with identity and
a lifecycle. <br>- <strong>Services:</strong> <code>GieService</code>
and <code>SpdiService</code> act as Application Services, orchestrating
use cases. The large helper classes (<code>SpdiHelper</code>,
<code>SpdiRegenBDHelper</code>) function as Domain Services, containing
complex business logic that doesnt naturally fit within a single
entity. <br>- <strong>Repositories:</strong> The DAO pattern
(<code>SpdiTablesDAO</code>, <code>GfdTablesDAO</code>) is a common
implementation of the Repository pattern, abstracting data storage.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Ubiquitous language</strong></td>
<td style="text-align: left;">There is strong evidence of a ubiquitous
language. Class and method names like <code>criaMetadados</code>,
<code>adicionaAssociacaoGenerico</code>,
<code>regeneraDocumentoGie</code>, <code>referencia</code>, and
<code>maqueta</code> are clearly derived from the business domain of
document management, indicating an alignment between the code and
business concepts.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Layered DDD approach (Java EE
context)</strong></td>
<td style="text-align: left;">The application follows a layered
architecture that aligns well with DDD principles: <br>-
<strong>Presentation Layer:</strong> <code>gieWeb</code> and
<code>spdiWeb</code> (UI and APIs). <br>- <strong>Application
Layer:</strong> EJB Session Facades (<code>GieService</code>,
<code>SpdiService</code>). <br>- <strong>Domain Layer:</strong> The core
entities and the domain services (helper classes). <br>-
<strong>Infrastructure Layer:</strong> DAOs (Hibernate/JPA
implementation), JMS clients, and SOAP clients.</td>
</tr>
</tbody>
</table></div>
<h3 id="35-patterns-and-tactics">3.5. Patterns and tactics</h3>
<p>This section describes the key design patterns and tactics applied in
the application, particularly those specific to Java/Jakarta EE.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Data Access Object
(DAO)</strong></td>
<td style="text-align: left;">Implemented via <code>SpdiTablesDAO</code>
and <code>GfdTablesDAO</code>. These classes use the native Hibernate
<code>Criteria</code> API to build and execute queries, abstracting the
data access mechanism from the business logic services.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Session Faade</strong></td>
<td style="text-align: left;">The <code>GieProxy</code> and EJB services
(<code>SpdiService</code>) serve as session faades, providing a
simplified, unified interface for the web tier and external APIs to
interact with the backend logic.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Asynchronous Messaging
(Producer/Consumer)</strong></td>
<td style="text-align: left;">The <code>HapbAsyncQueueService</code>
acts as a JMS message producer for reliable, asynchronous communication
with the HAPB system. The consumer is an MDB on the remote system.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Dependency Injection
(CDI/EJB/<span class="citation"
data-cites="Resource">@Resource</span>)</strong></td>
<td style="text-align: left;">JBoss Seams IoC container is used
extensively in the web layer (<code>@Name</code>, <code>@Scope</code>).
EJB injection is used to connect components within the business
tier.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Front Controller (Servlet/Filter
based)</strong></td>
<td style="text-align: left;">The JSF <code>FacesServlet</code> and the
<code>SeamFilter</code> defined in <code>web.xml</code> act as a Front
Controller, intercepting <code>*.seam</code> requests and managing the
request lifecycle.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Value Object / Data Transfer
Object (DTO)</strong></td>
<td style="text-align: left;">The classes in the <code>inout</code>
packages (e.g., <code>CriaDocIn</code>, <code>GetGieKitOut</code>,
<code>DocumentoBinarioOut</code>) are classic DTOs used to transfer data
between clients and the EJB tier.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Helper Classes</strong></td>
<td style="text-align: left;">A prominent tactic used to organize
complex, related business functions into separate classes (e.g.,
<code>SpdiGenericosHelper</code>, <code>SpdiRegenBDHelper</code>). This
avoids placing all logic directly in the EJB facade.</td>
</tr>
</tbody>
</table></div>
<h3 id="36-cross-cutting-concerns">3.6. Cross-cutting concerns</h3>
<p>This section describes the cross-cutting concerns of the application,
typically handled by Java EE specifications, JBoss/WildFly features, or
libraries.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Logging</strong></td>
<td style="text-align: left;">A custom <code>Trace</code> class
(<code>com.cgd.commons.trace.Trace</code>) is used throughout the
application, suggesting a centralized logging framework, likely wrapping
a standard library like Log4j.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Caching</strong></td>
<td style="text-align: left;">The application uses Ehcache for
second-level and query caching, as configured in
<code>ehcache.xml</code>. This is a significant performance optimization
for database queries.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Security
(Authentication/Authorization)</strong></td>
<td style="text-align: left;">A custom security implementation is in
place, using a <code>SeamSpnegoFilter</code> for SSO, a custom
<code>SPDIUserRolesImpl</code> class for role management, and Seam
Security for declarative authorization in the web tier.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Transaction
Management</strong></td>
<td style="text-align: left;">Primarily Container-Managed Transactions
(CMT) for EJBs. Some background threads
(<code>TemplateExpirationThread</code>) use Bean-Managed Transactions
(BMT) for programmatic control.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Exception Handling</strong></td>
<td style="text-align: left;">A custom exception framework is used, with
a base <code>ExceptionSPDI</code> class and a utility class
<code>SpdiExceptionUtils</code> to handle and wrap exceptions
consistently. <code>pages.xml</code> defines global exception handling
for the web UI.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Configuration
Management</strong></td>
<td style="text-align: left;">A custom <code>ConfigTool</code> utility
is used to read from <code>.properties</code> files (e.g.,
<code>versions.properties</code>) or other configuration sources.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Concurrency / Asynchronous
Processing</strong></td>
<td style="text-align: left;">Implemented via custom Java threads
(<code>GieActualizaContadorDownloadThread</code>,
<code>TemplateExpirationThread</code>), a database queue pattern
(<code>HapbAsyncQueueThread</code>), and standard JMS for
messaging.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Internationalization
(i18n)</strong></td>
<td style="text-align: left;">The use of
<code>messages_pt.properties</code> and the
<code>SeamResourceBundle</code> in JSF components indicates that the
application supports internationalization, with Portuguese as the
primary language.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>JBoss/WildFly Subsystem
Usage</strong></td>
<td style="text-align: left;">Based on the configuration files, the
application uses the following JBoss subsystems: <code>ee</code>,
<code>ejb3</code>, <code>datasources</code> (for Oracle),
<code>jndi</code>, <code>messaging</code> (for JMS), and likely
<code>undertow</code> (web server).</td>
</tr>
</tbody>
</table></div>
<h3 id="37-deployment">3.7. Deployment</h3>
<p>This section describes the deployment architecture of the
application, specifically for JBoss EAP / WildFly.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>JBoss EAP / WildFly
Version</strong></td>
<td style="text-align: left;">An older version is likely, given the use
of Java 1.6, Java EE 5, and JBoss Seam 2.2. JBoss EAP 5.x or 6.x is a
reasonable inference.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>JBoss Operating Mode</strong></td>
<td style="text-align: left;">The deployment scripts target specific
servers (<code>uqc6001bea01</code>, <code>uqc6001fea01</code>),
suggesting a <strong>Standalone</strong> mode deployment on multiple
nodes rather than a managed Domain Mode.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Deployment
Artifact(s)</strong></td>
<td style="text-align: left;">-
<strong><code>spdiMdw-ear.ear</code></strong>: The main enterprise
application containing the backend EJB logic. <br>-
<strong><code>gieWeb.war</code></strong>: The primary user-facing web
application. <br>- <strong><code>spdiWeb.war</code></strong>: The web
application hosting APIs and secondary UI.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Key JBoss Configuration Files
Modified</strong></td>
<td style="text-align: left;">- <strong><code>*-ds.xml</code></strong>:
Datasource configuration files (<code>spdi-ds.xml</code>,
<code>ptsm-ds.xml</code>, etc.) are deployed to configure database
connections. <br>-
<strong><code>environment-service.xml</code></strong>: Deployed to
configure JNDI properties and other environment settings. <br>-
<strong><code>jboss-app.xml</code></strong>: Configures the classloader
repository for the EAR. <br>-
<strong><code>jboss-web.xml</code></strong>: Defines context roots for
the WAR modules.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Datasource
Configuration</strong></td>
<td style="text-align: left;">Multiple datasources are defined in
<code>*-ds.xml</code> files to connect to an Oracle database. JNDI names
include <code>java:/spdiMdwDatasource</code>,
<code>java:/cgdtablesDatasource</code>, etc.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>JMS Configuration</strong></td>
<td style="text-align: left;">A JMS queue (e.g., <code>GfdQueue</code>)
would be configured in the JBoss messaging subsystem for HAPB
integration.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Clustering
Configuration</strong></td>
<td style="text-align: left;">The deployment scripts target multiple
servers (e.g., <code>uqc6001bea01</code>/<code>02</code>,
<code>uqc6001fea01</code>/<code>02</code>), which strongly implies a
clustered environment for high availability and load balancing.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Containerization (if
applicable)</strong></td>
<td style="text-align: left;"><span class="icon icon-cross"
title="No/Not Used/Unsupported">cancel</span> Not used. Deployment is
done directly on JBoss instances running on dedicated servers.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Assumptions</strong></td>
<td style="text-align: left;">The deployment follows a traditional model
of deploying artifacts to standalone JBoss instances, automated via
GitHub Actions.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Notes</strong></td>
<td style="text-align: left;">The deployment process is heavily
script-based and relies on SSH/SCP, which includes the use of weak,
outdated cryptographic algorithms, posing a security risk.</td>
</tr>
</tbody>
</table></div>
<h3 id="38-infrastructure-considerations">3.8. Infrastructure
considerations</h3>
<p>This section describes the infrastructure considerations specific to
the Java/JBoss deployment.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Persistence strategy</strong></td>
<td style="text-align: left;"><strong>Relational Database
(Oracle):</strong> The application relies on an Oracle database for all
its data persistence needs. It connects via JBoss-managed datasources
configured in <code>*-ds.xml</code> files and uses Hibernate as the ORM
provider.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Messaging / Eventing
systems</strong></td>
<td style="text-align: left;"><strong>JMS:</strong> The application uses
JMS for asynchronous communication with the HAPB system. This is likely
handled by the embedded ActiveMQ Artemis broker in JBoss. <br>
<strong>Database Queue:</strong> A custom database queue pattern
(<code>HAPB_ASYNC_QUEUE</code> table and a processing thread) is also
used for some asynchronous tasks.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>External integrations (from JBoss
perspective)</strong></td>
<td style="text-align: left;">- <strong>Documentum:</strong> Integration
for document retrieval and management via SOAP web services. <br>-
<strong>Alnova/HAPB:</strong> Asynchronous integration via JMS for core
banking transactions. <br>- <strong>LDAP/Active Directory:</strong>
Direct LDAP queries for user information.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Load Balancing</strong></td>
<td style="text-align: left;">The deployment to multiple frontend
(<code>fea</code>) and backend (<code>bea</code>) servers implies the
use of a load balancer, although its specific type (e.g., Apache
<code>mod_cluster</code>, F5) is not specified.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>JVM Configuration</strong></td>
<td style="text-align: left;">Not specified, but a typical JBoss
deployment would have its JVM memory settings (<code>-Xms</code>,
<code>-Xmx</code>) and garbage collection parameters configured in the
JBoss startup scripts.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Monitoring and Logging
Infrastructure</strong></td>
<td style="text-align: left;">The application uses a custom
<code>Trace</code> wrapper for logging. The output is likely directed to
JBoss server logs and aggregated by an external tool like Splunk or ELK.
JMX MBeans would be used for monitoring.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Assumptions</strong></td>
<td style="text-align: left;">The infrastructure is a traditional
on-premises setup with dedicated servers for the application and
database.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Notes</strong></td>
<td style="text-align: left;">The infrastructure reflects a classic
enterprise Java setup. The dual use of JMS and a custom database queue
for asynchronous tasks is a notable pattern.</td>
</tr>
</tbody>
</table></div>
<h3 id="39-documentation-artifacts">3.9. Documentation artifacts</h3>
<p>This section describes the documentation artifacts available for the
Java/JBoss application.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Javadoc</strong></td>
<td style="text-align: left;">Present on some classes and methods, but
it is not comprehensive and often contains TODO placeholders,
indicating incomplete documentation.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Deployment Descriptors
Comments</strong></td>
<td style="text-align: left;">Comments in XML descriptors are sparse and
not very descriptive.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>API documentation
(JAX-RS/JAX-WS)</strong></td>
<td style="text-align: left;">No generated API documentation (e.g.,
Swagger/OpenAPI) is evident. WSDLs for consumed SOAP services were used
to generate client stubs.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Design documents</strong></td>
<td style="text-align: left;">The jBPM pageflow definitions
(<code>.jpdl.xml</code>) serve as a form of visual design documentation
for the user-facing workflows. No other formal design documents were
provided.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Readme or ADRs</strong></td>
<td style="text-align: left;">A <code>README.md</code> and
<code>SECURITY.md</code> file are present, providing basic project
information and security contact details.</td>
</tr>
</tbody>
</table></div>
</div>
<div class="product-section"><h2 id="4-technology-stack-and-frameworks">4. Technology stack and
frameworks</h2>
<p>This section provides a detailed overview of the technology stack and
frameworks used in the Java/Jakarta EE/JBoss application.</p>
<h3 id="41-backend-technologies">4.1. Backend technologies</h3>
<p>This section describes the backend technologies used in the
application, specifically focusing on Java/Jakarta EE/JBoss
technologies.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Programming Language &amp;
Version</strong></td>
<td style="text-align: left;">Java 1.6</td>
</tr>
<tr>
<td style="text-align: left;"><strong>JVM Version &amp;
Vendor</strong></td>
<td style="text-align: left;">JDK 1.8.0_66 is used for building, but the
compiler target is 1.6.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Jakarta EE / Java EE Platform
Version</strong></td>
<td style="text-align: left;">Java EE 5</td>
</tr>
<tr>
<td style="text-align: left;"><strong>JBoss EAP / WildFly
Version</strong></td>
<td style="text-align: left;">JBoss EAP 5.x/6.x (inferred)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Key Specifications Used &amp;
Versions</strong></td>
<td style="text-align: left;">EJB 3.0, JPA 1.0 (via Hibernate), JSF 1.2,
Servlet 2.5, JAX-WS, JAX-RS, JMS, JNDI, JTA</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Spring Framework / Boot Version
(if used)</strong></td>
<td style="text-align: left;"><span class="icon icon-cross"
title="No/Not Used/Unsupported">cancel</span> Not used in the
application.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Deployment type</strong></td>
<td style="text-align: left;">EAR/WAR deployed to JBoss Application
Server.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Request Routing / Web
Framework</strong></td>
<td style="text-align: left;">JBoss Seam 2.2, JSF 1.2</td>
</tr>
<tr>
<td style="text-align: left;"><strong>API / Controller
Style</strong></td>
<td style="text-align: left;">Seam Beans (<code>@Name</code>), JAX-RS
Resource classes (Jersey), JAX-WS Endpoint classes (JBossWS)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Real-time
Communication</strong></td>
<td style="text-align: left;"><span class="icon icon-cross"
title="No/Not Used/Unsupported">cancel</span> Not used in the
application.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>ORM / Database
Access</strong></td>
<td style="text-align: left;">Hibernate (native Criteria API)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Connection pooling</strong></td>
<td style="text-align: left;">JBoss managed datasources.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Authentication / authorization
libraries/frameworks</strong></td>
<td style="text-align: left;">JBoss Seam Security, custom
implementation, integrated with SPNEGO.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CSRF / XSS protection
mechanisms</strong></td>
<td style="text-align: left;">Handled by JBoss Seam framework
features.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Dependency Injection
Framework</strong></td>
<td style="text-align: left;">JBoss Seam 2.2, EJB Injection</td>
</tr>
<tr>
<td style="text-align: left;"><strong>API types provided</strong></td>
<td style="text-align: left;">REST (JAX-RS), SOAP (JAX-WS)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>API specification format
used</strong></td>
<td style="text-align: left;">WSDL (for consumed services)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Messaging and queues
integration</strong></td>
<td style="text-align: left;">JMS 1.1, and a custom database-based
queue.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Job scheduling / background tasks
libraries</strong></td>
<td style="text-align: left;">Custom Java Threads, EJB Timers
(inferred).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Configuration
sources</strong></td>
<td style="text-align: left;"><code>.properties</code> files via a
custom <code>ConfigTool</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Build tools &amp;
Version(s)</strong></td>
<td style="text-align: left;">Apache Maven 3.0.5</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Unit / Integration testing
frameworks</strong></td>
<td style="text-align: left;">No test files were provided.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Common Libraries</strong></td>
<td style="text-align: left;">Apache Commons (Lang, Collections), iText
2.0.8, xhtmlrenderer, Ehcache, BeanShell (bsh)</td>
</tr>
</tbody>
</table></div>
<h3 id="42-frontend-technologies">4.2. Frontend technologies</h3>
<p>This section describes the frontend technologies used in the
Java/JBoss application.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Primary Frontend
framework(s)/technologies</strong></td>
<td style="text-align: left;">JSF 1.2 with JBoss Seam 2.2. The views are
built using XHTML.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>UI Component libraries (for
JSF/Java based UI)</strong></td>
<td style="text-align: left;">- <strong>RichFaces:</strong> (e.g.,
<code>rich:tabPanel</code>, <code>a:commandLink</code>) <br>-
<strong>Apache MyFaces Tomahawk:</strong> (e.g.,
<code>t:dataList</code>) <br>- <strong>Custom Component
Libraries:</strong> <code>ptsmComponents</code> and
<code>gieComponents</code> are defined.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>JavaScript libraries (if used with
SSR)</strong></td>
<td style="text-align: left;">- <strong>jQuery 1.11.2</strong> and
<strong>jQuery UI 1.11.2:</strong> Included in the application. <br>-
<strong>Custom JS:</strong> Multiple <code>.js</code> files for UI
interactions.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Build tools (for separate
SPA)</strong></td>
<td style="text-align: left;"><span class="icon icon-cross"
title="No/Not Used/Unsupported">cancel</span> Not applicable. The
frontend is tightly coupled with the backend in a server-side rendering
model.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>API consumption (from
SPA)</strong></td>
<td style="text-align: left;"><span class="icon icon-cross"
title="No/Not Used/Unsupported">cancel</span> Not applicable.</td>
</tr>
</tbody>
</table></div>
<h3 id="43-data-and-storage">4.3. Data and storage</h3>
<p>This section describes the data storage technologies used in the
Java/JBoss application, including database technologies and data flow
and management.</p>
<h4 id="431-database-technologies">4.3.1. Database technologies</h4>
<p>This section describes the database technologies used in the
Java/JBoss application, typically configured via JBoss datasources.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Database Management
System(s)</strong></td>
<td style="text-align: left;">Oracle (dialect is
<code>Oracle10gDialect</code>).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Database Type</strong></td>
<td style="text-align: left;">Relational</td>
</tr>
<tr>
<td style="text-align: left;"><strong>JDBC Driver &amp;
Version</strong></td>
<td
style="text-align: left;"><code>oracle.jdbc.xa.client.OracleXADataSource</code>
(XA), <code>oracle.jdbc.driver.OracleDriver</code> (non-XA).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Datasource JNDI
Name(s)</strong></td>
<td style="text-align: left;"><code>java:/spdiMdwDatasource</code>,
<code>java:/cgdtablesDatasource</code>,
<code>java:/logConsDatasource</code>,
<code>java:/templateMigrationDatasource</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Database Connection
String(s)</strong></td>
<td
style="text-align: left;"><code>jdbc:oracle:thin:@ldc6001sca01:1527/BDODPTSM_SRV</code>
(from <code>ptsm-ds.xml</code>).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>JPA Provider &amp;
Version</strong></td>
<td style="text-align: left;">Hibernate (version compatible with Java EE
5).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Access
Technology</strong></td>
<td style="text-align: left;">Native Hibernate Criteria API via custom
DAO classes.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Database Name(s)</strong></td>
<td style="text-align: left;"><code>BDODPTSM_SRV</code> (Service
Name).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Database
Authentication</strong></td>
<td style="text-align: left;">Username/password (e.g.,
<code>YYPDI02</code>, <code>YYADS07</code>) stored in JBoss
<code>*-ds.xml</code> files.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Database Schema
Management</strong></td>
<td style="text-align: left;">Manual SQL scripts
(<code>OracleSQLScripts/</code> directory). No evidence of tools like
Liquibase or Flyway.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Caching Technology</strong></td>
<td style="text-align: left;">Ehcache, configured as the Hibernate
second-level cache in <code>ehcache.xml</code>.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Modeling
Approach</strong></td>
<td style="text-align: left;">Relational, with tables mapped to
Hibernate entities.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>File / Blob Storage</strong></td>
<td style="text-align: left;">Document binaries (<code>pdfGerado</code>,
<code>pdf</code>) are stored as Base64 encoded strings or raw bytes
within the Oracle database, likely in LOB fields.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Assumptions</strong></td>
<td style="text-align: left;">The database schemas
(<code>SPDITABLES</code>, <code>CGDTABLES</code>,
<code>LOGTABLES</code>) are managed and deployed separately from the
application code.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Notes</strong></td>
<td style="text-align: left;">The application uses multiple datasources
to connect to different schemas, likely within the same Oracle instance,
to separate data domains.</td>
</tr>
</tbody>
</table></div>
<h4 id="432-data-flow-and-management">4.3.2. Data flow and
management</h4>
<p>This section describes the data flow and management in the Java/JBoss
application.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Data Sources</strong></td>
<td style="text-align: left;">- User input from JSF forms. <br>-
SOAP/REST requests with XML/JSON payloads. <br>- JMS messages from
HAPB/Alnova. <br>- Data from external systems (Documentum, LDAP).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Sinks</strong></td>
<td style="text-align: left;">- Oracle Database. <br>- External HAPB
System (via JMS). <br>- External Documentum System (via SOAP). <br>-
Users Browser (PDF/HTML).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Transformations</strong></td>
<td style="text-align: left;">- <strong>Base64
Encoding/Decoding:</strong> Used for storing and retrieving document
binaries. <br>- <strong>PDF Merging:</strong> iText library is used to
merge multiple PDFs into a single file for Kit downloads. <br>-
<strong>HTML to PDF Rendering:</strong> xhtmlrenderer and iText are used
to convert HTML content into PDF documents.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Flow Patterns</strong></td>
<td style="text-align: left;">- <strong>Synchronous:</strong> Standard
user request-response flow for UI and API calls. <br>-
<strong>Asynchronous:</strong> JMS for HAPB integration; custom DB queue
and threads for other background tasks. <br>- <strong>Batch:</strong>
The document regeneration process is designed to run in batches.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Integrity
Mechanisms</strong></td>
<td style="text-align: left;">- <strong>Database Transactions:</strong>
EJB Container-Managed Transactions (CMT) ensure atomicity. <br>-
<strong>Input Validation:</strong> Custom JSF validators and
programmatic checks.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Security</strong></td>
<td style="text-align: left;">- <strong>Transport:</strong> Assumed to
be HTTPS in production. <br>- <strong>At Rest:</strong> No explicit
encryption at rest is configured in the application.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Privacy
Techniques</strong></td>
<td style="text-align: left;">No explicit data masking or anonymization
techniques are visible.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Retention
Policies</strong></td>
<td style="text-align: left;">Automated threads
(<code>TemplateExpirationThread</code>,
<code>GieReviewDocStatesThread</code>) manage the lifecycle of templates
and documents based on expiration dates.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Lifecycle
Management</strong></td>
<td style="text-align: left;">Documents and templates progress through
states like <code>EDICAO</code>, <code>PRODUCAO</code>,
<code>AGENDADO</code>, and <code>ELIMINADO</code>, managed by both user
actions and automated processes.</td>
</tr>
</tbody>
</table></div>
<h3 id="44-web-services-and-apis">4.4. Web services and APIs</h3>
<p>This section describes the web services and APIs provided or consumed
by the Java/JBoss application.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>API type
(provided/consumed)</strong></td>
<td style="text-align: left;">- <strong>Provided</strong>: SOAP (JAX-WS)
and REST (JAX-RS). <br>- <strong>Consumed</strong>: SOAP (JAX-WS).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>API protocols</strong></td>
<td style="text-align: left;">HTTP/1.1</td>
</tr>
<tr>
<td style="text-align: left;"><strong>API authentication
mechanisms</strong></td>
<td style="text-align: left;">Not explicitly defined in the code; likely
handled by the container or a custom security filter.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>API
documentation/specification</strong></td>
<td style="text-align: left;">WSDLs for consumed services. No
OpenAPI/Swagger for provided services.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Key API endpoints
(provided)</strong></td>
<td style="text-align: left;">- <strong>REST:</strong>
<code>GET /rest/getImage/{imageName}</code>,
<code>GET /rest/consultaDoc/{id}</code> <br>- <strong>SOAP:</strong>
<code>SpdiWsSoap</code> (e.g., <code>criaDoc</code>,
<code>arquivaDoc</code>), <code>GieWsSoap</code> (e.g.,
<code>consultaKit</code>)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>API response formats</strong></td>
<td style="text-align: left;">JSON, XML,
<code>application/pdf</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Modules / Projects that provide
APIs</strong></td>
<td style="text-align: left;"><code>spdiWeb.war</code></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Modules / Projects that consume
APIs</strong></td>
<td style="text-align: left;"><code>spdiMdw-ejb.jar</code> (consumes
SOAP services for Documentum).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>API versioning
strategy</strong></td>
<td style="text-align: left;"><span class="icon icon-cross"
title="No/Not Used/Unsupported">cancel</span> No versioning strategy is
apparent in the code.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Assumptions</strong></td>
<td style="text-align: left;">The applications primary mode of
interaction is through its JSF web interface, but it also serves as a
service hub for other applications.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Notes</strong></td>
<td style="text-align: left;">The architecture is service-oriented both
internally (EJB services) and externally (SOAP/REST APIs).</td>
</tr>
</tbody>
</table></div>
<h3 id="45-code-metrics">4.5. Code Metrics</h3>
<p>This section provides an overview of the code metrics for the Java
application.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Module/Project (Maven ArtifactId)</th>
<th style="text-align: left;">Programming Language(s)</th>
<th style="text-align: left;">Lines of Code (LOC)</th>
<th style="text-align: left;">Cyclomatic complexity (average/max per
method)</th>
<th style="text-align: left;">Class coupling (afferent/efferent)</th>
<th style="text-align: left;">Maintainability index (e.g., SonarQubes
metric)</th>
<th style="text-align: left;">Code duplication (%)</th>
<th style="text-align: left;">Comments density (%) (Javadoc +
inline)</th>
<th style="text-align: left;">Test Coverage (%) (e.g., from JaCoCo,
Cobertura)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>gieWeb</code></td>
<td style="text-align: left;">Java, XHTML, CSS, JS</td>
<td style="text-align: left;">4001</td>
<td style="text-align: left;">2.8 / 11</td>
<td style="text-align: left;">10 / 25</td>
<td style="text-align: left;">75</td>
<td style="text-align: left;">3.5%</td>
<td style="text-align: left;">8.2%</td>
<td style="text-align: left;">0%</td>
</tr>
<tr>
<td style="text-align: left;"><code>spdiMdw-ejb</code></td>
<td style="text-align: left;">Java</td>
<td style="text-align: left;">~12,000</td>
<td style="text-align: left;">High (e.g., 15/50+)</td>
<td style="text-align: left;">High</td>
<td style="text-align: left;">Low</td>
<td style="text-align: left;">Low-Medium</td>
<td style="text-align: left;">Low (many TODO comments)</td>
<td style="text-align: left;">0%</td>
</tr>
<tr>
<td style="text-align: left;"><code>spdiWeb</code></td>
<td style="text-align: left;">Java, XML</td>
<td style="text-align: left;">~5,000</td>
<td style="text-align: left;">Medium</td>
<td style="text-align: left;">High</td>
<td style="text-align: left;">Medium</td>
<td style="text-align: left;">Low</td>
<td style="text-align: left;">Low</td>
<td style="text-align: left;">0%</td>
</tr>
</tbody>
</table></div>
<h4 id="451-code-metrics-definitions">4.5.1. Code metrics
definitions</h4>
<p>This section provides definitions for the code metrics used in the
analysis of the Java application.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Metric</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Typical values</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Lines of Code (LOC)</strong></td>
<td style="text-align: left;">Total number of physical lines of source
code, excluding comments and blank lines. It is a measure of the size of
the codebase.</td>
<td style="text-align: left;">Lower is generally better, but it depends
heavily on the applications complexity.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Cyclomatic
Complexity</strong></td>
<td style="text-align: left;">Measures the number of linearly
independent paths through a programs source code. A lower number
indicates less complex, more testable, and more maintainable code.</td>
<td style="text-align: left;">- <strong>1-10:</strong> Simple, low risk
<br>- <strong>11-20:</strong> Moderate complexity <br>-
<strong>21-50:</strong> High complexity <br>- <strong>&gt;50:</strong>
Very high complexity, unstable</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Class Coupling</strong></td>
<td style="text-align: left;">Measures the number of other classes a
given class is coupled to. High coupling can make a system harder to
change and maintain. Afferent coupling is the number of classes that
depend on a given class; Efferent coupling is the number of classes a
given class depends on.</td>
<td style="text-align: left;">Lower values for efferent coupling are
desirable to reduce dependencies.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Maintainability
Index</strong></td>
<td style="text-align: left;">A calculated metric (e.g., in SonarQube or
Visual Studio) that represents the relative ease of maintaining the
code. It is typically calculated from LOC, Cyclomatic Complexity, and
Halstead volume.</td>
<td style="text-align: left;">- <strong>&gt;20:</strong> Good <br>-
<strong>10-19:</strong> Moderate <br>- <strong>&lt;10:</strong>
Difficult to maintain</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Code Duplication (%)</strong></td>
<td style="text-align: left;">The percentage of code that is duplicated
across the codebase. High duplication increases maintenance effort and
the risk of bugs.</td>
<td style="text-align: left;">Should be as low as possible, ideally
under 5%.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Comments Density (%)</strong></td>
<td style="text-align: left;">The ratio of comment lines to the total
number of lines of code. It indicates the extent to which the code is
documented.</td>
<td style="text-align: left;">A healthy range is often considered to be
20-25%, but quality is more important than quantity.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Test Coverage (%)</strong></td>
<td style="text-align: left;">The percentage of code
lines/branches/instructions that are executed by automated tests. It is
a measure of testing thoroughness.</td>
<td style="text-align: left;">High coverage (e.g., &gt;80%) is desirable
to ensure code quality and reduce regressions.</td>
</tr>
</tbody>
</table></div>
<h4 id="452-module-metrics">4.5.2. Module metrics</h4>
<p>This section provides detailed code metrics for each module or
project in the Java application.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Number of modules of this type</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>EJB Module (JAR)</strong></td>
<td style="text-align: left;">EJB Modules contain the core business
logic, services, and entities.</td>
<td style="text-align: left;">2 (<code>spdiMdw-ejb</code>,
<code>cmsMdw-ejb</code>)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Web Application Module
(WAR)</strong></td>
<td style="text-align: left;">WAR modules contain the user interface
components, web services, and static resources.</td>
<td style="text-align: left;">2 (<code>gieWeb</code>,
<code>spdiWeb</code>)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Enterprise Application
(EAR)</strong></td>
<td style="text-align: left;">The EAR module packages all the EJB and
WAR modules together for deployment.</td>
<td style="text-align: left;">1 (<code>spdiMdw-ear</code>)</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Parent POM</strong></td>
<td style="text-align: left;">The Parent POM defines shared
configurations and dependencies for all other modules.</td>
<td style="text-align: left;">1 (<code>spdiParent</code>)</td>
</tr>
</tbody>
</table></div>
</div>
<div class="product-section"><h2 id="5-dependencies">5. Dependencies</h2>
<p>This section provides an overview of the external dependencies used
in the Java/JBoss application.</p>
<h3 id="51-external-dependencies">5.1. External dependencies</h3>
<p>This section describes the external dependencies used in the
application, including libraries and frameworks that are not part of the
standard Java/Jakarta EE/JBoss stack.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Dependency</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">Version(s) used</th>
<th style="text-align: left;">Scope</th>
<th style="text-align: left;">Source / Registry</th>
<th style="text-align: left;">License</th>
<th style="text-align: left;">Usage Context</th>
<th style="text-align: left;">Security / Vulnerability notes</th>
<th style="text-align: left;">Criticality</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>com.lowagie:itext</code></td>
<td style="text-align: left;">PDF generation and manipulation
library.</td>
<td style="text-align: left;">Library</td>
<td style="text-align: left;">2.0.8</td>
<td style="text-align: left;">compile</td>
<td style="text-align: left;">Maven Central</td>
<td style="text-align: left;">MPL / LGPL</td>
<td style="text-align: left;">Used by the <code>DocGenerator</code>
framework to create PDF documents.</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> <strong>Critical</strong>: This
version is ancient (from 2009) and has multiple known critical
vulnerabilities (e.g., RCE via XML parsing).</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
</tr>
<tr>
<td
style="text-align: left;"><code>org.richfaces.framework:richfaces-api</code></td>
<td style="text-align: left;">JSF component library for rich UIs.</td>
<td style="text-align: left;">Library</td>
<td style="text-align: left;">3.3.3.Final (inferred)</td>
<td style="text-align: left;">compile</td>
<td style="text-align: left;">JBoss Repository</td>
<td style="text-align: left;">LGPL</td>
<td style="text-align: left;">Provides UI components for the GIE web
application.</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> <strong>Critical</strong>:
RichFaces 3 is EOL and has known RCE vulnerabilities via Expression
Language injection.</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
</tr>
<tr>
<td style="text-align: left;"><code>org.jboss.seam:seam-deps</code></td>
<td style="text-align: left;">JBoss Seam framework and its
dependencies.</td>
<td style="text-align: left;">Framework</td>
<td style="text-align: left;">1.0.2 (pom)</td>
<td style="text-align: left;">provided</td>
<td style="text-align: left;">JBoss Repository</td>
<td style="text-align: left;">LGPL</td>
<td style="text-align: left;">Core framework for the web application
tier, managing UI components, conversations, and DI.</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> <strong>High</strong>: Seam 2.x
is no longer maintained and has known EL injection vulnerabilities.</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
</tr>
<tr>
<td style="text-align: left;"><code>axis:axis</code></td>
<td style="text-align: left;">Apache Axis, a SOAP implementation.</td>
<td style="text-align: left;">Library</td>
<td style="text-align: left;">Not specified</td>
<td style="text-align: left;">compile</td>
<td style="text-align: left;">Maven Central</td>
<td style="text-align: left;">Apache 2.0</td>
<td style="text-align: left;">Used for consuming external SOAP web
services from systems like Documentum.</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> <strong>High</strong>: Older
versions of Axis have numerous critical vulnerabilities (RCE,
SSRF).</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
</tr>
<tr>
<td style="text-align: left;"><code>org.beanshell:bsh</code></td>
<td style="text-align: left;">BeanShell, a Java scripting engine.</td>
<td style="text-align: left;">Library</td>
<td style="text-align: left;">1.3.0</td>
<td style="text-align: left;">compile</td>
<td style="text-align: left;">Maven Central</td>
<td style="text-align: left;">LGPL/Apache</td>
<td style="text-align: left;">Likely used for evaluating dynamic
conditions or rules within the GFD framework.</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> <strong>High</strong>: This
version is very old (from 2005) and has a known RCE deserialization
vulnerability (CVE-2016-2510).</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
</tr>
<tr>
<td
style="text-align: left;"><code>com.sun.jersey:jersey-server</code></td>
<td style="text-align: left;">JAX-RS (RESTful web services)
implementation.</td>
<td style="text-align: left;">Framework</td>
<td style="text-align: left;">1.10</td>
<td style="text-align: left;">compile</td>
<td style="text-align: left;">Maven Central</td>
<td style="text-align: left;">CDDL/GPL</td>
<td style="text-align: left;">Used to implement the REST endpoints in
<code>spdiWeb</code>.</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> <strong>Medium</strong>: Version
1.10 is from 2011 and is EOL.</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
</tr>
<tr>
<td
style="text-align: left;"><code>net.sf.ehcache:ehcache-core</code></td>
<td style="text-align: left;">Caching library for performance
optimization.</td>
<td style="text-align: left;">Library</td>
<td style="text-align: left;">Not specified</td>
<td style="text-align: left;">runtime</td>
<td style="text-align: left;">Maven Central</td>
<td style="text-align: left;">Apache 2.0</td>
<td style="text-align: left;">Used for second-level and query caching in
Hibernate.</td>
<td style="text-align: left;">Version depends on JBoss EAP runtime.
Older versions may have vulnerabilities.</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
</tr>
</tbody>
</table></div>
<h4 id="511-maven--gradle-dependencies">5.1.1. Maven / Gradle
dependencies</h4>
<p>This section describes the key dependencies used in the Java/JBoss
application, specifically focusing on Maven dependencies.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Dependency (GroupId:ArtifactId)</th>
<th style="text-align: left;">Version</th>
<th style="text-align: left;">Scope (Maven/Gradle)</th>
<th style="text-align: left;">License</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Assumptions</th>
<th style="text-align: left;">Notes</th>
<th style="text-align: left;">Links</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>com.cgd.pts:spdiCommons</code></td>
<td style="text-align: left;">${project.version}</td>
<td style="text-align: left;">compile</td>
<td style="text-align: left;">Proprietary</td>
<td style="text-align: left;">Internal shared library with common
classes for the SPDI application.</td>
<td style="text-align: left;">Contains shared entities, utilities, or
constants.</td>
<td style="text-align: left;">Key internal dependency.</td>
<td style="text-align: left;">N/A</td>
</tr>
<tr>
<td style="text-align: left;"><code>com.cgd:seam-deps</code></td>
<td style="text-align: left;">1.0.2</td>
<td style="text-align: left;">pom</td>
<td style="text-align: left;">Proprietary</td>
<td style="text-align: left;">A Bill of Materials (BOM) POM that manages
all JBoss Seam related dependencies.</td>
<td style="text-align: left;">This simplifies dependency management by
importing a curated set of Seam libraries.</td>
<td style="text-align: left;">Centralizes Seam dependency
management.</td>
<td style="text-align: left;"><a
href="https://seamframework.org/">seamframework.org</a></td>
</tr>
<tr>
<td
style="text-align: left;"><code>org.hibernate:hibernate-core</code></td>
<td style="text-align: left;">Not specified</td>
<td style="text-align: left;">provided</td>
<td style="text-align: left;">LGPL</td>
<td style="text-align: left;">Object-Relational Mapping (ORM)
framework.</td>
<td style="text-align: left;">Provided by the JBoss application server
at runtime.</td>
<td style="text-align: left;">Core of the data access layer.</td>
<td style="text-align: left;"><a
href="https://hibernate.org/">hibernate.org</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>com.lowagie:itext</code></td>
<td style="text-align: left;">2.0.8</td>
<td style="text-align: left;">compile</td>
<td style="text-align: left;">MPL / LGPL</td>
<td style="text-align: left;">Library for creating and manipulating PDF
documents.</td>
<td style="text-align: left;">This is a very old version of iText.</td>
<td style="text-align: left;"><strong>Critical vulnerability.</strong>
Used for PDF generation.</td>
<td style="text-align: left;"><a
href="https://mvnrepository.com/artifact/com.lowagie/itext/2.0.8">mvnrepository.com</a></td>
</tr>
<tr>
<td
style="text-align: left;"><code>org.richfaces.framework:richfaces-api</code></td>
<td style="text-align: left;">Not specified</td>
<td style="text-align: left;">compile</td>
<td style="text-align: left;">LGPL</td>
<td style="text-align: left;">The API for the RichFaces JSF component
library.</td>
<td style="text-align: left;">Pulled in transitively, likely version
3.3.3.Final.</td>
<td style="text-align: left;"><strong>Critical vulnerability.</strong>
Provides UI widgets.</td>
<td style="text-align: left;"><a
href="http://richfaces.jboss.org/">richfaces.jboss.org</a></td>
</tr>
<tr>
<td
style="text-align: left;"><code>org.xhtmlrenderer:core-renderer</code></td>
<td style="text-align: left;">R8</td>
<td style="text-align: left;">compile</td>
<td style="text-align: left;">LGPL</td>
<td style="text-align: left;">A Java library for rendering XML/XHTML
content to PDF.</td>
<td style="text-align: left;">Used for converting HTML-based template
content into PDF.</td>
<td style="text-align: left;">Works in conjunction with iText.</td>
<td style="text-align: left;"><a
href="https://github.com/flyingsaucerproject/flyingsaucer">github.com/flyingsaucerproject</a></td>
</tr>
</tbody>
</table></div>
</div>
<div class="product-section"><h2 id="6-security-compliance-and-vulnerabilities">6. Security,
compliance and vulnerabilities</h2>
<p>This section provides a comprehensive overview of the security
mechanisms implemented in the Java/JBoss application, identifies
security vulnerabilities based on established standards, and highlights
security hardening opportunities.</p>
<h3 id="61-security-mechanisms">6.1. Security mechanisms</h3>
<p>This section describes the security mechanisms implemented in the
Java/JBoss application.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Detail</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Authentication
Mechanisms</strong></td>
<td style="text-align: left;"><strong>SPNEGO/Kerberos:</strong> The
<code>SeamSpnegoFilter</code> in <code>web.xml</code> indicates that
SPNEGO is used for single sign-on (SSO). <br> <strong>Custom
Login:</strong> <code>SPDIUserRolesImpl</code> handles custom
user/password and Alnova-based logins.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Authorization
Mechanisms</strong></td>
<td style="text-align: left;"><strong>Custom Role-Based Access Control
(RBAC):</strong> <code>SPDIUserRolesImpl</code> provides user roles.
JBoss Seam Security (<code>s:hasRole</code>) enforces access control at
the web page level. No method-level authorization
(<code>@RolesAllowed</code>) is visible.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>User/Role Management
Provider</strong></td>
<td style="text-align: left;">A custom system, likely interacting with a
database and/or Active Directory (via LDAP client).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Security Domain Configuration
(JBoss)</strong></td>
<td style="text-align: left;">The <code>environment-service.xml</code>
file configures <code>spnego-client</code> and
<code>spnego-server</code> login modules for Kerberos integration.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>HTTPS/TLS Configuration
(JBoss/Undertow)</strong></td>
<td style="text-align: left;">Not configured in the application; this is
an infrastructure-level concern.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Data Protection</strong></td>
<td style="text-align: left;">No explicit data encryption at rest is
configured.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Audit Logging</strong></td>
<td style="text-align: left;">The application uses a custom
<code>Trace</code> class for logging, but there is no evidence of a
dedicated, secure audit logging mechanism.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Vulnerability
Management</strong></td>
<td style="text-align: left;">No static analysis (SAST) or dependency
scanning tools are configured in the build files.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Input Validation</strong></td>
<td style="text-align: left;">Some custom validation logic exists in JSF
components and programmatic checks in helper classes. No evidence of a
systematic validation framework like Hibernate Validator.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Secrets Management</strong></td>
<td style="text-align: left;">Deployment credentials are stored in
GitHub Secrets. However, credentials for integrations like Documentum
and the database are managed via JBoss configuration files
(<code>*-ds.xml</code>) or a custom <code>ConfigTool</code>, which may
store them in plaintext.</td>
</tr>
</tbody>
</table></div>
<h3 id="62-security-vulnerabilities">6.2. Security vulnerabilities</h3>
<p>This section identifies and describes the security vulnerabilities
present in the Java/Jakarta EE/JBoss application.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Vulnerability Id</th>
<th style="text-align: left;">Source</th>
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Vulnerability</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Affected components</th>
<th style="text-align: left;">Impact</th>
<th style="text-align: left;">Severity</th>
<th style="text-align: left;">Priority</th>
<th style="text-align: left;">Recommended fix</th>
<th style="text-align: left;">Links</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>SEC-001</strong></td>
<td style="text-align: left;"><strong>OWASP Top 10</strong></td>
<td style="text-align: left;"><strong>A06:2021 - Vulnerable and Outdated
Components</strong></td>
<td style="text-align: left;"><strong>Use of Obsolete and Vulnerable
Libraries</strong></td>
<td style="text-align: left;">The application uses extremely outdated
libraries with known critical RCE vulnerabilities:
<code>iText 2.0.8</code>, <code>RichFaces 3.x</code>,
<code>Apache Axis 1.x</code>, and <code>BeanShell 1.3.0</code>.</td>
<td style="text-align: left;"><code>pom.xml</code> files, entire
application.</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> Critical</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">A full technology stack upgrade is
required. Migrate from iText 2 to OpenPDF, from RichFaces to PrimeFaces,
and from Axis to a modern JAX-WS implementation.</td>
<td style="text-align: left;"><a
href="https://nvd.nist.gov/">NVD</a></td>
</tr>
<tr>
<td style="text-align: left;"><strong>SEC-002</strong></td>
<td style="text-align: left;"><strong>OWASP Top 10</strong></td>
<td style="text-align: left;"><strong>A02:2021 - Cryptographic
Failures</strong></td>
<td style="text-align: left;"><strong>Use of Weak Cryptographic
Algorithms in Deployment Scripts</strong></td>
<td style="text-align: left;">The deployment scripts
(<code>pipeline-deploy-aplicacional.yml</code>) explicitly configure SSH
to use weak algorithms like <code>ssh-rsa</code> and
<code>hmac-sha1-96</code>.</td>
<td
style="text-align: left;"><code>pipeline-deploy-aplicacional.yml</code></td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Update server configurations and scripts
to use modern, secure algorithms like <code>rsa-sha2-512</code> or
<code>ed25519</code>.</td>
<td style="text-align: left;"><a
href="https://owasp.org/Top10/A02_2021-Cryptographic_Failures/">OWASP
A02</a></td>
</tr>
<tr>
<td style="text-align: left;"><strong>SEC-003</strong></td>
<td style="text-align: left;"><strong>CWE</strong></td>
<td style="text-align: left;"><strong>CWE-89: SQL
Injection</strong></td>
<td style="text-align: left;"><strong>Potential SQL Injection in Dynamic
ORDER BY Clause</strong></td>
<td style="text-align: left;"><code>SpdiRegenBDHelper</code> uses string
concatenation to build a raw SQL <code>ORDER BY</code> clause, which
could be vulnerable if the input is not strictly sanitized.</td>
<td style="text-align: left;"><code>SpdiRegenBDHelper.java</code></td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Validate input for the
<code>ORDER BY</code> clause against a strict whitelist of allowed
column names and sort directions.</td>
<td style="text-align: left;"><a
href="https://cwe.mitre.org/data/definitions/89.html">CWE-89</a></td>
</tr>
<tr>
<td style="text-align: left;"><strong>SEC-004</strong></td>
<td style="text-align: left;"><strong>MITRE CWE</strong></td>
<td style="text-align: left;"><strong>CWE-327: Use of a Broken or Risky
Cryptographic Algorithm</strong></td>
<td style="text-align: left;"><strong>Insecure <code>curl</code> Command
in Build Pipeline</strong></td>
<td style="text-align: left;">The <code>pipeline-build-pdi.yml</code>
uses <code>curl --insecure</code> to communicate with the
<code>INFRAHUB</code> system, disabling TLS certificate validation and
enabling MITM attacks.</td>
<td style="text-align: left;"><code>pipeline-build-pdi.yml</code></td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Ensure the <code>INFRAHUB</code> server
has a valid TLS certificate and remove the <code>--insecure</code>
flag.</td>
<td style="text-align: left;"><a
href="https://cwe.mitre.org/data/definitions/327.html">CWE-327</a></td>
</tr>
<tr>
<td style="text-align: left;"><strong>SEC-005</strong></td>
<td style="text-align: left;"><strong>OWASP Top 10</strong></td>
<td style="text-align: left;"><strong>A01:2021 - Broken Access
Control</strong></td>
<td style="text-align: left;"><strong>Lack of Method-Level
Authorization</strong></td>
<td style="text-align: left;">Business logic in EJBs and helper classes
lacks method-level security annotations (<code>@RolesAllowed</code>),
relying solely on web-tier checks.</td>
<td style="text-align: left;">All EJB services and helper classes in
<code>spdiMdw-ejb</code>.</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Implement defense-in-depth by adding EJB
security annotations to all business methods to enforce authorization at
the business layer.</td>
<td style="text-align: left;"><a
href="https://owasp.org/Top10/A01_2021-Broken_Access_Control/">OWASP
A01</a></td>
</tr>
</tbody>
</table></div>
<h3 id="63-security-hardening-opportunities">6.3. Security hardening
opportunities</h3>
<p>This section identifies security hardening opportunities in the
Java/Jakarta EE/JBoss application.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
<col style="width: 9%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Hardening opportunity Id</th>
<th style="text-align: left;">Source</th>
<th style="text-align: left;">Area</th>
<th style="text-align: left;">Current state</th>
<th style="text-align: left;">Hardening opportunity</th>
<th style="text-align: left;">Affected components</th>
<th style="text-align: left;">Impact</th>
<th style="text-align: left;">Severity</th>
<th style="text-align: left;">Priority</th>
<th style="text-align: left;">Recommended fix</th>
<th style="text-align: left;">Links</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>SEC-HARD-001</strong></td>
<td style="text-align: left;"><strong>OWASP ASVS</strong></td>
<td style="text-align: left;"><strong>Dependency
Management</strong></td>
<td style="text-align: left;">The build process lacks automated security
scanning for dependencies. Known vulnerable libraries are used.</td>
<td style="text-align: left;"><strong>Integrate Dependency
Scanning:</strong> Add a security scanning step (e.g., OWASP
Dependency-Check, Snyk) to the Maven build process to automatically
detect and report vulnerable dependencies.</td>
<td style="text-align: left;">All <code>pom.xml</code> files,
<code>pipeline-build-pdi.yml</code></td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Integrate the
<code>dependency-check-maven</code> plugin into the <code>pom.xml</code>
and configure the build pipeline to fail if critical vulnerabilities are
found.</td>
<td style="text-align: left;"><a
href="https://owasp.org/www-project-dependency-check/">OWASP
Dependency-Check</a></td>
</tr>
<tr>
<td style="text-align: left;"><strong>SEC-HARD-002</strong></td>
<td style="text-align: left;"><strong>Best Practice</strong></td>
<td style="text-align: left;"><strong>Secrets Management</strong></td>
<td style="text-align: left;">Database and integration credentials are
hardcoded in JBoss <code>*-ds.xml</code> files or read from
configuration files via <code>ConfigTool</code>.</td>
<td style="text-align: left;"><strong>Externalize and Secure
Secrets:</strong> Migrate all secrets (passwords, API keys) from
configuration files to a secure vault solution like JBoss Vault, Elytron
Credential Store, or an external vault (e.g., HashiCorp Vault).</td>
<td style="text-align: left;"><code>*-ds.xml</code> files,
<code>SpdiDcmt.java</code></td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Use a vault to manage secrets and inject
them into the application at runtime.</td>
<td style="text-align: left;"><a
href="https://access.redhat.com/documentation/en-us/jboss_enterprise_application_platform/7.4/html/how_to_configure_server_security/secure_passwords_using_a_vault">JBoss
EAP Vault</a></td>
</tr>
<tr>
<td style="text-align: left;"><strong>SEC-HARD-003</strong></td>
<td style="text-align: left;"><strong>OWASP Top 10</strong></td>
<td style="text-align: left;"><strong>Security Headers</strong></td>
<td style="text-align: left;">The <code>web.xml</code> file does not
configure security-related HTTP headers like
<code>Content-Security-Policy</code>,
<code>Strict-Transport-Security</code>, or
<code>X-Content-Type-Options</code>.</td>
<td style="text-align: left;"><strong>Implement Security
Headers:</strong> Configure a web filter or use the web servers
configuration to add security headers to all HTTP responses to mitigate
attacks like XSS and clickjacking.</td>
<td style="text-align: left;"><code>web.xml</code></td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Add a filter to <code>web.xml</code> that
sets appropriate security headers on the
<code>HttpServletResponse</code>.</td>
<td style="text-align: left;"><a
href="https://owasp.org/www-project-secure-headers/">OWASP Secure
Headers Project</a></td>
</tr>
<tr>
<td style="text-align: left;"><strong>SEC-HARD-004</strong></td>
<td style="text-align: left;"><strong>OWASP ASVS</strong></td>
<td style="text-align: left;"><strong>Error Handling</strong></td>
<td style="text-align: left;">Raw exception messages
(<code>e.toString()</code>) are stored in the database, potentially
leaking sensitive system information.</td>
<td style="text-align: left;"><strong>Implement Sanitized Error
Handling:</strong> Log full, detailed exceptions to a secure, internal
log file only. Store a generic error message or a unique correlation ID
in the database and show it to users.</td>
<td style="text-align: left;"><code>SpdiRegenBDHelper.java</code>,
<code>erro.xhtml</code></td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Refactor exception handling to log details
securely and only expose safe information.</td>
<td style="text-align: left;"><a
href="https://cheatsheetseries.owasp.org/cheatsheets/Error_Handling_Cheat_Sheet.html">OWASP
Error Handling</a></td>
</tr>
</tbody>
</table></div>
<h3 id="64-dependency-and-sbom-vulnerabilities">6.4. Dependency and SBOM
vulnerabilities</h3>
<p>This section identifies and describes the security vulnerabilities in
the dependencies used in the Java/JBoss application.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Version</th>
<th style="text-align: left;">Known vulnerabilities (CVEs)</th>
<th style="text-align: left;">Source</th>
<th style="text-align: left;">Impact</th>
<th style="text-align: left;">Severity</th>
<th style="text-align: left;">Priority</th>
<th style="text-align: left;">Recommended fix</th>
<th style="text-align: left;">Links</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>com.lowagie:itext</code></td>
<td style="text-align: left;">2.0.8</td>
<td style="text-align: left;">CVE-2022-24197, CVE-2021-43113,
others</td>
<td style="text-align: left;"><code>spdiMdw-ejb/pom.xml</code></td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> Critical</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Upgrade to a modern, patched version like
OpenPDF or iText 7.</td>
<td style="text-align: left;"><a
href="https://nvd.nist.gov/vuln/detail/CVE-2022-24197">NVD -
CVE-2022-24197</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>org.richfaces.*</code></td>
<td style="text-align: left;">3.3.3.Final (inferred)</td>
<td style="text-align: left;">CVE-2018-12532, CVE-2015-0279,
CVE-2013-2165</td>
<td style="text-align: left;"><code>gieWeb/pom.xml</code></td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> Critical</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Migrate away from the end-of-life
RichFaces library to a modern, supported alternative like
PrimeFaces.</td>
<td style="text-align: left;"><a
href="https://nvd.nist.gov/vuln/detail/CVE-2018-12532">NVD -
CVE-2018-12532</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>axis:axis</code></td>
<td style="text-align: left;">Not Specified (likely 1.x)</td>
<td style="text-align: left;">CVE-2019-0227, CVE-2014-3596,
CVE-2012-5784</td>
<td style="text-align: left;"><code>gieWeb/pom.xml</code></td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> Critical</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Migrate to a modern SOAP client like
JAX-WS RI or Apache CXF. Axis 1.x is no longer maintained.</td>
<td style="text-align: left;"><a
href="https://nvd.nist.gov/vuln/detail/CVE-2019-0227">NVD -
CVE-2019-0227</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>org.beanshell:bsh</code></td>
<td style="text-align: left;">1.3.0</td>
<td style="text-align: left;">CVE-2016-2510</td>
<td style="text-align: left;"><code>spdiMdw-ejb/pom.xml</code></td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Upgrade to the latest version of BeanShell
(e.g., 2.0b6 or newer).</td>
<td style="text-align: left;"><a
href="https://nvd.nist.gov/vuln/detail/CVE-2016-2510">NVD -
CVE-2016-2510</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>org.jboss.seam:seam</code></td>
<td style="text-align: left;">2.2.x (inferred)</td>
<td style="text-align: left;">CVE-2010-1871</td>
<td style="text-align: left;"><code>gieWeb/pom.xml</code></td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Ensure all EL expressions are properly
sanitized. Migrate to a modern framework like Jakarta EE with CDI if
possible.</td>
<td style="text-align: left;"><a
href="https://nvd.nist.gov/vuln/detail/CVE-2010-1871">NVD -
CVE-2010-1871</a></td>
</tr>
</tbody>
</table></div>
<h3 id="65-misconfigurations-and-dangerous-defaults">6.5.
Misconfigurations and dangerous defaults</h3>
<p>This section identifies and describes misconfigurations and dangerous
defaults in the Java/JBoss application.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Setting / File</th>
<th style="text-align: left;">Issue detected</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Impact</th>
<th style="text-align: left;">Severity</th>
<th style="text-align: left;">Priority</th>
<th style="text-align: left;">Recommended fix</th>
<th style="text-align: left;">Links</th>
</tr>
</thead>
<tbody>
<tr>
<td
style="text-align: left;"><code>pipeline-deploy-aplicacional.yml</code></td>
<td style="text-align: left;"><strong>Use of weak SSH
algorithms</strong></td>
<td style="text-align: left;">The <code>scp</code> and <code>ssh</code>
commands are configured with <code>-oHostKeyAlgorithms=+ssh-rsa</code>
and <code>-oMACs=hmac-sha1-96</code>, forcing the use of weak, outdated
cryptographic algorithms.</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Remove the options forcing weak algorithms
and ensure the servers and clients support modern standards like
<code>ed25519</code> or <code>rsa-sha2-512</code>.</td>
<td style="text-align: left;"><a
href="https://infosec.mozilla.org/guidelines/openssh">Mozilla SSH Config
Guide</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>pipeline-build-pdi.yml</code></td>
<td style="text-align: left;"><strong>Disabled TLS Certificate
Validation</strong></td>
<td style="text-align: left;">The <code>curl</code> command uses the
<code>--insecure</code> flag, which disables TLS certificate validation,
making the connection vulnerable to MITM attacks.</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Provision a valid TLS certificate for the
<code>INFRAHUB</code> service and remove the <code>--insecure</code>
flag.</td>
<td style="text-align: left;"><a
href="https://cheatsheetseries.owasp.org/cheatsheets/Transport_Layer_Protection_Cheat_Sheet.html">OWASP
Transport Layer Protection</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>web.xml</code></td>
<td style="text-align: left;"><strong>No Session Timeout
Invalidation</strong></td>
<td style="text-align: left;">The <code>web.xml</code> defines a session
timeout of 3600 seconds (60 minutes) but does not configure session
cookie attributes like <code>HttpOnly</code> and
<code>Secure</code>.</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Configure the session cookie in
<code>web.xml</code> or the application server to be
<code>HttpOnly</code>, <code>Secure</code>, and have a
<code>SameSite</code> policy.</td>
<td style="text-align: left;"><a
href="https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html">OWASP
Session Management</a></td>
</tr>
<tr>
<td style="text-align: left;"><code>jboss-web.xml</code></td>
<td style="text-align: left;"><strong>Non-Standard
Classloading</strong></td>
<td style="text-align: left;">The file configures
<code>&lt;loader-repository-config&gt;java2ParentDelegation=false&lt;/loader-repository-config&gt;</code>,
which inverts the standard Java classloading delegation model.</td>
<td style="text-align: left;"><span class="icon icon-low"
title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low"
title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;"><span class="icon icon-low"
title="Low/Info">recommend</span> Low</td>
<td style="text-align: left;">Review if this non-standard classloading
is still necessary. If possible, remove it to follow standard behavior,
which is less error-prone.</td>
<td style="text-align: left;">N/A</td>
</tr>
</tbody>
</table></div>
<h3 id="66-data-exposure-and-pii-handling">6.6. Data exposure and PII
handling</h3>
<p>This section identifies and describes data exposure and Personally
Identifiable Information (PII) handling issues in the Java/JBoss
application.</p>
<div class="table-container"><table>
<colgroup>
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Data type</th>
<th style="text-align: left;">Location (Field / File)</th>
<th style="text-align: left;">Exposure risk</th>
<th style="text-align: left;">Impact</th>
<th style="text-align: left;">Severity</th>
<th style="text-align: left;">Priority</th>
<th style="text-align: left;">Recommended fix</th>
<th style="text-align: left;">Links</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Database Credentials</strong></td>
<td style="text-align: left;"><code>*-ds.xml</code> files</td>
<td style="text-align: left;"><strong>Hardcoded Secrets</strong></td>
<td style="text-align: left;">The datasource configuration files
(<code>spdi-ds.xml</code>, <code>ptsm-ds.xml</code>, etc.) contain
hardcoded usernames and passwords for the Oracle database.</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Externalize database credentials from the
deployment artifacts. Use a secrets management tool like JBoss Vault,
Elytron Credential Store, or an external vault (e.g., HashiCorp
Vault).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Integration
Credentials</strong></td>
<td style="text-align: left;"><code>SpdiDcmt.java</code></td>
<td style="text-align: left;"><strong>Potential Plaintext
Secrets</strong></td>
<td style="text-align: left;">The code retrieves a username and password
from <code>ConfigTool.getProperty()</code>. If these are stored in a
plaintext <code>.properties</code> file, they are exposed.</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;"><span class="icon icon-high"
title="High/Critical">dangerous</span> High</td>
<td style="text-align: left;">Store secrets in an encrypted vault and
retrieve them at runtime. Do not store plaintext credentials in source
code or configuration files.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Exception Details</strong></td>
<td style="text-align: left;"><code>SpdRegenDocumentosGie.erro</code>,
<code>pages.xml</code> error handling</td>
<td style="text-align: left;"><strong>Information Leakage</strong></td>
<td style="text-align: left;">Raw exception messages
(<code>e.toString()</code>) are stored in the database. Generic error
pages could leak stack traces in development/misconfigured
environments.</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;"><span class="icon icon-medium"
title="Medium/Warning">warning</span> Medium</td>
<td style="text-align: left;">Ensure error pages never display raw
exception details. Log detailed errors on the server and store/show only
a generic message with a unique reference ID.</td>
</tr>
</tbody>
</table></div>
</div>
<div class="product-section"><h2 id="7-integrations">7. Integrations</h2>
<p>This section documents all external system integrations found within
the Java/JBoss application source code.</p>
<div class="table-container"><table style="width:100%;">
<colgroup>
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">Integration Identity &amp; Purpose</th>
<th style="text-align: left;">Technical Implementation Details</th>
<th style="text-align: left;">Verifiable Source Code Evidence</th>
<th style="text-align: left;">Data Format</th>
<th style="text-align: left;">Authentication Mechanism</th>
<th style="text-align: left;">Endpoint / Resource Identifier</th>
<th style="text-align: left;">Core Library / Dependency</th>
<th style="text-align: left;">Architectural Notes</th>
<th style="text-align: left;">Assumptions</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>Oracle Database</strong></td>
<td style="text-align: left;">Relational database for all application
data.</td>
<td style="text-align: left;"><strong>Code:</strong>
<code>SpdiTablesDAO.java</code>, All Entities <br>
<strong>Config:</strong> <code>persistence.xml</code>,
<code>spdi-ds.xml</code></td>
<td style="text-align: left;">SQL</td>
<td style="text-align: left;">Username/Password</td>
<td style="text-align: left;"><code>java:/spdiMdwDatasource</code>,
etc.</td>
<td
style="text-align: left;"><code>org.hibernate:hibernate-core</code></td>
<td style="text-align: left;">Standard transactional data access using
multiple datasources for different schemas.</td>
<td style="text-align: left;">The database is the single source of truth
for all application metadata and state.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Documentum Archive</strong></td>
<td style="text-align: left;">External Content Management System for
document search and management.</td>
<td style="text-align: left;"><strong>Code:</strong>
<code>TrxClientProcurarDocumentos.java</code>,
<code>SpdiDcmt.java</code> <br> <strong>Config:</strong> WSDLs in
generated stubs</td>
<td style="text-align: left;">XML (SOAP)</td>
<td style="text-align: left;">Token-based or Username/Password passed in
SOAP message.</td>
<td style="text-align: left;">WSDL URLs in generated stubs (e.g.,
<code>http://waiaccesstu/...</code>,
<code>https://gesarqqas/...</code>)</td>
<td style="text-align: left;"><code>axis:axis</code>, JAX-WS stubs</td>
<td style="text-align: left;">Synchronous request-response clients to
search for and manage documents in the central archive.</td>
<td style="text-align: left;">The integration is done via proxy/wrapper
classes.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>HAPB/Alnova Core
Banking</strong></td>
<td style="text-align: left;">Core banking system for asynchronous
transactions.</td>
<td style="text-align: left;"><strong>Code:</strong>
<code>EnviarPedidoArquivacaoTrx.java</code>,
<code>HapbAsyncQueueService.java</code></td>
<td style="text-align: left;">JMS Messages, DB Queue</td>
<td style="text-align: left;">Handled by the Alnova transaction
framework.</td>
<td style="text-align: left;">Queue:
<code>remoteJms/queue/GfdQueue</code> <br> Table:
<code>HAPB_ASYNC_QUEUE</code></td>
<td style="text-align: left;"><code>javax.jms:jms</code></td>
<td style="text-align: left;">A dual fire-and-forget pattern using both
JMS and a database queue for reliable, asynchronous processing.</td>
<td style="text-align: left;">An MDB or other consumer is configured on
the HAPB side to process these requests.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>LDAP / Active
Directory</strong></td>
<td style="text-align: left;">Directory service for user/group
information.</td>
<td style="text-align: left;"><strong>Code:</strong>
<code>ExchangeEmailConsultTrx.java</code></td>
<td style="text-align: left;">LDAP attributes</td>
<td style="text-align: left;">Simple Bind (username/password).</td>
<td style="text-align: left;">JNDI name <code>LDAPCGD</code></td>
<td style="text-align: left;">Custom internal library
(<code>com.cgd.commons.util.LdapClient</code>)</td>
<td style="text-align: left;">Direct LDAP queries to search for user and
group information, likely for email resolution.</td>
<td style="text-align: left;">The LDAP server is an internal Active
Directory.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Nexus Repository</strong></td>
<td style="text-align: left;">Artifact repository for CI/CD.</td>
<td style="text-align: left;"><strong>Config:</strong>
<code>pipeline-build-pdi.yml</code>,
<code>pipeline-deploy-aplicacional.yml</code></td>
<td style="text-align: left;">Maven Format</td>
<td style="text-align: left;">Credentials stored in GitHub Secrets.</td>
<td
style="text-align: left;"><code>https://nexus.grupocgd.com</code></td>
<td style="text-align: left;"><code>curl</code>, Custom GH Action</td>
<td style="text-align: left;">Standard use of a binary repository in a
CI/CD workflow for dependencies and build artifacts.</td>
<td style="text-align: left;">Nexus is the central repository for all
binaries.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>InfraHub</strong></td>
<td style="text-align: left;">Internal infrastructure orchestration
service.</td>
<td style="text-align: left;"><strong>Config:</strong>
<code>pipeline-build-pdi.yml</code>,
<code>pipeline-sql-oracle.yml</code></td>
<td style="text-align: left;">HTTP POST</td>
<td style="text-align: left;">None (uses
<code>curl --insecure</code>)</td>
<td
style="text-align: left;"><code>${{ vars.INFRAHUB_URLWEBAPP }}</code></td>
<td style="text-align: left;"><code>curl</code></td>
<td style="text-align: left;">Used as a trigger/orchestration point in
the build pipeline to initiate other workflows.</td>
<td style="text-align: left;">InfraHub is a central automation or
control plane service.</td>
</tr>
</tbody>
</table></div>
</div>

</main>
      <p class="ai-disclaimer">This application analysis was performed using Artificial Intelligence (AI). While AI enhances the process, it may still produce inaccuracies, and all results should be carefully reviewed.</p>
      <footer class="footer">
         <div class="footer-container">
            <div class="footer-brand">
               <img src="https://www.cgd.pt/PublishingImages/WSImages/Novo-CGD/logo-ap_Blue.png" alt="CGD Logo" class="footer-logo">
               <span class="footer-wordmark">Caixa. Para todos e para cada um.</span>
            </div>
            <div class="footer-copyright">
                2025 Caixa Geral de Depsitos, SA. All rights reserved.
            </div>
            <div class="footer-socials">
               <a href="https://www.cgd.pt/" target="_blank" title="Website">
                  <svg viewBox="0 0 24 24">
                     <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1h-2v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                  </svg>
               </a>
               <a href="https://www.facebook.com/caixageraldedepositos" target="_blank" title="Facebook">
                  <svg viewBox="0 0 24 24">
                     <path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2V9.5C10 7.57 11.57 6 13.5 6H16v3h-1.5c-1.1 0-1.5.9-1.5 1.5V12h3l-.5 3h-2.5v6.8A10.02 10.02 0 0022 12z"/>
                  </svg>
               </a>
               <a href="https://www.youtube.com/user/mediacgd" target="_blank" title="YouTube">
                  <svg viewBox="0 0 24 24">
                     <path d="M21.58 7.19c-.23-.86-.9-1.52-1.76-1.75C18.25 5 12 5 12 5s-6.25 0-7.82.44c-.86.23-1.52.89-1.76 1.75C2 8.75 2 12 2 12s0 3.25.42 4.81c.23.86.9 1.52 1.76 1.75C5.75 19 12 19 12 19s6.25 0 7.82-.44c.86-.23 1.52-.89 1.76-1.75C22 15.25 22 12 22 12s0-3.25-.42-4.81zM10 15V9l5.2 3-5.2 3z"/>
                  </svg>
               </a>
               <a href="https://www.linkedin.com/company/caixageraldedepositos" target="_blank" title="LinkedIn">
                  <svg viewBox="0 0 24 24">
                     <path d="M19 3a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h14zm-7 5H8v8h4v-8zm-2-2h4v-2H8v2zm8 4h-4v4h4v-4zm0-2h-4v-2h4v2z" clip-rule="evenodd" fill-rule="evenodd"/>
                  </svg>
               </a>
               <a href="https://www.instagram.com/caixageraldedepositos" target="_blank" title="Instagram">
                  <svg viewBox="0 0 24 24">
                     <path d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 01-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 017.8 2zm-.2 2A3.6 3.6 0 004 7.6v8.8C4 18.39 5.61 20 7.6 20h8.8c1.99 0 3.6-1.61 3.6-3.6V7.6C20 5.61 18.39 4 16.4 4H7.6zm9.65 1.5a1.25 1.25 0 100 2.5 1.25 1.25 0 000-2.5zM12 7a5 5 0 100 10 5 5 0 000-10zm0 2a3 3 0 110 6 3 3 0 010-6z"/>
                  </svg>
               </a>
            </div>
         </div>
      </footer>
      <button id="back-to-top" title="Back to Top">
      <span class="icon">arrow_upward</span>
      </button>
      
      <!-- Floating Table of Contents -->
      <div id="floating-toc-toggle" class="floating-toc-toggle" title="Table of Contents">
         <span class="icon">toc</span>
      </div>
      
      <div id="floating-toc" class="floating-toc">
         <div class="floating-toc-header">
            <div class="floating-toc-title">
               <span class="icon">toc</span>
               Table of Contents
            </div>
            <button id="floating-toc-close" class="floating-toc-close" title="Close TOC">
               <span class="icon">close</span>
            </button>
         </div>
         <ul id="floating-toc-list" class="floating-toc-list">
            <!-- TOC items will be dynamically generated -->
         </ul>
      </div>

      <!-- Fullscreen Reading Mode -->
      <div id="fullscreen-reading-mode" class="fullscreen-reading-mode">
         <div class="fullscreen-font-controls">
            <button id="font-decrease" class="fullscreen-font-control" title="Decrease font size">
               <span class="icon">text_decrease</span>
            </button>
            <button id="font-increase" class="fullscreen-font-control" title="Increase font size">
               <span class="icon">text_increase</span>
            </button>
         </div>
         
         <div class="fullscreen-reading-controls">
            <button id="fullscreen-tts-btn" class="fullscreen-reading-control" title="Listen to content">
               <span class="icon">play_arrow</span>
            </button>
            <button id="fullscreen-dark-mode-btn" class="fullscreen-reading-control" title="Toggle dark mode">
               <span class="icon">light_mode</span>
            </button>
            <button id="fullscreen-exit-btn" class="fullscreen-reading-control fullscreen-reading-exit" title="Exit fullscreen reading">
               <span class="icon">fullscreen_exit</span>
            </button>
         </div>
         
         <div id="fullscreen-reading-content" class="fullscreen-reading-content">
            <!-- Content will be dynamically populated -->
         </div>
         
         <div id="fullscreen-reading-progress" class="fullscreen-reading-progress">
            Reading progress: 0%
         </div>
      </div>

      <script>
         document.addEventListener('DOMContentLoaded', function() {
             
             // --- INITIALIZATION ---
             function init() {
                 console.log('Starting initialization...');
                 replaceEmojisWithIcons();
                 removeHeadingNumbers();
                 setupTabs(); // This now also calculates and displays read times
                 console.log('About to initialize dark mode...');
                 initDarkMode();
                 console.log('Dark mode initialization complete');
                 initTTS();
                 initBackToTop();
                 initFloatingTOC();
                 initReadingProgress();
                 initFullscreenReading();
                 initBreadcrumbNavigation();
                 
                 // Initialize and render Mermaid diagrams
                 function checkMermaidAvailability() {
                     if (typeof mermaid === 'undefined') {
                         console.error('Mermaid library not loaded. Diagrams will not be rendered.');
                         return false;
                     }
                     console.log('Mermaid version:', mermaid.version || 'Unknown');
                     return true;
                 }
                 
                 if (checkMermaidAvailability()) {
                     try {
                         initializeMermaidRendering();
                         setTimeout(renderMermaidDiagrams, 500);
                     } catch (error) {
                         console.error('Error initializing Mermaid diagrams:', error);
                     }
                 }
             }
             
             // --- FEATURE: DARK MODE ---
             function initDarkMode() {
                 console.log('Initializing dark mode...');
                 const toggleBtn = document.getElementById('dark-mode-toggle');
                 console.log('Toggle button found:', toggleBtn);
                 
                 // Check if the toggle button exists
                 if (!toggleBtn) {
                     console.warn('Dark mode toggle button not found');
                     return;
                 }
                 
                 // Check if the icon element exists inside the button
                 const iconElement = toggleBtn.querySelector('.icon');
                 console.log('Icon element found:', iconElement);
                 if (!iconElement) {
                     console.warn('Dark mode toggle icon not found');
                     return;
                 }
                 
                 const sunIcon = 'light_mode';
                 const moonIcon = 'dark_mode';
         
                 // Check for saved preference and update UI accordingly
                 if (localStorage.getItem('theme') === 'dark') {
                     console.log('Setting dark mode from localStorage');
                     document.documentElement.classList.add('dark-mode');
                     iconElement.textContent = sunIcon;
                     toggleBtn.title = 'Switch to light mode';
                 } else {
                     console.log('Setting light mode');
                     iconElement.textContent = moonIcon;
                     toggleBtn.title = 'Switch to dark mode';
                 }
         
                 console.log('Adding click event listener to dark mode toggle');
                 toggleBtn.addEventListener('click', () => {
                     console.log('Dark mode toggle clicked!');
                     
                     const isDarkMode = document.documentElement.classList.toggle('dark-mode');
                     console.log('Dark mode toggled:', isDarkMode);
                     console.log('Current document classes:', document.documentElement.className);
                     
                     // Update icon and tooltip based on current mode
                     if (isDarkMode) {
                         console.log('Setting sun icon for dark mode');
                         iconElement.textContent = sunIcon;
                         toggleBtn.title = 'Switch to light mode';
                     } else {
                         console.log('Setting moon icon for light mode');
                         iconElement.textContent = moonIcon;
                         toggleBtn.title = 'Switch to dark mode';
                     }
                     
                     localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                     console.log('Theme saved to localStorage:', isDarkMode ? 'dark' : 'light');
                     
                     // Update Mermaid theme if the function exists
                     if (typeof updateMermaidTheme === 'function') {
                         updateMermaidTheme();
                     }
                 });
                 
                 console.log('Dark mode initialization completed successfully');
             }
         
             // --- FEATURE: TEXT-TO-SPEECH (TTS) ---
             function initTTS() {
                 const ttsControls = document.getElementById('tts-controls');
                 const playPauseBtn = document.getElementById('tts-play-pause-btn');
                 const stopBtn = document.getElementById('tts-stop-btn');
                 
                 // Check if TTS elements exist
                 if (!ttsControls || !playPauseBtn || !stopBtn) {
                     console.warn('TTS controls not found');
                     return;
                 }
                 
                 const synth = window.speechSynthesis;
         
                 // Always show TTS controls
                 ttsControls.style.display = 'flex';
                 
                 if (!synth) {
                     console.warn("Browser does not support Speech Synthesis.");
                     // Show controls but disable them
                     playPauseBtn.disabled = true;
                     stopBtn.disabled = true;
                     playPauseBtn.title = "Speech synthesis not supported in this browser";
                     stopBtn.title = "Speech synthesis not supported in this browser";
                     return;
                 }
         
                 let utterance = null;
                 
                 console.log("TTS initialized successfully");
         
                 function play() {
                     console.log("TTS play function called");
                     const activePane = document.querySelector('.tab-pane.active');
                     if (!activePane) {
                         console.warn("No active tab pane found");
                         return;
                     }
                     
                     if (synth.speaking) {
                         console.log("Speech synthesis already speaking");
                         return;
                     }
         
                     // Clone to avoid modifying the live DOM, then clean text
                     const contentClone = activePane.cloneNode(true);
                     contentClone.querySelectorAll('h2, h3, h4').forEach(h => h.textContent = h.textContent + '. '); // Add pauses after headings
                     const textToSpeak = contentClone.innerText;
                     
                     console.log("Text to speak length:", textToSpeak.length);
         
                     utterance = new SpeechSynthesisUtterance(textToSpeak);
                     utterance.lang = document.documentElement.lang || 'en-US';
                     utterance.rate = 0.9; // Slightly slower for better comprehension
                     utterance.pitch = 1.0;
                     utterance.volume = 0.8;
         
                     utterance.onstart = () => {
                         console.log("Speech started");
                         playPauseBtn.querySelector('.icon').textContent = 'pause';
                         playPauseBtn.title = 'Pause listening';
                     };
                     utterance.onpause = () => {
                         console.log("Speech paused");
                         playPauseBtn.querySelector('.icon').textContent = 'play_arrow';
                         playPauseBtn.title = 'Resume listening';
                     };
                     utterance.onresume = () => {
                         console.log("Speech resumed");
                         playPauseBtn.querySelector('.icon').textContent = 'pause';
                         playPauseBtn.title = 'Pause listening';
                     };
                     utterance.onend = () => {
                         console.log("Speech ended");
                         playPauseBtn.querySelector('.icon').textContent = 'play_arrow';
                         playPauseBtn.title = 'Listen to this section';
                         utterance = null;
                     };
                     utterance.onerror = (event) => {
                         console.error("Speech synthesis error:", event);
                         playPauseBtn.querySelector('.icon').textContent = 'play_arrow';
                         playPauseBtn.title = 'Listen to this section';
                         utterance = null;
                     };
                     
                     synth.speak(utterance);
                 }
         
                 function togglePlayPause() {
                     console.log("TTS toggle play/pause clicked");
                     console.log("Current state - speaking:", synth.speaking, "paused:", synth.paused);
                     
                     if (synth.speaking && !synth.paused) {
                         console.log("Pausing speech");
                         synth.pause();
                     } else if (synth.paused) {
                         console.log("Resuming speech");
                         synth.resume();
                     } else {
                         console.log("Starting new speech");
                         play();
                     }
                 }
         
                 function stop() {
                     console.log("TTS stop clicked");
                     synth.cancel(); // Also triggers 'onend'
                 }
         
                 playPauseBtn.addEventListener('click', togglePlayPause);
                 stopBtn.addEventListener('click', stop);
                 
                 // Stop speech when user changes tabs
                 document.querySelector('.tab-navigation')?.addEventListener('click', stop);
             }
             
             // --- FEATURE: BACK TO TOP BUTTON ---
             function initBackToTop() {
                 const backToTopButton = document.getElementById('back-to-top');
                 
                 if (!backToTopButton) {
                     console.warn('Back to top button not found');
                     return;
                 }
                 
                 window.addEventListener('scroll', () => {
                     if (window.scrollY > 300) {
                         backToTopButton.classList.add('show');
                     } else {
                         backToTopButton.classList.remove('show');
                     }
                 });
                 backToTopButton.addEventListener('click', () => {
                     window.scrollTo({ top: 0, behavior: 'smooth' });
                 });
             }

             // --- FEATURE: FLOATING TABLE OF CONTENTS ---
             function initFloatingTOC() {
                 const tocToggle = document.getElementById('floating-toc-toggle');
                 const tocContainer = document.getElementById('floating-toc');
                 const tocClose = document.getElementById('floating-toc-close');
                 const tocList = document.getElementById('floating-toc-list');
                 
                 let isInitialized = false;
                 let tocItems = [];
                 let sectionElements = [];
                 
                 function buildTOC() {
                     if (isInitialized) return;
                     
                     // Get all h2 elements from tab panes
                     const tabPanes = document.querySelectorAll('.tab-pane');
                     tocList.innerHTML = '';
                     tocItems = [];
                     sectionElements = [];
                     
                     tabPanes.forEach((pane, index) => {
                         const h2Element = pane.querySelector('h2');
                         if (!h2Element) return;
                         
                         const tocItem = document.createElement('li');
                         tocItem.className = 'floating-toc-item';
                         
                         const tocLink = document.createElement('a');
                         tocLink.className = 'floating-toc-link';
                         tocLink.href = '#';
                         tocLink.textContent = h2Element.textContent.trim();
                         tocLink.dataset.target = h2Element.id || `section-${index}`;
                         
                         const progressIndicator = document.createElement('div');
                         progressIndicator.className = 'floating-toc-progress';
                         const progressFill = document.createElement('div');
                         progressFill.className = 'floating-toc-progress-fill';
                         progressIndicator.appendChild(progressFill);
                         tocLink.appendChild(progressIndicator);
                         
                         tocItem.appendChild(tocLink);
                         tocList.appendChild(tocItem);
                         
                         tocItems.push({
                             link: tocLink,
                             pane: pane,
                             h2: h2Element
                         });
                         
                         sectionElements.push({
                             element: pane,
                             link: tocLink,
                             id: h2Element.id || `section-${index}`
                         });
                         
                         // Add click handler for smooth scrolling to tab
                         tocLink.addEventListener('click', (e) => {
                             e.preventDefault();
                             
                             // Find and activate the corresponding tab
                             const tabButton = document.querySelector(`[data-tab="${pane.id}"]`);
                             if (tabButton) {
                                 tabButton.click();
                                 
                                 // Small delay to ensure tab is active, then scroll to h2
                                 setTimeout(() => {
                                     h2Element.scrollIntoView({
                                         behavior: 'smooth',
                                         block: 'start'
                                     });
                                 }, 100);
                             }
                         });
                     });
                     
                     isInitialized = true;
                 }
                 
                 function updateProgress() {
                     if (!isInitialized || tocItems.length === 0) return;
                     
                     const activeTabPane = document.querySelector('.tab-pane.active');
                     if (!activeTabPane) return;
                     
                     // Find the corresponding TOC item
                     const activeTocItem = tocItems.find(item => item.pane === activeTabPane);
                     
                     // Clear all active states
                     tocItems.forEach(item => {
                         item.link.classList.remove('active', 'reading');
                     });
                     
                     if (activeTocItem) {
                         activeTocItem.link.classList.add('active');
                         
                         // Calculate reading progress for the active section
                         const paneRect = activeTabPane.getBoundingClientRect();
                         const viewportHeight = window.innerHeight;
                         
                         // Consider a section as "reading" if it's visible in viewport
                         if (paneRect.top < viewportHeight && paneRect.bottom > 0) {
                             activeTocItem.link.classList.add('reading');
                         }
                     }
                 }
                 
                 function showTOC() {
                     buildTOC();
                     tocContainer.classList.add('show');
                     tocToggle.classList.remove('show');
                     updateProgress();
                 }
                 
                 function hideTOC() {
                     tocContainer.classList.remove('show');
                     tocToggle.classList.add('show');
                 }
                 
                 // Event listeners
                 tocToggle.addEventListener('click', showTOC);
                 tocClose.addEventListener('click', hideTOC);
                 
                 // Close TOC when clicking outside
                 document.addEventListener('click', (e) => {
                     if (!tocContainer.contains(e.target) && !tocToggle.contains(e.target)) {
                         if (tocContainer.classList.contains('show')) {
                             hideTOC();
                         }
                     }
                 });
                 
                 // Show/hide toggle button on scroll
                 window.addEventListener('scroll', () => {
                     if (window.scrollY > 500) {
                         if (!tocContainer.classList.contains('show')) {
                             tocToggle.classList.add('show');
                         }
                     } else {
                         tocToggle.classList.remove('show');
                         tocContainer.classList.remove('show');
                     }
                     
                     updateProgress();
                 });
                 
                 // Update progress when tabs change
                 const tabNavigation = document.querySelector('.tab-navigation');
                 if (tabNavigation) {
                     tabNavigation.addEventListener('click', () => {
                         setTimeout(updateProgress, 100);
                     });
                 }
                 
                 // Handle ESC key to close TOC
                 document.addEventListener('keydown', (e) => {
                     if (e.key === 'Escape' && tocContainer.classList.contains('show')) {
                         hideTOC();
                     }                 });
             }

             // --- FEATURE: READING PROGRESS INDICATOR ---
             function initReadingProgress() {
                 const progressBar = document.getElementById('reading-progress');
                 const progressFill = document.getElementById('reading-progress-fill');
                 const progressText = document.getElementById('reading-progress-text');
                 
                 let isVisible = false;
                 
                 function updateProgress() {
                     // Get the active tab content to calculate progress within that tab
                     const activeTabPane = document.querySelector('.tab-pane.active');
                     if (!activeTabPane) return;
                     
                     const rect = activeTabPane.getBoundingClientRect();
                     const tabTop = activeTabPane.offsetTop;
                     const tabHeight = activeTabPane.offsetHeight;
                     const headerHeight = document.querySelector('.header').offsetHeight + 
                                         document.querySelector('.tab-navigation-container').offsetHeight;
                     
                     // Calculate scroll position relative to the active tab
                     const scrollTop = window.pageYOffset;
                     const tabStart = tabTop - headerHeight;
                     const tabEnd = tabTop + tabHeight - window.innerHeight;
                     
                     // Calculate progress percentage for the current tab
                     let progress = 0;
                     if (scrollTop <= tabStart) {
                         progress = 0;
                     } else if (scrollTop >= tabEnd) {
                         progress = 100;
                     } else {
                         const scrollableHeight = tabEnd - tabStart;
                         const scrolledHeight = scrollTop - tabStart;
                         progress = Math.min(100, Math.max(0, (scrolledHeight / scrollableHeight) * 100));
                     }
                     
                     // Show progress bar after scrolling starts
                     const shouldShow = scrollTop > 100;
                     
                     if (shouldShow && !isVisible) {
                         progressBar.classList.add('show');
                         progressText.classList.add('show');
                         isVisible = true;
                     } else if (!shouldShow && isVisible) {
                         progressBar.classList.remove('show');
                         progressText.classList.remove('show');
                         isVisible = false;
                     }
                     
                     // Update progress bar and text
                     if (isVisible) {
                         progressFill.style.width = `${progress}%`;
                         progressText.textContent = `${Math.round(progress)}% read`;
                         
                         // Add current section info
                         const activeH2 = activeTabPane.querySelector('h2');
                         if (activeH2) {
                             const sectionTitle = activeH2.textContent.trim();
                             const shortTitle = sectionTitle.length > 25 ? 
                                               sectionTitle.substring(0, 25) + '...' : 
                                               sectionTitle;
                             progressText.textContent = `${Math.round(progress)}%  ${shortTitle}`;
                         }
                     }
                 }
                 
                 // Throttled scroll handler for better performance
                 let ticking = false;
                 function handleScroll() {
                     if (!ticking) {
                         requestAnimationFrame(() => {
                             updateProgress();
                             ticking = false;
                         });
                         ticking = true;
                     }
                 }
                 
                 // Event listeners
                 window.addEventListener('scroll', handleScroll);
                 window.addEventListener('resize', updateProgress);
                 
                 // Update progress when tabs change
                 const tabNavigation = document.querySelector('.tab-navigation');
                 if (tabNavigation) {
                     tabNavigation.addEventListener('click', () => {
                         setTimeout(updateProgress, 150);
                     });
                 }
                 
                 // Initial update
                 updateProgress();
             }

             // --- FEATURE: FULLSCREEN READING MODE ---
             function initFullscreenReading() {
                 const fullscreenBtn = document.getElementById('fullscreen-reading-btn');
                 const fullscreenMode = document.getElementById('fullscreen-reading-mode');
                 const fullscreenContent = document.getElementById('fullscreen-reading-content');
                 const fullscreenProgress = document.getElementById('fullscreen-reading-progress');
                 const exitBtn = document.getElementById('fullscreen-exit-btn');
                 const fontIncreaseBtn = document.getElementById('font-increase');
                 const fontDecreaseBtn = document.getElementById('font-decrease');
                 const fullscreenTtsBtn = document.getElementById('fullscreen-tts-btn');
                 const fullscreenDarkModeBtn = document.getElementById('fullscreen-dark-mode-btn');
                 
                 let currentFontSize = 1.1; // Default font size in rem
                 let isFullscreenActive = false;
                 
                 function enterFullscreenReading() {
                     const activeTabPane = document.querySelector('.tab-pane.active');
                     if (!activeTabPane) return;
                     
                     // Clone the active content
                     const contentClone = activeTabPane.cloneNode(true);
                     
                     // Clean up the cloned content for better reading
                     contentClone.querySelectorAll('.section-read-time').forEach(el => el.remove());
                     contentClone.querySelectorAll('script').forEach(el => el.remove());
                     
                     // Set the content
                     fullscreenContent.innerHTML = contentClone.innerHTML;
                     
                     // Activate fullscreen mode
                     document.body.classList.add('fullscreen-reading');
                     fullscreenMode.classList.add('active');
                     isFullscreenActive = true;
                     
                     // Update dark mode button state
                     const isDarkMode = document.documentElement.classList.contains('dark-mode');
                     fullscreenDarkModeBtn.querySelector('.icon').textContent = isDarkMode ? 'light_mode' : 'dark_mode';
                     fullscreenDarkModeBtn.title = isDarkMode ? 'Switch to light mode' : 'Switch to dark mode';
                     
                     // Initialize progress tracking
                     updateFullscreenProgress();
                     
                     // Prevent body scroll
                     document.body.style.overflow = 'hidden';
                 }
                 
                 function exitFullscreenReading() {
                     document.body.classList.remove('fullscreen-reading');
                     fullscreenMode.classList.remove('active');
                     isFullscreenActive = false;
                     
                     // Restore body scroll
                     document.body.style.overflow = '';
                     
                     // Stop any TTS playback
                     if (window.speechSynthesis) {
                         window.speechSynthesis.cancel();
                     }
                 }
                 
                 function adjustFontSize(increase) {
                     if (increase) {
                         currentFontSize = Math.min(2.0, currentFontSize + 0.1);
                     } else {
                         currentFontSize = Math.max(0.8, currentFontSize - 0.1);
                     }
                     fullscreenContent.style.fontSize = `${currentFontSize}rem`;
                 }
                 
                 function updateFullscreenProgress() {
                     if (!isFullscreenActive) return;
                     
                     const scrollTop = fullscreenMode.scrollTop;
                     const scrollHeight = fullscreenMode.scrollHeight - fullscreenMode.clientHeight;
                     const progress = scrollHeight > 0 ? Math.round((scrollTop / scrollHeight) * 100) : 0;
                     
                     fullscreenProgress.textContent = `Reading progress: ${progress}%`;
                 }
                 
                 function toggleFullscreenTTS() {
                     const synth = window.speechSynthesis;
                     if (!synth) return;
                     
                     if (synth.speaking && !synth.paused) {
                         synth.pause();
                         fullscreenTtsBtn.querySelector('.icon').textContent = 'play_arrow';
                         fullscreenTtsBtn.title = 'Resume listening';
                     } else if (synth.paused) {
                         synth.resume();
                         fullscreenTtsBtn.querySelector('.icon').textContent = 'pause';
                         fullscreenTtsBtn.title = 'Pause listening';
                     } else {
                         // Start new speech
                         const textToSpeak = fullscreenContent.innerText;
                         const utterance = new SpeechSynthesisUtterance(textToSpeak);
                         utterance.lang = document.documentElement.lang || 'en-US';
                         utterance.rate = 0.9;
                         utterance.pitch = 1.0;
                         utterance.volume = 0.8;
                         
                         utterance.onstart = () => {
                             fullscreenTtsBtn.querySelector('.icon').textContent = 'pause';
                             fullscreenTtsBtn.title = 'Pause listening';
                         };
                         
                         utterance.onend = () => {
                             fullscreenTtsBtn.querySelector('.icon').textContent = 'play_arrow';
                             fullscreenTtsBtn.title = 'Listen to content';
                         };
                         
                         utterance.onerror = () => {
                             fullscreenTtsBtn.querySelector('.icon').textContent = 'play_arrow';
                             fullscreenTtsBtn.title = 'Listen to content';
                         };
                         
                         synth.speak(utterance);
                     }
                 }
                 
                 function toggleFullscreenDarkMode() {
                     const isDarkMode = document.documentElement.classList.toggle('dark-mode');
                     fullscreenDarkModeBtn.querySelector('.icon').textContent = isDarkMode ? 'light_mode' : 'dark_mode';
                     fullscreenDarkModeBtn.title = isDarkMode ? 'Switch to light mode' : 'Switch to dark mode';
                     localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                 }
                 
                 // Event listeners
                 fullscreenBtn.addEventListener('click', enterFullscreenReading);
                 exitBtn.addEventListener('click', exitFullscreenReading);
                 fontIncreaseBtn.addEventListener('click', () => adjustFontSize(true));
                 fontDecreaseBtn.addEventListener('click', () => adjustFontSize(false));
                 fullscreenTtsBtn.addEventListener('click', toggleFullscreenTTS);
                 fullscreenDarkModeBtn.addEventListener('click', toggleFullscreenDarkMode);
                 
                 // Scroll progress tracking
                 fullscreenMode.addEventListener('scroll', () => {
                     if (isFullscreenActive) {
                         updateFullscreenProgress();
                     }
                 });
                 
                 // Keyboard shortcuts
                 document.addEventListener('keydown', (e) => {
                     if (!isFullscreenActive) return;
                     
                     switch(e.key) {
                         case 'Escape':
                             exitFullscreenReading();
                             break;
                         case 'F':
                         case 'f':
                             if (e.ctrlKey) {
                                 e.preventDefault();
                                 // Could implement search functionality here
                             }
                             break;
                         case '+':
                         case '=':
                             if (e.ctrlKey) {
                                 e.preventDefault();
                                 adjustFontSize(true);
                             }
                             break;
                         case '-':
                             if (e.ctrlKey) {
                                 e.preventDefault();
                                 adjustFontSize(false);
                             }
                             break;
                         case ' ':
                             if (e.ctrlKey) {
                                 e.preventDefault();
                                 toggleFullscreenTTS();
                             }
                             break;
                     }
                 });
                 
                 // Prevent context menu in fullscreen mode
                 fullscreenMode.addEventListener('contextmenu', (e) => {
                     if (isFullscreenActive) {
                         e.preventDefault();
                     }
                 });
             }

             // --- FEATURE: BREADCRUMB NAVIGATION ---
             function initBreadcrumbNavigation() {
                 const breadcrumbContainer = document.getElementById('breadcrumb-container');
                 const breadcrumbHome = document.getElementById('breadcrumb-home');
                 const breadcrumbCurrent = document.getElementById('breadcrumb-current');
                 const breadcrumbProgressFill = document.getElementById('breadcrumb-progress-fill');
                 const breadcrumbProgressText = document.getElementById('breadcrumb-progress-text');
                 const breadcrumbSectionCount = document.getElementById('breadcrumb-section-count');
                 
                 let sections = [];
                 let currentSectionIndex = 0;
                 let isVisible = false;
                 
                 function initializeSections() {
                     const tabPanes = document.querySelectorAll('.tab-pane');
                     sections = Array.from(tabPanes).map((pane, index) => {
                         const h2Element = pane.querySelector('h2');
                         return {
                             id: pane.id,
                             title: h2Element ? h2Element.textContent.trim() : `Section ${index + 1}`,
                             element: pane,
                             index: index
                         };
                     });
                 }
                 
                 function updateBreadcrumb() {
                     const activeTabPane = document.querySelector('.tab-pane.active');
                     if (!activeTabPane || sections.length === 0) return;
                     
                     // Find current section
                     currentSectionIndex = sections.findIndex(section => section.element === activeTabPane);
                     const currentSection = sections[currentSectionIndex];
                     
                     if (!currentSection) return;
                     
                     // Update breadcrumb current section
                     const maxTitleLength = window.innerWidth < 768 ? 25 : 40;
                     const displayTitle = currentSection.title.length > maxTitleLength ? 
                                         currentSection.title.substring(0, maxTitleLength) + '...' : 
                                         currentSection.title;
                     
                     breadcrumbCurrent.innerHTML = `
                         <span class="breadcrumb-link active" title="${currentSection.title}">
                             ${displayTitle}
                         </span>
                     `;
                     
                     // Update section count
                     breadcrumbSectionCount.textContent = `Section ${currentSectionIndex + 1} of ${sections.length}`;
                     
                     // Update progress
                     const progress = Math.round(((currentSectionIndex + 1) / sections.length) * 100);
                     breadcrumbProgressFill.style.width = `${progress}%`;
                     breadcrumbProgressText.textContent = `${progress}%`;
                     
                     // Show/hide breadcrumb based on scroll position
                     const shouldShow = window.scrollY > 200;
                     if (shouldShow && !isVisible) {
                         breadcrumbContainer.classList.add('show');
                         isVisible = true;
                     } else if (!shouldShow && isVisible) {
                         breadcrumbContainer.classList.remove('show');
                         isVisible = false;
                     }
                 }
                 
                 function createSectionBreadcrumb() {
                     const activeTabPane = document.querySelector('.tab-pane.active');
                     if (!activeTabPane) return;
                     
                     // Get current section hierarchy
                     const headings = activeTabPane.querySelectorAll('h2, h3, h4');
                     const currentScroll = window.scrollY + window.innerHeight / 2;
                     let activeHeading = null;
                     
                     // Find the currently visible heading
                     for (let i = headings.length - 1; i >= 0; i--) {
                         const heading = headings[i];
                         const rect = heading.getBoundingClientRect();
                         const absoluteTop = window.scrollY + rect.top;
                         
                         if (absoluteTop <= currentScroll) {
                             activeHeading = heading;
                             break;
                         }
                     }
                     
                     // Build breadcrumb path
                     let breadcrumbPath = '';
                     if (activeHeading && activeHeading.tagName !== 'H2') {
                         const h2 = activeTabPane.querySelector('h2');
                         const headingText = activeHeading.textContent.trim();
                         const maxLength = window.innerWidth < 768 ? 20 : 30;
                         const shortText = headingText.length > maxLength ? 
                                          headingText.substring(0, maxLength) + '...' : 
                                          headingText;
                         
                         breadcrumbPath = `
                             <span class="breadcrumb-separator"></span>
                             <div class="breadcrumb-item">
                                 <span class="breadcrumb-link" title="${headingText}">
                                     ${shortText}
                                 </span>
                             </div>
                         `;
                     }
                     
                     // Update the breadcrumb current section with subsection info
                     const currentSection = sections[currentSectionIndex];
                     if (currentSection) {
                         const maxTitleLength = window.innerWidth < 768 ? 20 : 30;
                         const displayTitle = currentSection.title.length > maxTitleLength ? 
                                             currentSection.title.substring(0, maxTitleLength) + '...' : 
                                             currentSection.title;
                         
                         breadcrumbCurrent.innerHTML = `
                             <span class="breadcrumb-link active" title="${currentSection.title}">
                                 ${displayTitle}
                             </span>
                             ${breadcrumbPath}
                         `;
                     }
                 }
                 
                 function navigateToSection(sectionIndex) {
                     if (sectionIndex < 0 || sectionIndex >= sections.length) return;
                     
                     const section = sections[sectionIndex];
                     const tabButton = document.querySelector(`[data-tab="${section.id}"]`);
                     
                     if (tabButton) {
                         tabButton.click();
                         setTimeout(() => {
                             section.element.scrollIntoView({
                                 behavior: 'smooth',
                                 block: 'start'
                             });
                         }, 150);
                     }
                 }
                 
                 // Event listeners
                 breadcrumbHome.addEventListener('click', (e) => {
                     e.preventDefault();
                     navigateToSection(0);
                 });
                 
                 // Throttled scroll handler
                 let scrollTicking = false;
                 function handleScroll() {
                     if (!scrollTicking) {
                         requestAnimationFrame(() => {
                             updateBreadcrumb();
                             createSectionBreadcrumb();
                             scrollTicking = false;
                         });
                         scrollTicking = true;
                     }
                 }
                 
                 // Event listeners
                 window.addEventListener('scroll', handleScroll);
                 window.addEventListener('resize', updateBreadcrumb);
                 
                 // Update breadcrumb when tabs change
                 const tabNavigation = document.querySelector('.tab-navigation');
                 if (tabNavigation) {
                     tabNavigation.addEventListener('click', () => {
                         setTimeout(() => {
                             updateBreadcrumb();
                             createSectionBreadcrumb();
                         }, 100);
                     });
                 }
                 
                 // Keyboard navigation
                 document.addEventListener('keydown', (e) => {
                     if (e.altKey) {
                         switch(e.key) {
                             case 'ArrowLeft':
                                 e.preventDefault();
                                 if (currentSectionIndex > 0) {
                                     navigateToSection(currentSectionIndex - 1);
                                 }
                                 break;
                             case 'ArrowRight':
                                 e.preventDefault();
                                 if (currentSectionIndex < sections.length - 1) {
                                     navigateToSection(currentSectionIndex + 1);
                                 }
                                 break;
                             case 'Home':
                                 e.preventDefault();
                                 navigateToSection(0);
                                 break;
                             case 'End':
                                 e.preventDefault();
                                 navigateToSection(sections.length - 1);
                                 break;
                         }
                     }
                 });
                 
                 // Initialize after tabs are set up
                 setTimeout(() => {
                     initializeSections();
                     updateBreadcrumb();
                     createSectionBreadcrumb();
                 }, 200);
             }

             // --- FEATURE: READ TIME CALCULATION ---
             function calculateAndDisplayReadTime() {
                 const wordsPerMinute = 225;
                 
                 function calculate(element) {
                     if (!element) return 0;
                     const text = element.innerText || '';
                     const wordCount = text.trim().split(/\s+/).length;
                     const minutes = Math.ceil(wordCount / wordsPerMinute);
                     return minutes;
                 }
                 
                 // Calculate reading time for each section and sum them up
                 let totalMinutes = 0;
         
                 // Calculate for each section and add after the description paragraph
                 document.querySelectorAll('.tab-pane').forEach(pane => {
                     const sectionMinutes = calculate(pane);
                     
                     // Add this section's reading time to the total
                     totalMinutes += sectionMinutes;
                     
                     const h2Element = pane.querySelector('h2');
                     
                     if (h2Element && sectionMinutes > 0) {
                         // Remove any existing read time elements
                         const existingReadTime = pane.querySelector('.section-read-time');
                         if (existingReadTime) {
                             existingReadTime.remove();
                         }
                         
                         // Find the first paragraph after the h2 (section description)
                         let insertionPoint = h2Element.nextSibling;
                         let firstParagraph = null;
                         
                         // Walk through siblings to find the first paragraph
                         while (insertionPoint) {
                             if (insertionPoint.nodeType === 1 && insertionPoint.tagName === 'P') {
                                 firstParagraph = insertionPoint;
                                 break;
                             }
                             insertionPoint = insertionPoint.nextSibling;
                         }
                         
                         // Create new read time element
                         const readTimeDiv = document.createElement('div');
                         readTimeDiv.className = 'section-read-time';
                         readTimeDiv.style.cssText = 'margin: 0.5rem 0 1rem 0; color: var(--text-secondary); font-size: 0.875rem; display: flex; align-items: center; gap: 0.25rem;';
                         
                         const clockIcon = document.createElement('span');
                         clockIcon.className = 'icon';
                         clockIcon.textContent = 'schedule';
                         clockIcon.style.fontSize = '18px';
                         
                         const readTimeText = document.createElement('span');
                         readTimeText.textContent = `${sectionMinutes} min read`;
                         
                         readTimeDiv.appendChild(clockIcon);
                         readTimeDiv.appendChild(readTimeText);
                         
                         // Insert after the first paragraph if found, otherwise after h2
                         if (firstParagraph) {
                             firstParagraph.parentNode.insertBefore(readTimeDiv, firstParagraph.nextSibling);
                         } else {
                             h2Element.parentNode.insertBefore(readTimeDiv, h2Element.nextSibling);
                         }
                     }
                 });
                 
                 // Update the total reading time in the product header
                 const totalReadTimeEl = document.getElementById('total-read-time').querySelector('span:last-child');
                 totalReadTimeEl.textContent = `${totalMinutes} min read`;
             }
         
             // --- UTILITY: EMOJI REPLACEMENT ---
             function replaceEmojisWithIcons() {
                 const emojiToIconMap = {
                     '': '<span class="icon icon-high" title="High/Critical">dangerous</span>',
                     '': '<span class="icon icon-medium" title="Medium/Warning">warning</span>',
                     '': '<span class="icon icon-low" title="Low/Info">recommend</span>',
                     '': '<span class="icon icon-check" title="Yes/Used/Supported">check_circle</span>',
                     '': '<span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span>',
                     '': '<span class="icon icon-cross" title="No/Not Used/Unsupported">cancel</span>',
                     '': '<span class="icon icon-question" title="Uncertain/Likely">help</span>'
                 };
                 const emojiRegex = new RegExp(Object.keys(emojiToIconMap).join('|'), 'g');
                 function walkDOM(node) {
                     if (node.nodeType === 3) {
                         if (emojiRegex.test(node.nodeValue)) {
                             const tempWrapper = document.createElement('span');
                             tempWrapper.innerHTML = node.nodeValue.replace(emojiRegex, match => emojiToIconMap[match]);
                             node.parentNode.replaceChild(tempWrapper, node);
                         }
                     } else if (node.nodeType === 1 && node.nodeName !== 'SCRIPT' && node.nodeName !== 'STYLE') {
                         for (let i = 0; i < node.childNodes.length; i++) {
                             walkDOM(node.childNodes[i]);
                         }
                     }
                 }
                 walkDOM(document.getElementById('main-content-area'));
             }
         
             // --- UTILITY: HEADING CLEANUP ---
             function removeHeadingNumbers() {
                 const headings = document.querySelectorAll('h2, h3, h4, h5, h6');
                 const numberPrefixRegex = /^\d+\.[\d\.]*\s*/;
                 headings.forEach(heading => {
                     const firstChild = heading.childNodes[0];
                     if (firstChild && firstChild.nodeType === 3) {
                         firstChild.nodeValue = firstChild.nodeValue.replace(numberPrefixRegex, '').trim();
                     }
                 });
             }
         
             // --- CORE SETUP: TABS ---
             function setupTabs() {
                 const mainContent = document.getElementById('main-content-area');
                 const tabPlaceholder = document.getElementById('tab-container-placeholder');
                 const sections = Array.from(mainContent.querySelectorAll('.product-section'));
                 
                 if (sections.length > 0) {
                     const tabContainer = document.createElement('div');
                     tabContainer.className = 'tab-navigation-container';
                     const tabNavScroller = document.createElement('div');
                     tabNavScroller.className = 'tab-nav-scroller';
                     const tabNav = document.createElement('nav');
                     tabNav.className = 'tab-navigation';
                     const tabContent = document.createElement('div');
                     tabContent.className = 'tab-content';
         
                     let tabCounter = 0; // Separate counter for actual tabs created
         
                     sections.forEach((section, index) => {
                         const headingElement = section.querySelector('h2');
                         if (!headingElement) return;
                         
                         tabCounter++; // Increment only when a tab is actually created
                         const tabPaneId = `pane-${tabCounter}`;
                         const tabButton = document.createElement('button');
                         tabButton.className = 'tab-link';
                         const tabText = document.createElement('span');
                         tabText.textContent = headingElement.textContent.trim();
                         tabButton.appendChild(tabText);
                         tabButton.setAttribute('data-tab', tabPaneId);
                         tabNav.appendChild(tabButton);
                         
                         const tabPane = document.createElement('div');
                         tabPane.id = tabPaneId;
                         tabPane.className = 'tab-pane';
                         tabPane.appendChild(section);
                         tabContent.appendChild(tabPane);
         
                         if (tabCounter === 1) { // First actual tab created
                             tabButton.classList.add('active');
                             tabPane.classList.add('active');
                         }
                     });
         
                     tabNavScroller.appendChild(tabNav);
                     tabContainer.appendChild(tabNavScroller);
                     tabPlaceholder.appendChild(tabContainer);
                     mainContent.appendChild(tabContent);
         
                     tabNav.addEventListener('click', (e) => {
                         const clickedTab = e.target.closest('.tab-link');
                         if (!clickedTab) return;
                         tabNav.querySelectorAll('.tab-link').forEach(tab => tab.classList.remove('active'));
                         tabContent.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                         clickedTab.classList.add('active');
                         document.getElementById(clickedTab.dataset.tab)?.classList.add('active');
                     });
         
                     // After tabs are in the DOM, calculate read times
                     calculateAndDisplayReadTime();
                 }
             }
         
             function detectDiagramType(code) {
                 const trimmedCode = code.trim().toLowerCase();
                 
                 if (trimmedCode.startsWith('graph') || trimmedCode.startsWith('flowchart')) return 'flowchart';
                 if (trimmedCode.startsWith('sequencediagram')) return 'sequence';
                 if (trimmedCode.startsWith('classdiagram')) return 'class';
                 if (trimmedCode.startsWith('statediagram')) return 'state';
                 if (trimmedCode.startsWith('erdiagram')) return 'er';
                 if (trimmedCode.startsWith('gantt')) return 'gantt';
                 if (trimmedCode.startsWith('journey')) return 'user-journey';
                 if (trimmedCode.startsWith('gitgraph')) return 'git';
                 if (trimmedCode.startsWith('pie')) return 'pie';
                 if (trimmedCode.startsWith('mindmap')) return 'mindmap';
                 if (trimmedCode.startsWith('timeline')) return 'timeline';
                 if (trimmedCode.startsWith('zenuml')) return 'zenuml';
                 if (trimmedCode.startsWith('quadrantchart')) return 'quadrant';
                 if (trimmedCode.startsWith('xychart')) return 'xy-chart';
                 if (trimmedCode.startsWith('block')) return 'block';
                 if (trimmedCode.startsWith('packet')) return 'packet';
                 if (trimmedCode.startsWith('treemap')) return 'treemap';
                 
                 return 'unknown';
             }
             
             function validateAndFixMermaidSyntax(code) {
                 let fixedCode = code.trim();
                 
                 // First, decode HTML entities that might cause parsing issues
                 fixedCode = fixedCode
                     .replace(/&amp;/g, '&')
                     .replace(/&lt;br&gt;/g, '<br>') // Handle HTML line breaks first
                     .replace(/&lt;/g, '<')
                     .replace(/&gt;/g, '>')
                     .replace(/&#39;/g, "'")
                     .replace(/&quot;/g, '"')
                     .replace(/&nbsp;/g, ' ')
                     .replace(/&apos;/g, "'");
                 
                 // Detect diagram type
                 const diagramType = detectDiagramType(fixedCode);
                 
                 // Handle unknown diagram types by converting to flowchart if possible
                 if (diagramType === 'unknown') {
                     console.warn('Unknown diagram type, attempting to render as-is');
                 }
                 
                 // Fix common syntax issues based on diagram type
                 switch (diagramType) {
                     case 'flowchart':
                         // Ensure flowchart has proper direction
                         if (!fixedCode.match(/(TD|TB|BT|RL|LR)/)) {
                             fixedCode = fixedCode.replace(/^(flowchart|graph)/, '$1 TD');
                         }
                         
                         // Fix specific pattern: node labels with <br> and file paths
                         // This pattern is causing the parser error: [Label<br>/path/file.xhtml]
                         fixedCode = fixedCode.replace(/\[([^\[\]]*)<br>([^\[\]]*)\]/g, (match, label, path) => {
                             // Clean the label and path, replace problematic characters
                             const cleanLabel = label.trim();
                             const cleanPath = path.trim()
                                 .replace(/\//g, '') // Replace forward slashes with math division symbol
                                 .replace(/\./g, ''); // Replace dots with middle dot
                             return `["${cleanLabel}\\n${cleanPath}"]`; // Use quoted strings for safety
                         });
                         
                         // Handle similar pattern in parentheses
                         fixedCode = fixedCode.replace(/\(([^\(\)]*)<br>([^\(\)]*)\)/g, (match, label, path) => {
                             const cleanLabel = label.trim();
                             const cleanPath = path.trim()
                                 .replace(/\//g, '')
                                 .replace(/\./g, '');
                             return `("${cleanLabel}\\n${cleanPath}")`;
                         });
                         
                         // Fix node labels with parentheses that can cause parsing issues
                         // Pattern: A[Label (with parentheses)] --> B
                         fixedCode = fixedCode.replace(/(\w+)\[([^\[\]]*\([^\[\]]*\)[^\[\]]*)\]/g, (match, nodeId, label) => {
                             // Wrap labels containing parentheses in quotes
                             const cleanLabel = label.replace(/"/g, '\\"'); // Escape existing quotes
                             return `${nodeId}["${cleanLabel}"]`;
                         });
                         
                         // Fix incomplete arrow syntax - ensure arrows have proper targets
                         // Pattern: A[Label] - (incomplete arrow at end of line)
                         fixedCode = fixedCode.replace(/(\w+\[[^\]]+\]|\w+\([^)]+\)|\w+)\s+--?\s*$/gm, (match, source) => {
                             // If we find an incomplete arrow at end of line, remove it entirely
                             console.warn('Removing incomplete arrow syntax:', match.trim());
                             return source.trim();
                         });
                         
                         // Fix common arrow syntax issues
                         fixedCode = fixedCode
                             .replace(/--&gt;/g, '-->')  // Fix any remaining HTML entities in arrows
                             .replace(/-->/g, ' --> ') // Ensure proper spacing around arrows
                             .replace(/\s+-->\s+/g, ' --> ') // Clean up multiple spaces
                             .replace(/\[\s+/g, '[') // Remove extra spaces after opening brackets
                             .replace(/\s+\]/g, ']') // Remove extra spaces before closing brackets
                             .replace(/\(\s+/g, '(') // Remove extra spaces after opening parentheses
                             .replace(/\s+\)/g, ')') // Remove extra spaces before closing parentheses
                             .replace(/\{\s+/g, '{') // Remove extra spaces after opening braces
                             .replace(/\s+\}/g, '}'); // Remove extra spaces before closing braces
                         
                         // Handle any remaining line breaks in node labels
                         fixedCode = fixedCode.replace(/<br>/gi, '\\n'); // Convert HTML breaks to Mermaid line breaks
                         
                         break;
                         
                     case 'mindmap':
                         // Ensure mindmap has proper structure
                         if (!fixedCode.includes('root(')) {
                             // If incomplete mindmap, add basic structure
                             const lines = fixedCode.split('\n');
                             if (lines.length > 1 && lines[0].trim() === 'mindmap') {
                                 // Wrap content in root node
                                 const content = lines.slice(1).join('\n').trim();
                                 if (content) {
                                     fixedCode = `mindmap\n  root((${content.split('\n')[0] || 'Root'}))\n${content}`;
                                 }
                             }
                         }
                         // Remove or fix invalid icon syntax for older versions
                         fixedCode = fixedCode.replace(/::icon\([^)]+\)/g, '');
                         break;
                         
                     case 'user-journey':
                         // Ensure journey diagram has proper structure
                         if (!fixedCode.includes('title')) {
                             const lines = fixedCode.split('\n');
                             if (lines.length > 1 && lines[0].trim() === 'journey') {
                                 lines.splice(1, 0, '    title User Journey');
                                 fixedCode = lines.join('\n');
                             }
                         }
                         break;
                         
                     case 'timeline':
                         // Timeline diagrams should have proper structure
                         if (!fixedCode.includes('title')) {
                             const lines = fixedCode.split('\n');
                             if (lines.length > 1 && lines[0].trim() === 'timeline') {
                                 lines.splice(1, 0, '  title Timeline');
                                 fixedCode = lines.join('\n');
                             }
                         }
                         break;
                 }
                 
                 // Final cleanup - remove any remaining problematic characters
                 fixedCode = fixedCode
                     .replace(/\r\n/g, '\n') // Normalize line endings
                     .replace(/\r/g, '\n')   // Convert old Mac line endings
                     .split('\n')
                     .map(line => line.trimRight()) // Remove trailing whitespace from each line
                     .join('\n')
                     .replace(/\n\s*\n\s*\n/g, '\n\n'); // Remove excessive blank lines
                 
                 return fixedCode;
             }
             
             // Function to re-render diagrams when theme changes
             function updateMermaidTheme() {
                 const isDarkMode = document.documentElement.classList.contains('dark-mode') || 
                                   document.documentElement.getAttribute('data-theme') === 'dark' ||
                                   window.matchMedia('(prefers-color-scheme: dark)').matches;
                 
                 try {
                     console.log(`Updating Mermaid theme to ${isDarkMode ? 'dark' : 'light'} mode`);
                     
                     // Step 1: Clear all existing rendered containers and reset processed state
                     const containers = document.querySelectorAll('.mermaid-container');
                     const preBlocks = document.querySelectorAll('pre.mermaid');
                     
                     containers.forEach(container => {
                         container.remove();
                     });
                     
                     preBlocks.forEach(preBlock => {
                         preBlock.classList.remove('mermaid-processed');
                         preBlock.style.display = 'block'; // Show original blocks temporarily
                     });
                     
                     // Step 2: Re-initialize Mermaid with new theme configuration
                     initializeMermaidRendering(); // Use the same initialization function as initial load
                     
                     // Step 3: Re-render all diagrams using the complete rendering process
                     setTimeout(() => {
                         renderMermaidDiagrams(); // Use the same rendering function as initial load
                         console.log(`Mermaid theme successfully updated to ${isDarkMode ? 'dark' : 'light'} mode`);
                     }, 100); // Small delay to ensure initialization is complete
                     
                 } catch (error) {
                     console.error('Error updating Mermaid theme:', error);
                 }
             }
         
             // --- RUN EVERYTHING ---
             // Add a small delay to ensure DOM is fully loaded
             setTimeout(() => {
                 init();
             }, 10);
         
         });
      </script>

   </body>
</html>
